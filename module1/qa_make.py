import os
import json
import base64
import time
import threading
import re
import random
import concurrent.futures
import argparse
import signal
import sys
from openai import OpenAI
try:
    from tqdm import tqdm
    TQDM_AVAILABLE = True
except ImportError:
    TQDM_AVAILABLE = False
    print("âš ï¸ æç¤º: å®‰è£… tqdm å¯ä»¥è·å¾—æ›´å¥½çš„è¿›åº¦æ˜¾ç¤º: pip install tqdm")

# ==============================================================================
# ğŸŒ å…¨å±€é…ç½®å®¹å™¨
# ==============================================================================
GLOBAL_CONFIG = {
    "api_base": "",
    "api_key": "",
    "model_name": "",
    "temperature": 0.7,
    "max_tokens": 8192,
    "batch_size": 10,
    "max_workers": 4,
    "questions_per_image": 1,
    "enable_thinking": False,  # æ˜¯å¦å¯ç”¨æ€è€ƒæ¨¡å¼ï¼ˆå¯ç”¨åä¼šæå– reasoning_contentï¼‰
    "rounds": 3,               # å¤šè½®å¯¹è¯çš„è½®æ•°ï¼ˆä»…ç”¨äºå¤šè½®å¯¹è¯é¢˜å‹ï¼‰
    "request_timeout": 1000.0,   # å•æ¬¡è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    "max_retries": 3,          # è¯·æ±‚æœ€å¤§é‡è¯•æ¬¡æ•°
    "retry_sleep": 1.0,        # å¤±è´¥åçš„åŸºç¡€é‡è¯•é—´éš”ï¼ˆç§’ï¼‰
    "log_mode": "simple",      # æ—¥å¿—æ¨¡å¼: "simple"(ç®€åŒ–) æˆ– "detailed"(è¯¦ç»†)
    "include_process": False    # æ˜¯å¦ç”Ÿæˆ qa_make_process å­—æ®µï¼ˆæ¨ç†è¿‡ç¨‹ï¼‰
}

# ==============================================================================
# âš™ï¸ å…¨å±€å˜é‡ä¸é”
# ==============================================================================
client = None
file_lock = threading.Lock()
buffer_lock = threading.Lock()
result_buffer = [] 
stats = {
    "success": 0,           # æˆåŠŸç”Ÿæˆé—®é¢˜çš„æ•°é‡
    "failed": 0,            # å¤±è´¥çš„å›¾ç‰‡æ•°é‡
    "images_processed": 0,  # å·²å¤„ç†çš„å›¾ç‰‡æ•°é‡
    "questions_generated": 0,  # å·²ç”Ÿæˆçš„é—®é¢˜æ•°é‡
    "images_success": 0,    # æˆåŠŸå¤„ç†çš„å›¾ç‰‡æ•°é‡ï¼ˆè‡³å°‘ç”Ÿæˆ1ä¸ªé—®é¢˜ï¼‰
    "images_failed": 0      # å®Œå…¨å¤±è´¥çš„å›¾ç‰‡æ•°é‡ï¼ˆ0ä¸ªé—®é¢˜ï¼‰
}
OUTPUT_PATH = "" 
OUTPUT_FORMAT = "jsonl"  # è¾“å‡ºæ ¼å¼ï¼šjson æˆ– jsonlï¼ˆæ ¹æ®æ–‡ä»¶æ‰©å±•åè‡ªåŠ¨åˆ¤æ–­ï¼‰
CURRENT_IMAGE_TYPE = ""
CURRENT_QUESTION_TYPE = ""
FIRST_ITEM_PROCESSED = False  # ç”¨äºæ ‡è®°æ˜¯å¦å·²å¤„ç†ç¬¬ä¸€é“é¢˜ï¼ˆç”¨äºè°ƒè¯•è¾“å‡ºï¼‰
progress_bar = None  # è¿›åº¦æ¡å¯¹è±¡
progress_lock = threading.Lock()  # è¿›åº¦æ¡æ›´æ–°é”
LOG_FILE = None  # æ—¥å¿—æ–‡ä»¶å¯¹è±¡
log_lock = threading.Lock()  # æ—¥å¿—å†™å…¥é”
shutdown_event = threading.Event()  # ç”¨äºæ ‡è®°æ˜¯å¦éœ€è¦ä¼˜é›…å…³é—­

# ==============================================================================
# ğŸ“ é—®é¢˜ç±»å‹å®šä¹‰
# ==============================================================================
# ğŸ”§ æ‰©å±•è¯´æ˜ï¼šè¦æ·»åŠ æ–°é—®é¢˜ç±»å‹ï¼Œåªéœ€åœ¨è¿™é‡Œæ·»åŠ æ˜ å°„å…³ç³»
QUESTION_TYPES = {
    "single_choice": "å››é€‰å•é€‰",      # å•é€‰é¢˜
    "multiple_choice": "å››é€‰å¤šé€‰",    # å¤šé€‰é¢˜
    "true_false": "åˆ¤æ–­é¢˜",           # åˆ¤æ–­é¢˜
    "essay": "é—®ç­”é¢˜",                # é—®ç­”é¢˜
    "multi_round_single_choice": "å¤šè½®å•é€‰é¢˜",  # å¤šè½®å•é€‰é¢˜
    "multi_round_essay": "å¤šè½®é—®ç­”é¢˜"  # å¤šè½®é—®ç­”é¢˜
    # æ·»åŠ æ–°é—®é¢˜ç±»å‹ç¤ºä¾‹ï¼š
    # "fill_blank": "å¡«ç©ºé¢˜",
    # "matching": "åŒ¹é…é¢˜",
}

# ==============================================================================
# ğŸ“ å›¾ç‰‡ç±»å‹å®šä¹‰
# ==============================================================================
# ğŸ”§ æ‰©å±•è¯´æ˜ï¼šè¦æ·»åŠ æ–°å›¾ç‰‡ç±»å‹ï¼Œåªéœ€åœ¨è¿™é‡Œæ·»åŠ 
IMAGE_TYPES = ["pure_image", "pure_text", "mixed", "splice", "all"]
# "all" è¡¨ç¤ºå¤„ç†æ‰€æœ‰ç±»å‹çš„å›¾ç‰‡ï¼Œä¸è¿›è¡Œç­›é€‰
# æ·»åŠ æ–°å›¾ç‰‡ç±»å‹ç¤ºä¾‹ï¼š
# IMAGE_TYPES = ["pure_image", "pure_text", "mixed", "splice", "all", "video_frame", "3d_model"]

# ==============================================================================
# ğŸ“ æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿ (å¯æ‰©å±•è®¾è®¡)
# ==============================================================================

def get_image_type_prompt(image_type: str, question_type_name_cn: str, rounds: int = 1, include_process: bool = True) -> str:
    """
    è·å–ç‰¹å®šå›¾ç‰‡ç±»å‹çš„å®Œæ•´å‡ºé¢˜æç¤ºè¯
    ğŸ”§ æ‰©å±•è¯´æ˜ï¼šæ·»åŠ æ–°å›¾ç‰‡ç±»å‹æ—¶ï¼Œåªéœ€åœ¨è¿™é‡Œæ·»åŠ å¯¹åº”çš„å®Œæ•´å‡ºé¢˜é€»è¾‘
    æ³¨æ„ï¼šæ¯ç§å›¾ç‰‡ç±»å‹éƒ½æœ‰ç‹¬ç«‹çš„å‡ºé¢˜é€»è¾‘ï¼Œä¸å…±äº«é€šç”¨éƒ¨åˆ†
    rounds: å¤šè½®å¯¹è¯çš„è½®æ•°ï¼ˆä»…ç”¨äºå¤šè½®å¯¹è¯é¢˜å‹ï¼‰
    """
    # åˆ¤æ–­æ˜¯å¦ä¸ºå¤šè½®å¯¹è¯é¢˜å‹
    is_multi_round = "å¤šè½®" in question_type_name_cn
    rounds_text = f"{rounds}è½®" if is_multi_round else ""
    
    prompts = {
        "pure_image": f"""
ä½ æ˜¯ä¸€åä¸“ä¸šçš„é‡‘èæ¨ç†é¢˜ç›®æ„å»ºä¸“å®¶ï¼Œæ“…é•¿æ ¹æ®å›¾åƒå†…å®¹ç”Ÿæˆé«˜è´¨é‡çš„å›°éš¾é‡‘èå¤šæ¨¡æ€ VQA é—®é¢˜ã€‚

ç»™ä½ çš„ä¸€å¼ å›¾åƒæ¥è‡ªè¯åˆ¸/ç ”ç©¶æœºæ„çš„æ­£å¼é‡‘èç ”æŠ¥ï¼Œå†…å®¹å¯èƒ½æ˜¯ï¼š
- **ç»Ÿè®¡å›¾è¡¨**ï¼šæŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€é¥¼å›¾ã€é›·è¾¾å›¾ã€æ•£ç‚¹å›¾ç­‰ï¼›
- **æŠ¥è¡¨/è¡¨æ ¼**ï¼šè´¢åŠ¡æŠ¥è¡¨ã€ç›ˆåˆ©é¢„æµ‹è¡¨ã€ä¼°å€¼è¡¨ã€è‚¡æƒç»“æ„è¡¨ã€æ•°æ®æ±‡æ€»è¡¨ç­‰ï¼›
- å¤šå¹…å­å›¾æˆ–å›¾è¡¨+è¡¨æ ¼çš„ç»„åˆã€‚

ä½ çš„ä»»åŠ¡ï¼š  
**åœ¨å®Œå…¨ä¾èµ–è¯¥å›¾åƒå†…å®¹çš„å‰æä¸‹ï¼Œç”Ÿæˆä¸€é“é¢˜ç›® + æ ‡å‡†ç­”æ¡ˆ + è¯¦ç»†æ¨ç†è¿‡ç¨‹ï¼Œç”¨äºè¯„ä¼°å¤§æ¨¡å‹åœ¨é‡‘èç ”æŠ¥å›¾åƒâ€œç²¾å‡†å®šä½ + ç†è§£ + æ¨ç†â€æ–¹é¢çš„èƒ½åŠ›ã€‚**
é¢˜å‹ä¸ºã€{question_type_name_cn}ã€‘ã€‚

1. **é¢˜ç›®éš¾åº¦éœ€è¾¾åˆ°èµ„æ·±é‡‘èåˆ†æå¸ˆ/ç ”ç©¶å‘˜æ°´å¹³**
   å¿…é¡»æ˜¯å¤šæ­¥é“¾å¼æ¨ç†é¢˜ï¼š
   è‡³å°‘åŒæ—¶ä½¿ç”¨3 ä¸ªåŠä»¥ä¸Šä¸åŒçš„æ•°æ®ç‚¹/æŒ‡æ ‡/ç»´åº¦ï¼ˆä¾‹å¦‚ï¼šä¸¤ä¸ªå¹´ä»½ + ä¸¤ä¸ªæŒ‡æ ‡ + ä¸€ä¸ªæ¯”ä¾‹ï¼‰ï¼›
   å¿…é¡»æ¶‰åŠè‡³å°‘ 2 ç±»ä¿¡æ¯æ¥æºï¼šä¾‹å¦‚â€œä¸»å›¾æ•°å€¼ + å›¾ä¾‹/é¢œè‰² + æ–‡å­—æ³¨é‡Š/è„šæ³¨â€æˆ–â€œæŠ˜çº¿å›¾ + è¡¨æ ¼â€ç­‰ï¼›
   æ¨ç†è¿‡ç¨‹ä¸­è‡³å°‘åŒ…å«2 ç§ä¸åŒç±»å‹çš„è¿ç®—æˆ–é€»è¾‘ï¼Œä¾‹å¦‚ï¼šâ€œåŒæ¯”/ç¯æ¯” + æ¯”ç‡æ¯”è¾ƒâ€ã€â€œåŠ æƒå¹³å‡ + å¢é•¿ç‡â€ã€â€œè§£æ–¹ç¨‹ + æ’åºâ€ç­‰ã€‚
   è‹¥å›¾åƒä¸­å­˜åœ¨å¤šä¸ªå­å›¾æˆ–è¡¨æ ¼ï¼Œä¼˜å…ˆä¸”å°½é‡å¼ºåˆ¶è¦æ±‚é¢˜ç›®éœ€è¦åŒæ—¶ä½¿ç”¨è‡³å°‘ä¸¤ä¸ªå­å›¾/è¡¨æ ¼çš„ä¿¡æ¯ï¼›åªæœ‰åœ¨å›¾åƒæ˜æ˜¾ä¸ºå•ä¸€å›¾è¡¨æ—¶ï¼Œæ‰å…è®¸ä»…åŸºäºå•ä¸€å›¾è¡¨ï¼Œä½†ä»éœ€ç”¨åˆ°è¯¥å›¾è¡¨ä¸­è‡³å°‘ 3 ä¸ªå­—æ®µ/è¡Œ/åˆ—/ç³»åˆ—ã€‚

2. ä½ å¯ä»¥è®¾è®¡çš„é—®é¢˜ç±»å‹åŒ…æ‹¬ä½†ä¸é™äºï¼š
   - è´¢åŠ¡æŒ‡æ ‡æ¨ç†ï¼ˆéœ€é€šè¿‡è®¡ç®—æˆ–å¤šæŒ‡æ ‡é€»è¾‘ç»„åˆæ‰èƒ½å¾—åˆ°ç»“è®ºï¼Œè€Œä¸æ˜¯ç›´æ¥è¯»æ•°ï¼‰
   - å›¾è¡¨è¶‹åŠ¿åˆ†æä¸æ¨æ–­ï¼ˆå¿…é¡»é€šè¿‡äºŒé˜¶å˜åŒ–ã€é€Ÿåº¦å˜åŒ–ã€åŒºé—´æ¯”è¾ƒç­‰é—´æ¥æ–¹æ³•å¾—å‡ºå”¯ä¸€ç­”æ¡ˆï¼‰
   - ç»“æ„åŒ–å›¾å½¢æ¨ç†ï¼ˆè‚¡æƒç»“æ„ã€èµ„äº§ç»“æ„ã€ä¸šåŠ¡æ„æˆï¼Œéœ€è¦å¤šå±‚ç©¿é€æˆ–å æ¯”è®¡ç®—ï¼‰
   - å¤šå®ä½“å…³ç³»æ¨æ–­ï¼ˆè‡³å°‘ 3 ä¸ªä»¥ä¸Šå®ä½“çš„æ¯”è¾ƒ / æ’åº / è´¡çŒ®åˆ†è§£ï¼‰
   - è·¨æŒ‡æ ‡é“¾å¼æ¨ç†ï¼ˆA æŒ‡æ ‡å˜åŒ– â†’ å½±å“ B æŒ‡æ ‡ â†’ å†ä¸ C æŒ‡æ ‡æ¯”è¾ƒåå¾—å‡ºç»“è®ºï¼‰
   - è·¨å­å›¾ç»¼åˆåˆ†æï¼ˆè‡³å°‘ 2 ä¸ªå­å›¾ä¹‹é—´å»ºç«‹å¯¹åº”å…³ç³»ï¼Œå¦‚æ—¶é—´ã€è¡Œä¸šã€åœ°åŒºç­‰ç»´åº¦ï¼‰
   - ç¦æ­¢è®¾è®¡ï¼šä¾èµ–å•ä¸€æ˜¾çœ¼ç‰¹å¾å³å¯ä½œç­”çš„é—®é¢˜ï¼ˆå¦‚â€œå“ªæ¡çº¿æœ€é«˜â€â€œå“ªæ ¹æŸ±å­æœ€é•¿â€ï¼‰ï¼›åªç”¨åˆ°ä¸€ä¸ªæ•°å­—æˆ–ä¸€ä¸ªç±»åˆ«çš„ä¿¡æ¯çš„é—®é¢˜ã€‚
   

3. **å›¾å½¢ç±»å‹çš„å¼ºåˆ¶è¦æ±‚**
    å›¾ä¸­è‹¥å‡ºç°ä»¥ä¸‹å›¾å½¢åˆ™éœ€éµå®ˆå¯¹åº”åŸåˆ™ï¼š
    A. æŠ˜çº¿å›¾
    è‹¥å›¾ä¸­æœ‰æŠ˜çº¿å›¾ï¼Œä¸”ä½ é€‰æ‹©åŸºäºæŠ˜çº¿å›¾å‡ºé¢˜ï¼Œåˆ™é¢˜ç›®å¿…é¡»è‡³å°‘åŒ…å«ä¸‹åˆ—æ“ä½œä¸­çš„ä¸¤é¡¹ï¼š
    å¯¹æŸä¸€æŒ‡æ ‡åœ¨å¤šä¸ªè¿ç»­æœŸçš„å˜åŠ¨åšä¸€é˜¶æˆ–äºŒé˜¶å·®åˆ†ï¼Œç”¨äºè¯†åˆ«åŠ é€Ÿ/å‡é€Ÿæˆ–æ‹ç‚¹ï¼›
    åœ¨åŒä¸€æ—¶é—´åŒºé—´å†…ï¼Œæ¯”è¾ƒä¸¤ä¸ªåŠä»¥ä¸ŠæŠ˜çº¿ç³»åˆ—çš„å¢é•¿ç‡/ç›¸å¯¹å˜åŒ–ï¼›
    åŸºäºå›¾ä¸­ç»™å‡ºçš„ç™¾åˆ†æ¯”/æ°´å¹³å€¼ï¼Œè®¡ç®—åŒºé—´æ”¶ç›Šç‡ã€é“¾å¼å¢é•¿ç‡æˆ–å¹³å‡å¢é•¿ç‡ï¼›
    ä½¿ç”¨æŠ˜çº¿å›¾ä¸­çš„äº‹ä»¶æ ‡æ³¨/é˜´å½±åŒºé—´ä½œä¸ºçº¦æŸï¼Œå¯¹è¯¥åŒºé—´å†…çš„æŒ‡æ ‡å˜åŒ–åšå•ç‹¬åˆ†æã€‚
    B. æŸ±çŠ¶å›¾æˆ–å †å æŸ±çŠ¶å›¾
    è‹¥å›¾ä¸­æœ‰æŸ±çŠ¶å›¾ï¼Œä¸”ä½ é€‰æ‹©åŸºäºæŸ±çŠ¶å›¾å‡ºé¢˜ï¼Œåˆ™é¢˜ç›®å¿…é¡»è‡³å°‘æ¶‰åŠï¼š
    ç»“æ„å æ¯”å˜åŒ– + ç»å¯¹å€¼å˜åŒ–çš„è”åˆæ¨ç†ï¼ˆä¾‹å¦‚ï¼šè°å¯¹æ€»é¢å¢é•¿è´¡çŒ®æœ€å¤§ = æƒé‡ Ã— å¢é•¿ï¼‰ï¼›
    è‡³å°‘è·¨ä¸¤ä¸ªæ—¶é—´ç‚¹æˆ–ä¸¤ä¸ªåœ°åŒºè¿›è¡Œå½’ä¸€åŒ–æˆ–æ ‡å‡†åŒ–æ¯”è¾ƒï¼Œè€Œä¸æ˜¯ç›´æ¥çœ‹é«˜åº¦ï¼›
    åœ¨ç™¾åˆ†æ¯”ä¸ç»å¯¹å€¼ä¹‹é—´è¿›è¡Œå•ä½è½¬æ¢æˆ–åæ¨ï¼ˆå‰ææ˜¯å›¾ä¸­ä¿¡æ¯è¶³å¤Ÿï¼‰ã€‚
    C. è¡¨æ ¼
    è‹¥å›¾ä¸­æœ‰è¡¨æ ¼ï¼Œå¹¶è¢«ç”¨ä½œå‡ºé¢˜ä¾æ®ï¼Œåˆ™å¿…é¡»ï¼š
    è‡³å°‘ä½¿ç”¨3 åˆ—æˆ– 3 è¡Œä¿¡æ¯ï¼Œè€Œä¸æ˜¯è¡Œå†…/åˆ—å†…å•ç‚¹è¯»æ•°ï¼›
    æ„é€ æ˜¾å¼æˆ–éšå«çš„æ–¹ç¨‹å…³ç³»ï¼ˆå¦‚â€œåˆ©ç”¨ç‡ = æ•°é‡/æ€»é‡â€åæ¨å‡ºæŸä¸ªç»å¯¹å€¼ï¼‰ï¼›
    è¿›è¡Œå¤šæŒ‡æ ‡åŠ æƒåˆæˆ/æ¯”è¾ƒï¼Œä¸å¾—åªåšç®€å•åŠ å‡æ³•ï¼›
    å°½å¯èƒ½ç»“åˆè¡¨æ ¼ + å›¾è¡¨è¿›è¡Œâ€œäº¤å‰éªŒè¯â€å¼æ¨ç†ã€‚

4. **å¤šå­å›¾å…³è”**

   è‹¥å›¾ç‰‡ä¸­å­˜åœ¨å¤šä¸ªå­å›¾æˆ–â€œå›¾è¡¨ + è¡¨æ ¼â€çš„ç»„åˆï¼Œåˆ™ä½ åº”å°½é‡éµå¾ªï¼š
   é¢˜ç›®å¿…é¡»åŒæ—¶åˆ©ç”¨è‡³å°‘ä¸¤ä¸ªå­å›¾/è¡¨æ ¼çš„ä¿¡æ¯ï¼›
   æ¨ç†é“¾ä¸­è¦å…ˆåœ¨å­å›¾ A ä¸­ç¡®å®šæŸä¸ªæ—¶é—´æ®µ/è¡Œä¸š/å…¬å¸/åˆ†é¡¹ï¼Œå†åˆ°å­å›¾ B ä¸­æ‰¾åˆ°å¯¹åº”éƒ¨åˆ†ï¼Œç”¨äºè¿›ä¸€æ­¥æ¨ç†ï¼›
   æœ€ç»ˆç­”æ¡ˆå¿…é¡»ä¾èµ–è¿™ç§è·¨å­å›¾çš„å¯¹åº”å…³ç³»ï¼Œä¸èƒ½åªåœ¨ä¸€ä¸ªå­å›¾å†…å°±èƒ½è§£å‡ºã€‚
   è‹¥å›¾åƒç¡®å®åªæœ‰ä¸€ä¸ªå­å›¾æˆ–å•è¡¨æ ¼ï¼Œä½ éœ€è¦åœ¨æ¨ç†ä¸­å¼ºåˆ¶ä½¿ç”¨è¯¥å›¾å†…éƒ¨çš„å¤šä¸ªç»´åº¦ï¼ˆå¦‚æ—¶é—´ + åœ°åŒº + æŒ‡æ ‡/é¡¹ç›®ï¼‰ä»¥ä¿è¯å¤æ‚åº¦ã€‚
    
5. **æ‰€æœ‰é—®é¢˜å¿…é¡»æ»¡è¶³**ï¼š
   - ç­”æ¡ˆå”¯ä¸€ã€å®¢è§‚ã€å¯éªŒè¯ï¼ˆä¸èƒ½æœ‰æ­§ä¹‰æˆ–å¤šç§è§£é‡Šï¼‰
   - å¿…é¡»ä¸¥æ ¼ä¾èµ–å›¾åƒä¸­çš„ä¿¡æ¯ï¼ˆä¸èƒ½ä¾èµ–å›¾å¤–çŸ¥è¯†æˆ–å‡è®¾ï¼‰
   - é¢˜å¹²ä¸å¾—ç›´æ¥ç»™å‡ºå›¾ç‰‡å†…å·²æœ‰çš„ç»“æ„åŒ–æ•°æ®æˆ–ç»“è®º
   - ä¸å…è®¸ä¸»è§‚ç±»é—®é¢˜ï¼ˆå¦‚"ä½ æ€ä¹ˆçœ‹""æ˜¯å¦åˆç†"ï¼‰
   - ä¸å…è®¸å¼€æ”¾å¼å›ç­”ï¼ˆå¦‚"åˆ—å‡ºå¯èƒ½çš„åŸå› ""å¯èƒ½æœ‰å“ªäº›å½±å“"ï¼‰ 

6. **é—®é¢˜å¿…é¡»å±äºé‡‘èé¢†åŸŸçš„å®é™…å­ä»»åŠ¡ä¹‹ä¸€**ï¼Œå¦‚ï¼š
   - å…¬å¸é‡‘èï¼šè´¢åŠ¡æŠ¥è¡¨åˆ†æã€åˆ©æ¶¦ç»“æ„ã€èµ„äº§è´Ÿå€ºè¡¨é¡¹ç›®æ¨ç®—ï¼›
   - è¡Œä¸šåˆ†æï¼šè¡Œä¸šæˆ–æ¿å—æŒ‡æ ‡æ¯”è¾ƒã€å¸‚åœºä»½é¢å˜åŒ–ã€ç«äº‰æ ¼å±€ï¼›
   - è‚¡ç¥¨ä¼°å€¼ï¼šä¼°å€¼æŒ‡æ ‡è®¡ç®—ã€è´¢åŠ¡æ¯”ç‡æ¨å¯¼ï¼›
   - é£é™©ç®¡ç†ï¼šæ³¢åŠ¨ç‡ã€é£é™©æš´éœ²ã€é£é™©æ”¶ç›Šæ¯”ç­‰æ¯”è¾ƒï¼›
   - èµ„äº§ç®¡ç†ï¼šèµ„äº§é…ç½®ã€æŠ•èµ„ç»„åˆè¡¨ç°åˆ†æï¼›
   - å¸‚åœºåˆ†æï¼šå®è§‚ç»æµå›¾è¡¨ï¼ˆé€šèƒ€ã€å·¥ä¸šã€åœ°äº§ã€å•†å“ã€åˆ©ç‡ç­‰ï¼‰ã€å¸‚åœºæˆäº¤é‡ä¸ä»·æ ¼è”åŠ¨ï¼›
   - è´¢åŠ¡æŒ‡æ ‡è®¡ç®—ï¼šROEã€ROAã€æ¯›åˆ©ç‡ã€å‡€åˆ©ç‡ç­‰æŒ‡æ ‡æ¨ç®—ï¼›
   - è‚¡æƒç»“æ„åˆ†æï¼šæŒè‚¡æ¯”ä¾‹ã€æ§åˆ¶æƒç©¿é€ã€å®é™…æ§åˆ¶äººè¯†åˆ«ã€‚

7. **éš¾åº¦è¦æ±‚ï¼šç»“åˆä½†ä¸é™äºä»¥ä¸‹è¦æ±‚**ï¼š
   - æ¶‰åŠè·¨å¹´åº¦ã€è·¨å­£åº¦ã€è·¨åŒºåŸŸçš„è¶‹åŠ¿æ¯”è¾ƒ
   - åŒæ—¶ä½¿ç”¨å›¾è¡¨æ•°å€¼ + å›¾ä¾‹è§£é‡Š + æ–‡å­—è¯´æ˜
   - å¤šæŒ‡æ ‡ä¹‹é—´çš„é“¾å¼æ¨ç†ï¼ˆAâ†’Bâ†’Cï¼Œéœ€è¦è‡³å°‘ 2-3 æ­¥æ¨ç†ï¼‰
   - ç»“æ„å æ¯”å˜åŒ–æ¨æ–­ï¼ˆå¦‚"å“ªéƒ¨åˆ†è´¡çŒ®æœ€å¤§""ç»“æ„å¦‚ä½•å˜åŒ–"ï¼‰
   - ä»åŒæ¯” + ç¯æ¯”çš„å åŠ ä¿¡æ¯å¾—å‡ºåˆ¤æ–­
   - ä½¿ç”¨å›¾ä¸­å¤šä¸ªå›¾å—ï¼ˆå¦‚ä¸»å›¾ + å­å›¾ + è¡¨æ ¼ï¼‰ç»¼åˆæ¨æ–­
   - è®¡ç®—é¢˜ä¸å¾—åªåŒ…æ‹¬åŠ å‡ä¹˜é™¤ï¼Œè¿˜éœ€åŒ…æ‹¬ä½†ä¸é™äºå¦‚ä¸‹å¤æ‚æ“ä½œï¼š
    æœ‰é™å·®åˆ†ã€äºŒé˜¶å·®åˆ†ï¼›
    å¯¹æ•°å˜æ¢ã€å¯¹æ•°å·®ï¼›
    CAGR/å¹´åŒ–å¢é•¿ï¼›
    è§£æå‹æ‹Ÿåˆï¼ˆçº¿æ€§/æŒ‡æ•°ï¼‰ï¼›
    è§£çº¿æ€§æ–¹ç¨‹ç»„ï¼›
    åŠ æƒè´¡çŒ®åˆ†è§£ï¼›
    æ ‡å‡†åŒ–å½’ä¸€åŒ–ã€‚

8. **å…³äºç­”æ¡ˆæ ¼å¼çš„è¦æ±‚ï¼ˆé‡è¦ï¼‰**ï¼š
   - è‹¥ç­”æ¡ˆä¸ºæ˜ç¡®çš„**æ•°å€¼å‹ç­”æ¡ˆ**ï¼ˆå¦‚ç™¾åˆ†æ¯”ã€é‡‘é¢ã€å¢é•¿ç‡ã€æ¯”ç‡ç­‰ï¼‰ï¼Œåˆ™ä¸ºè®¡ç®—é¢˜ï¼Œä¸éœ€è¦è®¾ç½®é€‰é¡¹
   - è‹¥ç­”æ¡ˆ**ä¸æ˜¯å•ä¸€æ•°å€¼**ï¼Œä½†ä¾ç„¶å®¢è§‚å”¯ä¸€ï¼ˆå¦‚"å¢é•¿æœ€å¿«çš„æ˜¯æŸè¡Œä¸š""å æ¯”æœ€é«˜çš„æ˜¯æŸåœ°åŒº"ï¼‰ï¼Œåˆ™å¿…é¡»è®¾è®¡ä¸ºé€‰æ‹©é¢˜ï¼Œéœ€æä¾›åˆç†çš„å¹²æ‰°é€‰é¡¹
   - ä¸¥ç¦å‡ºç°æ˜æ˜¾é”™è¯¯æˆ–ç¦»è°±é€‰é¡¹ï¼Œä¾‹å¦‚â€œå…¶ä»–â€â€œæ— æ³•åˆ¤æ–­â€â€œéšæ„çš„éé‡‘èåè¯â€ç­‰ã€‚
   - æ³¨æ„ï¼šé¢˜å‹ï¼ˆ{question_type_name_cn}ï¼‰å·²æŒ‡å®šï¼Œéœ€è¦ä¸¥æ ¼æŒ‰ç…§é¢˜å‹è¦æ±‚è®¾è®¡é¢˜ç›®

{"9. **æ€ç»´é“¾è¦æ±‚**ï¼š\n   å¿…é¡»åœ¨ qa_make_process å­—æ®µä¸­è¯¦ç»†è®°å½•è§£é¢˜çš„å®Œæ•´æ¨ç†é“¾æ¡ï¼ŒåŒ…æ‹¬ï¼š\n   - æŒ‡æ˜æœ¬æ­¥ä»å›¾åƒçš„å“ªä¸€éƒ¨åˆ†è¯»å–äº†å“ªäº›ä¿¡æ¯\n   - å†™å‡ºæœ¬æ­¥çš„å…·ä½“è¿ç®—å…¬å¼æˆ–é€»è¾‘åˆ¤æ–­\n   - ç»™å‡ºæ˜ç¡®çš„ä¸­é—´ç»“æœï¼Œå¹¶è¯´æ˜è¯¥ç»“æœå°†å¦‚ä½•åœ¨ä¸‹ä¸€æ­¥ä¸­ä½¿ç”¨\n   - æœ€ç»ˆå¦‚æœ€å 1â€“2 æ­¥ä¸­ï¼Œéœ€è¦è§£é‡Šå¦‚ä½•ç»¼åˆå‰é¢æ‰€æœ‰ä¸­é—´ç»“æœï¼Œå¾—å‡ºç­”æ¡ˆï¼Œå¹¶ä¸”è¯´æ˜ä¸ºä»€ä¹ˆå…¶ä»–å€™é€‰é€‰é¡¹/å¯èƒ½ç­”æ¡ˆä¸æˆç«‹\n\n" if include_process else ""}10. **ä¸¥ç¦çš„è¡Œä¸º**ï¼š
   - ä¸å¾—åœ¨é¢˜å¹²ä¸­ç›´æ¥æ³„éœ²å›¾ä¸­çš„å…³é”®æ•°æ®æˆ–ç»“è®º
   - ä¸å¾—è®¾è®¡ä¾èµ–å¤–éƒ¨çŸ¥è¯†æˆ–èƒŒæ™¯æ‰èƒ½å›ç­”çš„é—®é¢˜
   - ä¸å¾—è®¾è®¡ç­”æ¡ˆæ¨¡ç³Šæˆ–æœ‰å¤šç§å¯èƒ½è§£é‡Šçš„é—®é¢˜
   - ä¸å¾—è®¾è®¡ä¸»è§‚æ€§è¾ƒå¼ºçš„æ¨æ–­é¢„æµ‹é—®é¢˜ï¼Œç­”æ¡ˆå¿…é¡»è¦æœ‰æ˜ç¡®ä¾æ®,ä¾‹å¦‚æŠ˜çº¿å›¾ã€ç›´æ–¹å›¾ã€é›·è¾¾å›¾ä¸å¾—å‡ºä¼°ç®—æ•°å€¼ã€é¢„æµ‹è¶‹åŠ¿ç­‰é—®é¢˜ã€‚

{"11. åœ¨ `qa_make_process` å­—æ®µä¸­ï¼Œä½ å¿…é¡»ç»™å‡º**æ¸…æ™°ä¸”ç»†è‡´çš„æ¨ç†è¿‡ç¨‹**ï¼Œå¹¶æ˜¾å¼åˆ†è§£ä¸º**ä¸å°‘äº 5 æ­¥**ï¼ˆæ¨è 5â€“8 æ­¥ï¼‰ã€‚æ¯ä¸€æ­¥è¯´æ˜ï¼š\n\n   - å½“å‰æ”¾å¤§æˆ–æŸ¥çœ‹äº†å›¾åƒçš„å“ªä¸€éƒ¨åˆ†ï¼Œè¯»å–äº†å“ªäº›æ–‡å­—æ•°å­—æˆ–æ ‡ç­¾ï¼›\n   - è¿™ä¸€æ­¥åšäº†ä»€ä¹ˆå…·ä½“è¿ç®—æˆ–é€»è¾‘åˆ¤æ–­ï¼ˆå†™å‡ºå…¬å¼å’Œä½¿ç”¨çš„æ•°å­—ï¼Œè€Œä¸æ˜¯ä¸€å¥è¯å¸¦è¿‡ï¼‰ï¼›\n   - å¾—åˆ°äº†ä»€ä¹ˆä¸­é—´ç»“è®ºï¼Œå®ƒå¦‚ä½•ç”¨äºä¸‹ä¸€æ­¥ï¼›\n   - æœ€åä¸€ä¸¤æ­¥æ˜ç¡®è¯´æ˜å¦‚ä½•ç»¼åˆæ‰€æœ‰ä¸­é—´ç»“æœå¾—å‡ºå”¯ä¸€ç­”æ¡ˆã€‚\n\n" if include_process else ""}12. åœ¨è¾“å‡ºæœ€ç»ˆç»“æœå‰ï¼Œè¯·è¿›è¡Œè‡ªæ£€ï¼š
   - æ£€æŸ¥æ¨ç†é“¾ä¸­æ˜¯å¦å‡ºç°äº†**å›¾åƒä¸­æ²¡æœ‰å‡ºç°è¿‡çš„æ–°æ•°å­—**ï¼Œæˆ–â€œçº¦ã€å¤§çº¦ã€å¤§è‡´ã€æ¥è¿‘â€ç­‰ç”¨è¯­ï¼›  
   - æ£€æŸ¥æ˜¯å¦é€šè¿‡æŠ˜çº¿é«˜åº¦ã€æŸ±å­é•¿åº¦ã€æ‰‡åŒºé¢ç§¯ç­‰è¿›è¡Œæ•°å€¼ä¼°ç®—ï¼›  
   - æ£€æŸ¥é¢˜ç›®æ˜¯å¦å¯ä»¥é€šè¿‡ä»…ä»…çœ‹å½¢çŠ¶ã€æœ€é«˜æœ€ä½ç­‰ç²—ç•¥ç‰¹å¾åœ¨ 1â€“2 æ­¥å†…å¿«é€Ÿå›ç­”ï¼›
   - å¦‚æœä»»ä¸€é¡¹æˆç«‹ï¼Œè¿™é“é¢˜ä¸åˆæ³•ï¼Œä½ å¿…é¡»æ”¾å¼ƒè¯¥é¢˜ï¼Œæ”¹ä¸ºè¾“å‡º `qa_make_status = "NO_VALID_QUESTION"`ã€‚


{"**å¤šè½®å¯¹è¯è¦æ±‚**ï¼šéœ€è¦è®¾è®¡" + rounds_text + "è½®å¯¹è¯ï¼Œæ¯è½®éƒ½æœ‰ç‹¬ç«‹çš„é—®é¢˜å’Œç­”æ¡ˆï¼Œå½¢æˆå®Œæ•´çš„å¯¹è¯æµç¨‹ã€‚æ¯è½®é—®é¢˜éƒ½åº”éµå¾ªä¸Šè¿°æ‰€æœ‰è¦æ±‚ï¼Œä¸”å„è½®ä¹‹é—´åº”å½¢æˆé€»è¾‘é€’è¿›æˆ–å…³è”ï¼ˆå¦‚ï¼šç¬¬1è½®è¯»å–æ•°æ® â†’ ç¬¬2è½®è®¡ç®—æŒ‡æ ‡ â†’ ç¬¬3è½®ç»¼åˆåˆ¤æ–­ï¼‰ã€‚" if is_multi_round else ""}
""",
        "pure_text": f"""
ä½ æ˜¯ä¸€åä¸“ä¸šçš„é‡‘èæ–‡æœ¬æ¨ç†é¢˜ç›®æ„å»ºä¸“å®¶ï¼Œæ“…é•¿ä»é‡‘èç ”æŠ¥çš„çº¯æ–‡å­—å†…å®¹ä¸­ï¼Œè®¾è®¡éœ€è¦æ·±åº¦ç†è§£å’Œå¤šæ­¥æ¨ç†çš„é«˜è´¨é‡ VQA é—®é¢˜ã€‚

è¯·åŸºäºæä¾›çš„é‡‘èç ”æŠ¥æ–‡å­—å›¾åƒï¼ˆçº¯æ–‡æœ¬å†…å®¹ï¼Œæ²¡æœ‰å›¾è¡¨æˆ–è§†è§‰å…ƒç´ ï¼‰ï¼Œç”Ÿæˆä¸€é“ã€{question_type_name_cn}ã€‘ï¼Œç”¨äºè¯„ä¼°å¤§æ¨¡å‹åœ¨é‡‘èæ–‡æœ¬ç†è§£ã€ä¿¡æ¯æå–å’Œé€»è¾‘æ¨ç†æ–¹é¢çš„èƒ½åŠ›ã€‚

**ã€å›¾ç‰‡æ¥æºä¸ç‰¹ç‚¹ã€‘**

- å›¾ç‰‡æ¥æºï¼šé‡‘èç ”æŠ¥çš„æ–‡å­—å†…å®¹æˆªå›¾
- å†…å®¹ç‰¹ç‚¹ï¼šä¸»è¦åŒ…å«æ–‡å­—å†…å®¹ï¼Œå¯èƒ½åŒ…æ‹¬ç ”æŠ¥æ­£æ–‡ã€å…¬å¸ä»‹ç»ã€ä¸šåŠ¡æè¿°ã€è´¢åŠ¡åˆ†æã€è¡Œä¸šè¯„è¿°ã€æŠ•èµ„å»ºè®®ç­‰
- æ–‡æœ¬ç‰¹ç‚¹ï¼šä¸“ä¸šæ€§å¼ºï¼Œä¿¡æ¯å¯†é›†ï¼ŒåŒ…å«å…³é”®æ•°æ®ã€é€»è¾‘å…³ç³»ã€å› æœæ¨æ–­ç­‰

**ã€æ€»ä½“åŸåˆ™ï¼šå®ç¼ºæ¯‹æ»¥ã€‘**

- ä½ åªéœ€è¦ä¸ºæ¯å¼ å›¾ç‰‡æ„é€ **å°‘é‡ä½†é«˜è´¨é‡ã€é«˜åŒºåˆ†åº¦**çš„é—®é¢˜
- å¦‚æœæ–‡æœ¬ä¿¡æ¯æœ‰é™æˆ–è¿‡äºç®€å•ï¼Œå®å¯åªæå‡º 1-2 é“éå¸¸å¥½çš„é¢˜ç›®ï¼Œä¹Ÿä¸è¦ä¸ºäº†æ•°é‡ç‰ºç‰²è´¨é‡
- æ¯ä¸€é“é¢˜éƒ½è¦æœ‰æ˜ç¡®çš„è€ƒå¯Ÿç‚¹å’Œæ¸…æ™°çš„è§£é¢˜è·¯å¾„ï¼Œè€Œä¸æ˜¯ç®€å•çš„æ–‡æœ¬å¤åˆ¶

**ã€ä»»åŠ¡è¦æ±‚ã€‘**

1. **å¿…é¡»ç”Ÿæˆéœ€è¦å¤šæ­¥æ¨ç†çš„é‡‘èæ–‡æœ¬ç†è§£é—®é¢˜**ï¼Œé—®é¢˜çš„ç­”æ¡ˆåªèƒ½ä¾èµ–å›¾åƒä¸­çš„æ–‡æœ¬å†…å®¹å¾—åˆ°ã€‚å¯ä»¥åŒ…æ‹¬ä½†ä¸é™äºï¼š
   - **ä¿¡æ¯æå–ä¸æ•´åˆ**ï¼šä»å¤šä¸ªæ®µè½ä¸­æå–å¹¶æ•´åˆå…³é”®ä¿¡æ¯
   - **é€»è¾‘æ¨æ–­**ï¼šåŸºäºæ–‡æœ¬ä¸­çš„å‰ææ¡ä»¶ï¼Œæ¨å¯¼å‡ºéšå«çš„ç»“è®º
   - **å› æœå…³ç³»åˆ†æ**ï¼šè¯†åˆ«æ–‡æœ¬ä¸­çš„å› æœé“¾æ¡ï¼Œæ¨æ–­åŸå› æˆ–ç»“æœ
   - **æ•°å€¼è®¡ç®—**ï¼šåŸºäºæ–‡æœ¬ä¸­æåˆ°çš„æ•°æ®è¿›è¡Œè®¡ç®—ï¼ˆå¦‚å¢é•¿ç‡ã€å æ¯”ã€æ¯”ç‡ç­‰ï¼‰
   - **æ¯”è¾ƒä¸æ’åº**ï¼šæ¯”è¾ƒæ–‡æœ¬ä¸­æåˆ°çš„å¤šä¸ªå®ä½“ã€æŒ‡æ ‡æˆ–è§‚ç‚¹
   - **è¯­ä¹‰ç†è§£**ï¼šç†è§£ä¸“ä¸šæœ¯è¯­ã€ä¸šåŠ¡é€»è¾‘ã€è´¢åŠ¡æ¦‚å¿µçš„æ·±å±‚å«ä¹‰
   - **ç»“æ„åŒ–ä¿¡æ¯é‡ç»„**ï¼šå°†åˆ†æ•£åœ¨æ–‡æœ¬ä¸­çš„ä¿¡æ¯è¿›è¡Œç»“æ„åŒ–æ•´ç†å’Œæ¨ç†

2. **é—®é¢˜å¿…é¡»å±äºé‡‘èé¢†åŸŸçš„å®é™…ç†è§£ä»»åŠ¡**ï¼Œå¦‚ï¼š
   - å…¬å¸ä¸šåŠ¡æ¨¡å¼ç†è§£ï¼šå•†ä¸šæ¨¡å¼ã€ç›ˆåˆ©æ¨¡å¼ã€ä¸šåŠ¡ç»“æ„
   - è´¢åŠ¡çŠ¶å†µåˆ†æï¼šä»æ–‡å­—æè¿°ä¸­æå–è´¢åŠ¡ä¿¡æ¯å¹¶è¿›è¡Œåˆ†æ
   - è¡Œä¸šç«äº‰æ ¼å±€ï¼šè¯†åˆ«ç«äº‰å¯¹æ‰‹ã€å¸‚åœºåœ°ä½ã€ç«äº‰ä¼˜åŠ¿
   - é£é™©å› ç´ è¯†åˆ«ï¼šä»æ–‡æœ¬ä¸­æå–å’Œå½’çº³é£é™©ç‚¹
   - æŠ•èµ„é€»è¾‘æ¨å¯¼ï¼šç†è§£ç ”æŠ¥çš„æŠ•èµ„å»ºè®®åŠå…¶ä¾æ®
   - ä¸šç»©é©±åŠ¨å› ç´ ï¼šè¯†åˆ«å½±å“ä¸šç»©çš„å…³é”®å› ç´ åŠå…¶ä½œç”¨æœºåˆ¶
   - æ”¿ç­–å½±å“åˆ†æï¼šç†è§£æ”¿ç­–å¯¹å…¬å¸æˆ–è¡Œä¸šçš„å½±å“è·¯å¾„

3. **æ‰€æœ‰é—®é¢˜å¿…é¡»æ»¡è¶³**ï¼š
   - ç­”æ¡ˆå”¯ä¸€ã€å®¢è§‚ã€å¯éªŒè¯ï¼ˆåŸºäºæ–‡æœ¬å†…å®¹èƒ½æ˜ç¡®åˆ¤æ–­ï¼‰
   - å¿…é¡»ä¸¥æ ¼ä¾èµ–å›¾åƒä¸­çš„æ–‡æœ¬ä¿¡æ¯ï¼ˆä¸èƒ½ä¾èµ–å›¾å¤–çŸ¥è¯†æˆ–å‡è®¾ï¼‰
   - é¢˜å¹²ä¸å…è®¸ç›´æ¥ç»™å‡ºæ–‡æœ¬ä¸­çš„å…³é”®ä¿¡æ¯æˆ–ç»“è®ºï¼Œåªèƒ½æä¾›å®šä½çº¿ç´¢
   - ä¸å…è®¸ä¸»è§‚ç±»é—®é¢˜ï¼ˆå¦‚"ä½ æ€ä¹ˆçœ‹""ä½ æ˜¯å¦åŒæ„"ï¼‰
   - ä¸å…è®¸å¼€æ”¾å¼å›ç­”ï¼ˆå¦‚"åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„åŸå› "ï¼‰

4. **å¿…é¡»é¿å…ç®€å•æ–‡æœ¬å¤åˆ¶ï¼Œè¦æ±‚å¤šæ­¥æ¨ç†**ï¼š
   - ä¸èƒ½æ˜¯"æ–‡ä¸­æåˆ°äº†ä»€ä¹ˆ"çš„ç®€å•æŸ¥æ‰¾é¢˜
   - éœ€è¦è·¨æ®µè½ã€è·¨å¥å­çš„ä¿¡æ¯æ•´åˆ
   - éœ€è¦ç†è§£æ–‡æœ¬çš„é€»è¾‘ç»“æ„å’Œè®ºè¯å…³ç³»
   - éœ€è¦è¿›è¡Œæ¨ç†ã€è®¡ç®—æˆ–ç»¼åˆåˆ¤æ–­
   - å¯ä»¥æ¶‰åŠå¤šä¸ªä¿¡æ¯ç‚¹çš„å…³è”åˆ†æ

5. **æ–‡æœ¬å®šä½ä¸ç†è§£è¦æ±‚**ï¼š
   - é¢˜ç›®åº”å¼•å¯¼æ¨¡å‹å‡†ç¡®å®šä½ç›¸å…³æ–‡æœ¬æ®µè½æˆ–å¥å­
   - éœ€è¦ç†è§£é‡‘èä¸“ä¸šæœ¯è¯­çš„å‡†ç¡®å«ä¹‰
   - éœ€è¦è¯†åˆ«æ–‡æœ¬ä¸­çš„å…³é”®æ•°æ®ã€æ—¶é—´ã€å®ä½“åç§°ç­‰
   - éœ€è¦ç†è§£æ–‡æœ¬çš„å±‚æ¬¡ç»“æ„ï¼ˆå¦‚æ€»åˆ†å…³ç³»ã€å¹¶åˆ—å…³ç³»ã€é€’è¿›å…³ç³»ç­‰ï¼‰

{"6. **æ€ç»´é“¾è¦æ±‚**ï¼š\n   å¿…é¡»åœ¨ qa_make_process å­—æ®µä¸­è¯¦ç»†è®°å½•è§£é¢˜çš„å®Œæ•´æ¨ç†é“¾æ¡ï¼ŒåŒ…æ‹¬ï¼š\n   - ä»æ–‡æœ¬çš„å“ªäº›ä½ç½®ï¼ˆæ®µè½ã€å¥å­ï¼‰è·å–äº†å“ªäº›ä¿¡æ¯\n   - å¦‚ä½•ç†è§£è¿™äº›ä¿¡æ¯ï¼ˆåŒ…æ‹¬ä¸“ä¸šæœ¯è¯­çš„è§£é‡Šï¼‰\n   - å¦‚ä½•å°†å¤šä¸ªä¿¡æ¯ç‚¹ç»„åˆèµ·æ¥è¿›è¡Œæ¨ç†\n   - æ¯ä¸€æ­¥çš„é€»è¾‘åˆ¤æ–­æˆ–è®¡ç®—è¿‡ç¨‹\n   - æœ€ç»ˆå¦‚ä½•å¾—å‡ºç­”æ¡ˆ\n\n" if include_process else ""}7. **ä¸¥ç¦çš„è¡Œä¸º**ï¼š
   - ä¸å¾—ç¼–é€ æ–‡æœ¬ä¸­ä¸å­˜åœ¨çš„ä¿¡æ¯ã€æ•°æ®æˆ–ç»“è®º
   - ä¸å¾—å¼•ç”¨å›¾åƒå¤–çš„ä¿¡æ¯æˆ–èƒŒæ™¯çŸ¥è¯†
   - ä¸å¾—åœ¨é¢˜å¹²ä¸­ç›´æ¥æ³„éœ²æ–‡æœ¬ä¸­çš„å…³é”®ä¿¡æ¯æˆ–ç­”æ¡ˆ
   - ä¸å¾—è®¾è®¡ä¾èµ–å¸¸è¯†æˆ–å¤–éƒ¨çŸ¥è¯†æ‰èƒ½å›ç­”çš„é—®é¢˜
   - ä¸å¾—è®¾è®¡ç­”æ¡ˆæ¨¡ç³Šæˆ–æœ‰å¤šç§å¯èƒ½è§£é‡Šçš„é—®é¢˜

{"8. **å¤šè½®å¯¹è¯è¦æ±‚**ï¼šéœ€è¦è®¾è®¡" + rounds_text + "è½®å¯¹è¯ï¼Œæ¯è½®éƒ½æœ‰ç‹¬ç«‹çš„é—®é¢˜å’Œç­”æ¡ˆï¼Œå½¢æˆå®Œæ•´çš„å¯¹è¯æµç¨‹ã€‚æ¯è½®é—®é¢˜éƒ½åº”éµå¾ªä¸Šè¿°æ‰€æœ‰è¦æ±‚ï¼Œä¸”å„è½®ä¹‹é—´åº”å½¢æˆé€»è¾‘é€’è¿›æˆ–å…³è”ï¼ˆå¦‚ï¼šç¬¬1è½®ä¿¡æ¯æå– â†’ ç¬¬2è½®é€»è¾‘æ¨ç† â†’ ç¬¬3è½®ç»¼åˆåˆ¤æ–­ï¼‰ã€‚" if is_multi_round else ""}
""",
        "mixed": f"""
ä½ æ˜¯ä¸€åé¡¶çº§çš„é‡‘èå¤šæ¨¡æ€é«˜éš¾åº¦ VQA é¢˜ç›®æ„å»ºä¸“å®¶ï¼Œæ“…é•¿ä»å¤æ‚çš„"å›¾è¡¨+æ–‡å­—è¯´æ˜"ç±»é‡‘èå›¾åƒä¸­ï¼Œè®¾è®¡éœ€è¦å¤šå±‚é€»è¾‘é“¾æ¡çš„ä¸“ä¸šçº§åˆ†æé¢˜ã€‚

è¯·åŸºäºç»™å®šçš„é‡‘èå›¾åƒï¼ˆå¯èƒ½åŒ…å«æŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€é¥¼å›¾ã€åŒæ¯”/ç¯æ¯”æ•°æ®ã€ç™¾åˆ†æ¯”ç»“æ„ã€è¡¨æ ¼ã€è¯´æ˜æ–‡å­—ã€æŒ‡æ ‡å®šä¹‰ã€å›¾ä¾‹ã€æ³¨é‡Šç­‰å¤šç§å…ƒç´ ï¼‰ï¼Œç”Ÿæˆä¸€é“ã€{question_type_name_cn}ã€‘ã€‚é¢˜ç›®éš¾åº¦éœ€æ˜¾è‘—é«˜äºä¸€èˆ¬é‡‘èç ”ç©¶å‘˜æ°´å¹³ï¼Œå¿…é¡»ä¾èµ–å›¾ä¸­å¤šä¸ªä¿¡æ¯å—çš„äº¤å‰ä½¿ç”¨ï¼ˆå›¾è¡¨ + æ–‡å­—è¯´æ˜ + æ³¨é‡Š + å›¾ä¾‹ï¼‰ã€‚

**ã€ä»»åŠ¡è¦æ±‚ã€‘**

1. **é¢˜ç›®éš¾åº¦éœ€è¾¾åˆ°é‡‘èåˆ†æå¸ˆ/ç ”ç©¶å‘˜æ°´å¹³**
   å¿…é¡»ç”Ÿæˆéœ€è¦å¤šæ­¥æ¨ç†çš„é‡‘èæ¨ç†é—®é¢˜ï¼Œé—®é¢˜çš„ç­”æ¡ˆåªèƒ½ä¾èµ–å›¾åƒä¸­çš„å†…å®¹å¾—åˆ°ã€‚é¢˜ç›®ç±»å‹å¯ä»¥åŒ…æ‹¬ä½†ä¸é™äºï¼š
   - è´¢åŠ¡æŒ‡æ ‡æ¨ç†ï¼ˆåŸºäºå›¾ä¸­æ•°æ®è¿›è¡Œè®¡ç®—æˆ–é€»è¾‘æ¨æ–­ï¼‰
   - å›¾è¡¨è¶‹åŠ¿åˆ†æä¸æ¨æ–­ï¼ˆè¯†åˆ«æ‹ç‚¹ã€åŠ é€Ÿ/å‡é€Ÿã€å‘¨æœŸæ€§ç­‰ï¼‰
   - ç»“æ„åŒ–å›¾å½¢æ¨ç†ï¼ˆå¦‚è‚¡æƒç»“æ„ã€èµ„äº§ç»“æ„ã€ä¸šåŠ¡æ„æˆç­‰ï¼‰
   - å¤šå®ä½“å…³ç³»æ¨æ–­ï¼ˆæ¯”è¾ƒã€æ’åºã€å…³è”åˆ†æç­‰ï¼‰
   - æ¯”è¾ƒç±»é—®é¢˜ï¼ˆå¢é•¿æœ€å¿«ã€å æ¯”æœ€é«˜ã€ç»“æ„å˜åŒ–ã€ç›¸å¯¹è¡¨ç°ç­‰ï¼‰
   - ç»æµæˆ–ä¸šåŠ¡å«ä¹‰æ¨æ–­ï¼ˆåŸºäºå›¾ä¸­å®¢è§‚ä¿¡æ¯å¾—å‡ºç»“è®ºï¼‰
   - è·¨å›¾è¡¨ç»¼åˆåˆ†æï¼ˆå¤šé¡¹æŒ‡æ ‡ä¹‹é—´çš„é“¾å¼æ¨æ–­ï¼Œå¦‚ Aâ†’Bâ†’Cï¼‰

2. **æ‰€æœ‰é—®é¢˜å¿…é¡»æ»¡è¶³**ï¼š
   - ç­”æ¡ˆå”¯ä¸€ã€å®¢è§‚ã€å¯éªŒè¯ï¼ˆä¸èƒ½æœ‰æ­§ä¹‰æˆ–å¤šç§è§£é‡Šï¼‰
   - å¿…é¡»ä¸¥æ ¼ä¾èµ–å›¾åƒä¸­çš„ä¿¡æ¯ï¼ˆä¸èƒ½ä¾èµ–å›¾å¤–çŸ¥è¯†æˆ–å‡è®¾ï¼‰
   - é¢˜å¹²ä¸å¾—ç›´æ¥ç»™å‡ºå›¾ç‰‡å†…å·²æœ‰çš„ç»“æ„åŒ–æ•°æ®æˆ–ç»“è®º
   - ä¸å…è®¸ä¸»è§‚ç±»é—®é¢˜ï¼ˆå¦‚"ä½ æ€ä¹ˆçœ‹""æ˜¯å¦åˆç†"ï¼‰
   - ä¸å…è®¸å¼€æ”¾å¼å›ç­”ï¼ˆå¦‚"åˆ—å‡ºå¯èƒ½çš„åŸå› ""å¯èƒ½æœ‰å“ªäº›å½±å“"ï¼‰

3. **éš¾åº¦è¦æ±‚ï¼šæ¯ä¸€é¢˜è‡³å°‘æ»¡è¶³ä»¥ä¸‹ä»»æ„ä¸¤æ¡**ï¼š
   - æ¶‰åŠè·¨å¹´åº¦ã€è·¨å­£åº¦ã€è·¨åŒºåŸŸçš„è¶‹åŠ¿æ¯”è¾ƒ
   - åŒæ—¶ä½¿ç”¨å›¾è¡¨æ•°å€¼ + å›¾ä¾‹è§£é‡Š + æ–‡å­—è¯´æ˜
   - å¤šæŒ‡æ ‡ä¹‹é—´çš„é“¾å¼æ¨ç†ï¼ˆAâ†’Bâ†’Cï¼Œéœ€è¦è‡³å°‘ 2-3 æ­¥æ¨ç†ï¼‰
   - ç»“æ„å æ¯”å˜åŒ–æ¨æ–­ï¼ˆå¦‚"å“ªéƒ¨åˆ†è´¡çŒ®æœ€å¤§""ç»“æ„å¦‚ä½•å˜åŒ–"ï¼‰
   - ä»åŒæ¯” + ç¯æ¯”çš„å åŠ ä¿¡æ¯å¾—å‡ºåˆ¤æ–­
   - ä½¿ç”¨å›¾ä¸­å¤šä¸ªå›¾å—ï¼ˆå¦‚ä¸»å›¾ + å­å›¾ + è¡¨æ ¼ï¼‰ç»¼åˆæ¨æ–­

{"4. **æ€ç»´é“¾è¦æ±‚**ï¼š\n   å¿…é¡»åœ¨ qa_make_process å­—æ®µä¸­è¯¦ç»†è®°å½•è§£é¢˜çš„å®Œæ•´æ¨ç†é“¾æ¡ï¼ŒåŒ…æ‹¬ï¼š\n   - ä»å›¾ä¸­å“ªäº›ä½ç½®è·å–äº†å“ªäº›ä¿¡æ¯\n   - å¦‚ä½•å°†è¿™äº›ä¿¡æ¯ç»„åˆèµ·æ¥è¿›è¡Œæ¨ç†\n   - æ¯ä¸€æ­¥çš„è®¡ç®—æˆ–é€»è¾‘åˆ¤æ–­è¿‡ç¨‹\n   - æœ€ç»ˆå¦‚ä½•å¾—å‡ºç­”æ¡ˆ\n\n" if include_process else ""}5. **ä¸¥ç¦çš„è¡Œä¸º**ï¼š
   - ä¸å¾—ç¼–é€ å›¾ä¸­ä¸å­˜åœ¨çš„æ•°æ®ã€å›¾ä¾‹ã€æ—¶é—´åˆ»åº¦ã€æŒ‡æ ‡åç§°
   - ä¸å¾—åœ¨é¢˜å¹²ä¸­ç›´æ¥æ³„éœ²å›¾ä¸­çš„å…³é”®æ•°æ®æˆ–ç»“è®º
   - ä¸å¾—è®¾è®¡ä¾èµ–å¤–éƒ¨çŸ¥è¯†æˆ–èƒŒæ™¯æ‰èƒ½å›ç­”çš„é—®é¢˜
   - ä¸å¾—è®¾è®¡ç­”æ¡ˆæ¨¡ç³Šæˆ–æœ‰å¤šç§å¯èƒ½è§£é‡Šçš„é—®é¢˜

{"6. **å¤šè½®å¯¹è¯è¦æ±‚**ï¼šéœ€è¦è®¾è®¡" + rounds_text + "è½®å¯¹è¯ï¼Œæ¯è½®éƒ½æœ‰ç‹¬ç«‹çš„é—®é¢˜å’Œç­”æ¡ˆï¼Œå½¢æˆå®Œæ•´çš„å¯¹è¯æµç¨‹ã€‚æ¯è½®é—®é¢˜éƒ½åº”éµå¾ªä¸Šè¿°æ‰€æœ‰è¦æ±‚ï¼Œä¸”å„è½®ä¹‹é—´åº”å½¢æˆé€»è¾‘é€’è¿›æˆ–å…³è”ï¼ˆå¦‚ï¼šç¬¬1è½®è¯†åˆ«æ•°æ® â†’ ç¬¬2è½®è®¡ç®—æŒ‡æ ‡ â†’ ç¬¬3è½®ç»¼åˆåˆ¤æ–­ï¼‰ã€‚" if is_multi_round else ""}
""",
        "splice": f"""
ä½ æ˜¯ä¸€åé¡¶çº§çš„é‡‘èå¤šæ¨¡æ€é«˜éš¾åº¦ VQA é¢˜ç›®æ„å»ºä¸“å®¶ï¼Œæ“…é•¿ä»å¤æ‚çš„"å›¾è¡¨+æ–‡å­—è¯´æ˜"ç±»é‡‘èå›¾åƒä¸­ï¼Œè®¾è®¡éœ€è¦å¤šå±‚é€»è¾‘é“¾æ¡çš„ä¸“ä¸šçº§åˆ†æé¢˜ã€‚

**ç‰¹åˆ«è¯´æ˜**ï¼šç»™å®šå›¾åƒä¸º**ä¸¤å¼ é‡‘èå›¾ç‰‡çš„æ‹¼æ¥**ï¼Œè¿™ä¸¤å¼ å›¾ç‰‡å¯èƒ½äº’ä¸ç›¸å…³ã€‚è¯·**åªé’ˆå¯¹å…¶ä¸­ä¸€å¼ å›¾ç‰‡çš„å†…å®¹å‡ºé¢˜**ï¼Œå‡ºé¢˜å†…å®¹è¦å’Œå¦ä¸€å¼ å›¾ç‰‡çš„å†…å®¹å°½å¯èƒ½ä¸ç›¸å¹²ï¼Œç›®çš„æ˜¯è€ƒå¯Ÿæ¨¡å‹çš„**ç²¾å‡†å®šä½èƒ½åŠ›**ï¼ˆèƒ½å¦å‡†ç¡®è¯†åˆ«å’Œèšç„¦äºç‰¹å®šå›¾ç‰‡åŒºåŸŸï¼‰ã€‚

è¯·åŸºäºé€‰å®šçš„é‚£å¼ é‡‘èå›¾åƒï¼ˆå¯èƒ½åŒ…å«æŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€é¥¼å›¾ã€åŒæ¯”/ç¯æ¯”æ•°æ®ã€ç™¾åˆ†æ¯”ç»“æ„ã€è¡¨æ ¼ã€è¯´æ˜æ–‡å­—ã€æŒ‡æ ‡å®šä¹‰ã€å›¾ä¾‹ã€æ³¨é‡Šç­‰ï¼‰ï¼Œç”Ÿæˆä¸€é“ã€{question_type_name_cn}ã€‘ã€‚é¢˜ç›®éš¾åº¦éœ€æ˜¾è‘—é«˜äºä¸€èˆ¬é‡‘èç ”ç©¶å‘˜æ°´å¹³ï¼Œå¿…é¡»ä¾èµ–æ‰€é€‰å›¾ç‰‡ä¸­å¤šä¸ªä¿¡æ¯å—çš„äº¤å‰ä½¿ç”¨ï¼ˆå›¾è¡¨ + æ–‡å­—è¯´æ˜ + æ³¨é‡Š + å›¾ä¾‹ï¼‰ã€‚

**ã€ä»»åŠ¡è¦æ±‚ã€‘**

1. **é¢˜ç›®éš¾åº¦éœ€è¾¾åˆ°é‡‘èåˆ†æå¸ˆ/ç ”ç©¶å‘˜æ°´å¹³**
   å¿…é¡»ç”Ÿæˆéœ€è¦å¤šæ­¥æ¨ç†çš„é‡‘èæ¨ç†é—®é¢˜ï¼Œé—®é¢˜çš„ç­”æ¡ˆåªèƒ½ä¾èµ–å›¾åƒä¸­çš„å†…å®¹å¾—åˆ°ã€‚é¢˜ç›®ç±»å‹å¯ä»¥åŒ…æ‹¬ä½†ä¸é™äºï¼š
   - è´¢åŠ¡æŒ‡æ ‡æ¨ç†ï¼ˆåŸºäºå›¾ä¸­æ•°æ®è¿›è¡Œè®¡ç®—æˆ–é€»è¾‘æ¨æ–­ï¼‰
   - å›¾è¡¨è¶‹åŠ¿åˆ†æä¸æ¨æ–­ï¼ˆè¯†åˆ«æ‹ç‚¹ã€åŠ é€Ÿ/å‡é€Ÿã€å‘¨æœŸæ€§ç­‰ï¼‰
   - ç»“æ„åŒ–å›¾å½¢æ¨ç†ï¼ˆå¦‚è‚¡æƒç»“æ„ã€èµ„äº§ç»“æ„ã€ä¸šåŠ¡æ„æˆç­‰ï¼‰
   - å¤šå®ä½“å…³ç³»æ¨æ–­ï¼ˆæ¯”è¾ƒã€æ’åºã€å…³è”åˆ†æç­‰ï¼‰
   - æ¯”è¾ƒç±»é—®é¢˜ï¼ˆå¢é•¿æœ€å¿«ã€å æ¯”æœ€é«˜ã€ç»“æ„å˜åŒ–ã€ç›¸å¯¹è¡¨ç°ç­‰ï¼‰
   - ç»æµæˆ–ä¸šåŠ¡å«ä¹‰æ¨æ–­ï¼ˆåŸºäºå›¾ä¸­å®¢è§‚ä¿¡æ¯å¾—å‡ºç»“è®ºï¼‰
   - è·¨å›¾è¡¨ç»¼åˆåˆ†æï¼ˆåœ¨æ‰€é€‰å›¾ç‰‡å†…ï¼Œå¤šé¡¹æŒ‡æ ‡ä¹‹é—´çš„é“¾å¼æ¨æ–­ï¼Œå¦‚ Aâ†’Bâ†’Cï¼‰

2. **æ‰€æœ‰é—®é¢˜å¿…é¡»æ»¡è¶³**ï¼š
   - ç­”æ¡ˆå”¯ä¸€ã€å®¢è§‚ã€å¯éªŒè¯ï¼ˆä¸èƒ½æœ‰æ­§ä¹‰æˆ–å¤šç§è§£é‡Šï¼‰
   - å¿…é¡»ä¸¥æ ¼ä¾èµ–æ‰€é€‰å›¾ç‰‡ä¸­çš„ä¿¡æ¯ï¼ˆä¸èƒ½ä¾èµ–å¦ä¸€å¼ å›¾ç‰‡æˆ–å›¾å¤–çŸ¥è¯†ï¼‰
   - é¢˜å¹²ä¸å¾—ç›´æ¥ç»™å‡ºå›¾ç‰‡å†…å·²æœ‰çš„ç»“æ„åŒ–æ•°æ®æˆ–ç»“è®º
   - é¢˜å¹²éœ€è¦é€šè¿‡æè¿°è®©æ¨¡å‹æ˜ç¡®çŸ¥é“æ˜¯é’ˆå¯¹å“ªå¼ å›¾ç‰‡å‡ºé¢˜ï¼ˆå¦‚"ä¸Šå›¾""ä¸‹å›¾""å·¦å›¾""å³å›¾"æˆ–é€šè¿‡å›¾ç‰‡ä¸»é¢˜æè¿°ï¼‰
   - ä¸å…è®¸ä¸»è§‚ç±»é—®é¢˜ï¼ˆå¦‚"ä½ æ€ä¹ˆçœ‹""æ˜¯å¦åˆç†"ï¼‰
   - ä¸å…è®¸å¼€æ”¾å¼å›ç­”ï¼ˆå¦‚"åˆ—å‡ºå¯èƒ½çš„åŸå› ""å¯èƒ½æœ‰å“ªäº›å½±å“"ï¼‰

3. **éš¾åº¦è¦æ±‚ï¼šæ¯ä¸€é¢˜è‡³å°‘æ»¡è¶³ä»¥ä¸‹ä»»æ„ä¸¤æ¡**ï¼š
   - æ¶‰åŠè·¨å¹´åº¦ã€è·¨å­£åº¦ã€è·¨åŒºåŸŸçš„è¶‹åŠ¿æ¯”è¾ƒ
   - åŒæ—¶ä½¿ç”¨å›¾è¡¨æ•°å€¼ + å›¾ä¾‹è§£é‡Š + æ–‡å­—è¯´æ˜
   - å¤šæŒ‡æ ‡ä¹‹é—´çš„é“¾å¼æ¨ç†ï¼ˆAâ†’Bâ†’Cï¼Œéœ€è¦è‡³å°‘ 2-3 æ­¥æ¨ç†ï¼‰
   - ç»“æ„å æ¯”å˜åŒ–æ¨æ–­ï¼ˆå¦‚"å“ªéƒ¨åˆ†è´¡çŒ®æœ€å¤§""ç»“æ„å¦‚ä½•å˜åŒ–"ï¼‰
   - ä»åŒæ¯” + ç¯æ¯”çš„å åŠ ä¿¡æ¯å¾—å‡ºåˆ¤æ–­
   - ä½¿ç”¨æ‰€é€‰å›¾ç‰‡ä¸­çš„å¤šä¸ªå›¾å—ï¼ˆå¦‚ä¸»å›¾ + å­å›¾ + è¡¨æ ¼ï¼‰ç»¼åˆæ¨æ–­

4. **ç²¾å‡†å®šä½è¦æ±‚ï¼ˆé‡è¦ï¼‰**ï¼š
   - é¢˜å¹²å¿…é¡»æ˜ç¡®æŒ‡å‘å…¶ä¸­ä¸€å¼ å›¾ç‰‡ï¼Œé¿å…æ¨¡ç³Šä¸æ¸…
   - å¯ä»¥ä½¿ç”¨ä½ç½®æè¿°è¯ï¼ˆä¸Šå›¾/ä¸‹å›¾/å·¦å›¾/å³å›¾ï¼‰æˆ–ä¸»é¢˜æè¿°ï¼ˆå¦‚"å…³äºXXçš„å›¾è¡¨"ï¼‰
   - ç­”æ¡ˆå¿…é¡»åªèƒ½ä»æ‰€é€‰å›¾ç‰‡ä¸­å¾—å‡ºï¼Œä¸èƒ½æ··ç”¨ä¸¤å¼ å›¾ç‰‡çš„ä¿¡æ¯
   - æ¨ç†è¿‡ç¨‹è¦æ˜ç¡®è¯´æ˜ä»æ‰€é€‰å›¾ç‰‡çš„å“ªäº›ä½ç½®è·å–äº†å“ªäº›ä¿¡æ¯

{("5. **æ€ç»´é“¾è¦æ±‚**ï¼š\n   å¿…é¡»åœ¨ qa_make_process å­—æ®µä¸­è¯¦ç»†è®°å½•è§£é¢˜çš„å®Œæ•´æ¨ç†é“¾æ¡ï¼ŒåŒ…æ‹¬ï¼š\n   - æ˜ç¡®è¯´æ˜é’ˆå¯¹çš„æ˜¯å“ªå¼ å›¾ç‰‡ï¼ˆå¦‚\"åŸºäºä¸Šå›¾\"æˆ–\"åŸºäºå…³äºXXçš„å›¾è¡¨\"ï¼‰\n   - ä»è¯¥å›¾ç‰‡çš„å“ªäº›ä½ç½®è·å–äº†å“ªäº›ä¿¡æ¯\n   - å¦‚ä½•å°†è¿™äº›ä¿¡æ¯ç»„åˆèµ·æ¥è¿›è¡Œæ¨ç†\n   - æ¯ä¸€æ­¥çš„è®¡ç®—æˆ–é€»è¾‘åˆ¤æ–­è¿‡ç¨‹\n   - æœ€ç»ˆå¦‚ä½•å¾—å‡ºç­”æ¡ˆ\n\n" if include_process else "")}
6. **ä¸¥ç¦çš„è¡Œä¸º**ï¼š
   - ä¸å¾—æ··ç”¨ä¸¤å¼ å›¾ç‰‡çš„ä¿¡æ¯è¿›è¡Œå‡ºé¢˜æˆ–ä½œç­”
   - ä¸å¾—ç¼–é€ å›¾ä¸­ä¸å­˜åœ¨çš„æ•°æ®ã€å›¾ä¾‹ã€æ—¶é—´åˆ»åº¦ã€æŒ‡æ ‡åç§°
   - ä¸å¾—åœ¨é¢˜å¹²ä¸­ç›´æ¥æ³„éœ²å›¾ä¸­çš„å…³é”®æ•°æ®æˆ–ç»“è®º
   - ä¸å¾—è®¾è®¡ä¾èµ–å¤–éƒ¨çŸ¥è¯†æˆ–èƒŒæ™¯æ‰èƒ½å›ç­”çš„é—®é¢˜
   - ä¸å¾—è®¾è®¡ç­”æ¡ˆæ¨¡ç³Šæˆ–æœ‰å¤šç§å¯èƒ½è§£é‡Šçš„é—®é¢˜

{"7. **å¤šè½®å¯¹è¯è¦æ±‚**ï¼šéœ€è¦è®¾è®¡" + rounds_text + "è½®å¯¹è¯ï¼Œæ¯è½®éƒ½æœ‰ç‹¬ç«‹çš„é—®é¢˜å’Œç­”æ¡ˆï¼Œå½¢æˆå®Œæ•´çš„å¯¹è¯æµç¨‹ã€‚æ¯è½®é—®é¢˜éƒ½åº”éµå¾ªä¸Šè¿°æ‰€æœ‰è¦æ±‚ï¼Œä¸”å„è½®ä¹‹é—´åº”å½¢æˆé€»è¾‘é€’è¿›æˆ–å…³è”ï¼ˆå¦‚ï¼šç¬¬1è½®è¯†åˆ«æ•°æ® â†’ ç¬¬2è½®è®¡ç®—æŒ‡æ ‡ â†’ ç¬¬3è½®ç»¼åˆåˆ¤æ–­ï¼‰ã€‚æ‰€æœ‰è½®æ¬¡çš„é—®é¢˜éƒ½å¿…é¡»é’ˆå¯¹åŒä¸€å¼ å›¾ç‰‡ã€‚" if is_multi_round else ""}
"""
    }

    # ğŸ”§ æ‰©å±•è¯´æ˜ï¼šæ·»åŠ æ–°å›¾ç‰‡ç±»å‹æ—¶ï¼Œåœ¨è¿™é‡Œæ·»åŠ å¯¹åº”çš„å®Œæ•´å‡ºé¢˜é€»è¾‘
    # prompts["video_frame"] = f"""
    # ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è§†è§‰æ¨ç†è¯„æµ‹å‡ºé¢˜ä¸“å®¶ã€‚è¯·åŸºäºè¿™å¼ å›¾ç‰‡çš„å†…å®¹ï¼Œè®¾è®¡ä¸€é“ã€{question_type_name_cn}ã€‘ã€‚
    # 
    # **å›¾ç‰‡ç±»å‹**: video_frameï¼ˆè§†é¢‘å¸§ç±»å‹ï¼‰
    # **å›¾ç‰‡ç‰¹ç‚¹**ï¼šåŒ…å«æ—¶é—´åºåˆ—ä¿¡æ¯ï¼Œæ˜¯è§†é¢‘ä¸­çš„ä¸€å¸§ã€‚
    # **å‡ºé¢˜é‡ç‚¹**ï¼šå…³æ³¨æ—¶é—´å˜åŒ–ã€åŠ¨ä½œè¯†åˆ«ã€åŠ¨æ€ç‰¹å¾ç­‰ã€‚
    # **å‡ºé¢˜è¦æ±‚**ï¼š
    # 1. **æ·±åº¦æ¨ç†**ï¼š...
    # 2. **æ—¶é—´åˆ†æ**ï¼š...
    # 3. **æ€ç»´é“¾**ï¼š...
    # """
    
    return prompts.get(image_type, prompts["mixed"])  # é»˜è®¤ä½¿ç”¨ mixed ç±»å‹

def get_question_type_specific_requirements(question_type: str, include_process: bool = True) -> str:
    """
    è·å–ç‰¹å®šé—®é¢˜ç±»å‹çš„è¦æ±‚å’Œè¾“å‡ºæ ¼å¼
    ğŸ”§ æ‰©å±•è¯´æ˜ï¼šæ·»åŠ æ–°é—®é¢˜ç±»å‹æ—¶ï¼Œåªéœ€åœ¨è¿™é‡Œæ·»åŠ å¯¹åº”çš„è¦æ±‚
    æ³¨æ„ï¼šæ¯æ¬¡åªç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥è¾“å‡ºæ ¼å¼æ˜¯å•ä¸ªå¯¹è±¡ï¼Œä¸æ˜¯æ•°ç»„
    """
    requirements = {
        "single_choice": f"""
**æ ¼å¼è§„èŒƒ**ï¼šå¿…é¡»æä¾› A, B, C, D å››ä¸ªé€‰é¡¹ï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªæ˜¯æ­£ç¡®ç­”æ¡ˆã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼š
{{
    "question_type": "å››é€‰å•é€‰",
    "question": "é—®é¢˜å†…å®¹...",
    "options": {{"A": "...", "B": "...", "C": "...", "D": "..."}},
{("    \"qa_make_process\": \"æ¨ç†è¿‡ç¨‹...\",\n" if include_process else "")}    "answer": "ä¸€ä¸ªé€‰é¡¹å­—æ¯"
}}
""",
        "multiple_choice": f"""
**æ ¼å¼è§„èŒƒ**ï¼šå¿…é¡»æä¾› A, B, C, D å››ä¸ªé€‰é¡¹ï¼Œå…¶ä¸­è‡³å°‘æœ‰ä¸¤ä¸ªæ˜¯æ­£ç¡®ç­”æ¡ˆã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼š
{{
    "question_type": "å››é€‰å¤šé€‰",
    "question": "é—®é¢˜å†…å®¹...",
    "options": {{"A": "...", "B": "...", "C": "...", "D": "..."}},
{("    \"qa_make_process\": \"æ¨ç†è¿‡ç¨‹...\",\n" if include_process else "")}    "answer": "å¤šä¸ªé€‰é¡¹å­—æ¯"  // å¤šä¸ªæ­£ç¡®ç­”æ¡ˆç”¨å­—æ¯ç»„åˆï¼Œå¦‚ "AB", "ACD" ç­‰
}}
""",
        "true_false": f"""
**æ ¼å¼è§„èŒƒ**ï¼šåˆ¤æ–­é¢˜çš„é€‰é¡¹å›ºå®šä¸ºnullï¼Œansweræ˜¯ true æˆ–è€… falseï¼Œ

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼š
{{
    "question_type": "åˆ¤æ–­é¢˜",
    "question": "é—®é¢˜å†…å®¹...",
    "options": null,
{("    \"qa_make_process\": \"æ¨ç†è¿‡ç¨‹...\",\n" if include_process else "")}    "answer": "true" æˆ–è€… "false" // trueè¡¨ç¤ºæ­£ç¡®ï¼Œfalseè¡¨ç¤ºé”™è¯¯
}}
""",
        "essay": f"""
**ç­”æ¡ˆç®€ç»ƒ**ï¼šç­”æ¡ˆå¿…é¡»æ˜¯å…·ä½“çš„å®ä½“åç§°ã€æ•°å­—ç»“æœæˆ–å…³é”®çŸ­è¯­ã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼š
{{
    "question_type": "é—®ç­”é¢˜",
    "question": "é—®é¢˜å†…å®¹...",
    "options": null,
{("    \"qa_make_process\": \"æ¨ç†è¿‡ç¨‹...\",\n" if include_process else "")}    "answer": "æ­£ç¡®ç­”æ¡ˆ"
}}
""",
        "multi_round_single_choice": """
**æ ¼å¼è§„èŒƒ**ï¼šå¤šè½®å•é€‰é¢˜éœ€è¦è®¾è®¡å¤šè½®å¯¹è¯ï¼Œæ¯è½®éƒ½æ˜¯å•é€‰é¢˜ï¼Œå¿…é¡»æä¾› A, B, C, D å››ä¸ªé€‰é¡¹ã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼ŒåŒ…å« round1, round2, round3 ç­‰å­—æ®µï¼ˆæ ¹æ®æŒ‡å®šçš„è½®æ•°ç”Ÿæˆå¯¹åº”æ•°é‡çš„å­—æ®µï¼‰ã€‚
""",
        "multi_round_essay": """
**æ ¼å¼è§„èŒƒ**ï¼šå¤šè½®é—®ç­”é¢˜éœ€è¦è®¾è®¡å¤šè½®å¯¹è¯ï¼Œæ¯è½®éƒ½æ˜¯é—®ç­”é¢˜ï¼Œç­”æ¡ˆå¿…é¡»æ˜¯å…·ä½“çš„å®ä½“åç§°ã€æ•°å­—ç»“æœæˆ–å…³é”®çŸ­è¯­ã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼ŒåŒ…å« round1, round2, round3 ç­‰å­—æ®µï¼ˆæ ¹æ®æŒ‡å®šçš„è½®æ•°ç”Ÿæˆå¯¹åº”æ•°é‡çš„å­—æ®µï¼‰ã€‚
"""
    }
    
    # ğŸ”§ æ‰©å±•è¯´æ˜ï¼šæ·»åŠ æ–°é—®é¢˜ç±»å‹æ—¶ï¼Œåœ¨è¿™é‡Œæ·»åŠ å¯¹åº”çš„è¦æ±‚
    # requirements["fill_blank"] = """
    # **æ ¼å¼è§„èŒƒ**ï¼šå¡«ç©ºé¢˜éœ€è¦æä¾›ç©ºç™½ä½ç½®ï¼Œç­”æ¡ˆåº”ç®€æ´æ˜ç¡®ã€‚
    # ...
    # """
    
    base_requirement = requirements.get(question_type, requirements["essay"])
    # æ ¹æ® include_process å‚æ•°åŠ¨æ€è°ƒæ•´è¾“å‡ºæ ¼å¼
    if not include_process:
        # ç§»é™¤ qa_make_process å­—æ®µ
        base_requirement = base_requirement.replace('    "qa_make_process": "æ¨ç†è¿‡ç¨‹...",\n', '')
        base_requirement = base_requirement.replace('    "qa_make_process": {', '')
        base_requirement = base_requirement.replace('        {process_example}\n    },\n', '')
    return base_requirement


def build_prompt_template(image_type: str, question_type: str, rounds: int = 3, include_process: bool = True) -> str:
    """
    æ„å»ºå®Œæ•´çš„æç¤ºè¯æ¨¡æ¿
    ğŸ”§ æ‰©å±•è¯´æ˜ï¼šè¿™ä¸ªå‡½æ•°ä¼šè‡ªåŠ¨ç»„åˆæ‰€æœ‰éƒ¨åˆ†ï¼Œæ— éœ€ä¿®æ”¹
    æ³¨æ„ï¼šç°åœ¨åªç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥ä¸éœ€è¦ count å‚æ•°
    æç¤ºè¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šå›¾ç‰‡ç±»å‹å‡ºé¢˜é€»è¾‘ + é¢˜ç›®ç±»å‹è¦æ±‚ï¼ˆåŒ…æ‹¬è¾“å‡ºæ ¼å¼ï¼‰
    rounds: å¤šè½®å¯¹è¯çš„è½®æ•°ï¼ˆä»…ç”¨äºå¤šè½®å¯¹è¯é¢˜å‹ï¼‰
    """
    question_type_name_cn = QUESTION_TYPES.get(question_type, "é—®ç­”é¢˜")
    
    # ç»„åˆä¸¤éƒ¨åˆ†ï¼šå›¾ç‰‡ç±»å‹å‡ºé¢˜é€»è¾‘ + é¢˜ç›®ç±»å‹è¦æ±‚ï¼ˆåŒ…æ‹¬è¾“å‡ºæ ¼å¼ï¼‰
    image_prompt = get_image_type_prompt(image_type, question_type_name_cn, rounds, include_process)
    type_requirements = get_question_type_specific_requirements(question_type, include_process)
    
    # å¦‚æœæ˜¯å¤šè½®å¯¹è¯ï¼ŒåŠ¨æ€ç”Ÿæˆè¾“å‡ºæ ¼å¼ç¤ºä¾‹
    if "multi_round" in question_type:
        # ç”Ÿæˆè½®æ•°å­—æ®µåˆ—è¡¨
        rounds_list = [f"round{i+1}" for i in range(rounds)]
        
        # ç”Ÿæˆç¤ºä¾‹æ ¼å¼
        question_example = ",\n        ".join([f'"{r}": "ç¬¬{i+1}è½®é—®é¢˜å†…å®¹..."' for i, r in enumerate(rounds_list)])
        
        if "single_choice" in question_type:
            # å¤šè½®å•é€‰é¢˜
            options_example = ",\n        ".join([f'"{r}": {{"A": "...", "B": "...", "C": "...", "D": "..."}}' for r in rounds_list])
            answer_example = ",\n        ".join([f'"{r}": "ä¸€ä¸ªé€‰é¡¹å­—æ¯"' for r in rounds_list])
            process_example = ",\n        ".join([f'"{r}": "ç¬¬{i+1}è½®æ¨ç†è¿‡ç¨‹..."' for i, r in enumerate(rounds_list)])
            
            process_part = f'    "qa_make_process": {{\n        {process_example}\n    }},\n' if include_process else ''
            format_example = f"""
**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼ŒåŒ…å« {rounds} è½®å¯¹è¯å­—æ®µï¼š
{{
    "question_type": "å¤šè½®å•é€‰é¢˜",
    "question": {{
        {question_example}
    }},
    "options": {{
        {options_example}
    }},
{process_part}    "answer": {{
        {answer_example}
    }}
}}
"""
        else:
            # å¤šè½®é—®ç­”é¢˜
            process_example = ",\n        ".join([f'"{r}": "ç¬¬{i+1}è½®æ¨ç†è¿‡ç¨‹..."' for i, r in enumerate(rounds_list)])
            answer_example = ",\n        ".join([f'"{r}": "ç¬¬{i+1}è½®ç­”æ¡ˆ"' for i, r in enumerate(rounds_list)])
            
            process_part = f'    "qa_make_process": {{\n        {process_example}\n    }},\n' if include_process else ''
            format_example = f"""
**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼ŒåŒ…å« {rounds} è½®å¯¹è¯å­—æ®µï¼š
{{
    "question_type": "å¤šè½®é—®ç­”é¢˜",
    "question": {{
        {question_example}
    }},
    "options": null,
{process_part}    "answer": {{
        {answer_example}
    }}
}}
"""
        
        type_requirements = type_requirements + format_example
    
    # æ‹¼æ¥ï¼šå›¾ç‰‡ç±»å‹æç¤ºè¯ + é¢˜ç›®ç±»å‹è¦æ±‚
    prompt = image_prompt + type_requirements
    return prompt

# åˆå§‹åŒ–æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿï¼ˆå»¶è¿Ÿç”Ÿæˆï¼ŒæŒ‰éœ€æ„å»ºï¼‰
PROMPT_TEMPLATES = {}

def get_prompt_template(image_type: str, question_type: str, count: int = 1, rounds: int = 3, include_process: bool = True) -> str:
    """
    è·å–æç¤ºè¯æ¨¡æ¿ï¼ˆå»¶è¿Ÿç”Ÿæˆï¼Œæ”¯æŒåŠ¨æ€æ‰©å±•ï¼‰
    ğŸ”§ æ‰©å±•è¯´æ˜ï¼šæ·»åŠ æ–°ç±»å‹åï¼Œè¿™ä¸ªå‡½æ•°ä¼šè‡ªåŠ¨æ”¯æŒï¼Œæ— éœ€ä¿®æ”¹
    æ³¨æ„ï¼šcount å‚æ•°ä¿ç•™ä»¥å…¼å®¹æ—§ä»£ç ï¼Œä½†å®é™…ä¸å†ä½¿ç”¨ï¼ˆæ¯æ¬¡åªç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼‰
    rounds: å¤šè½®å¯¹è¯çš„è½®æ•°ï¼ˆä»…ç”¨äºå¤šè½®å¯¹è¯é¢˜å‹ï¼‰
    """
    # å¯¹äºå¤šè½®å¯¹è¯ï¼Œéœ€è¦åŒ…å«è½®æ•°ä¿¡æ¯åœ¨ç¼“å­˜é”®ä¸­
    # åŒæ—¶åŒ…å« include_process ä¿¡æ¯ï¼Œå› ä¸ºæç¤ºè¯å†…å®¹ä¼šä¸åŒ
    process_flag = "p1" if include_process else "p0"
    if "multi_round" in question_type:
        cache_key = f"{image_type}_{question_type}_r{rounds}_{process_flag}"
    else:
        cache_key = f"{image_type}_{question_type}_{process_flag}"
    
    if cache_key not in PROMPT_TEMPLATES:
        PROMPT_TEMPLATES[cache_key] = build_prompt_template(image_type, question_type, rounds, include_process)
    
    return PROMPT_TEMPLATES[cache_key]


# ==============================================================================
# ğŸ› ï¸ å·¥å…·å‡½æ•°
# ==============================================================================
def get_next_version_path(original_path):
    if not os.path.exists(original_path): return original_path
    dir_name, file_name = os.path.split(original_path)
    base_name, ext = os.path.splitext(file_name)
    counter = 2
    while True:
        new_name = f"{base_name}_v{counter}{ext}"
        new_path = os.path.join(dir_name, new_name)
        if not os.path.exists(new_path): return new_path
        counter += 1

def init_log_file(log_dir: str, args) -> str:
    """
    åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶
    è¿”å›æ—¥å¿—æ–‡ä»¶è·¯å¾„
    """
    global LOG_FILE
    
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    if not os.path.exists(log_dir):
        os.makedirs(log_dir, exist_ok=True)
    
    # ç”Ÿæˆæ—¥å¿—æ–‡ä»¶åï¼ˆåŒ…å«è¿è¡Œå‚æ•°å’Œæ—¶é—´æˆ³ï¼‰
    timestamp = time.strftime("%Y%m%d_%H%M%S")
    
    # ç¼©çŸ­é—®é¢˜ç±»å‹åç§°
    qt_short = {
        "single_choice": "sc",
        "multiple_choice": "mc", 
        "true_false": "tf",
        "essay": "essay",
        "multi_round_single_choice": "mrsc",
        "multi_round_essay": "mre"
    }.get(args.question_type, args.question_type[:10])
    
    # ç¼©çŸ­å›¾ç‰‡ç±»å‹åç§°
    it_short = {
        "pure_image": "img",
        "pure_text": "txt",
        "mixed": "mix",
        "splice": "spl",
        "all": "all"
    }.get(args.image_type, args.image_type[:10])
    
    log_filename = f"{timestamp}_{it_short}_{qt_short}_n{args.num}"
    if "multi_round" in args.question_type:
        log_filename += f"_r{args.rounds}"
    log_filename += ".log"
    
    log_path = os.path.join(log_dir, log_filename)
    
    # æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼ˆè¿½åŠ æ¨¡å¼ï¼‰
    LOG_FILE = open(log_path, "w", encoding="utf-8")
    
    # å†™å…¥è¿è¡Œå‚æ•°
    LOG_FILE.write("="*80 + "\n")
    LOG_FILE.write("ğŸ“‹ è¿è¡Œå‚æ•°\n")
    LOG_FILE.write("="*80 + "\n")
    LOG_FILE.write(f"è¿è¡Œæ—¶é—´: {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
    LOG_FILE.write(f"è¾“å…¥æ–‡ä»¶: {args.input}\n")
    LOG_FILE.write(f"è¾“å‡ºæ–‡ä»¶: {args.output}\n")
    LOG_FILE.write(f"å›¾ç‰‡ç±»å‹: {args.image_type}\n")
    LOG_FILE.write(f"é—®é¢˜ç±»å‹: {args.question_type}\n")
    LOG_FILE.write(f"æ¯å¼ å›¾ç‰‡ç”Ÿæˆé—®é¢˜æ•°: {args.num}\n")
    if "multi_round" in args.question_type:
        LOG_FILE.write(f"å¤šè½®å¯¹è¯è½®æ•°: {args.rounds}\n")
    LOG_FILE.write(f"æ¨¡å‹: {args.model}\n")
    LOG_FILE.write(f"API Base: {args.api_base}\n")
    LOG_FILE.write(f"æ¸©åº¦: {args.temp}\n")
    LOG_FILE.write(f"æœ€å¤§Tokenæ•°: {args.tokens}\n")
    LOG_FILE.write(f"å¹¶å‘çº¿ç¨‹æ•°: {args.workers}\n")
    LOG_FILE.write(f"æ‰¹é‡å†™å…¥å¤§å°: {args.batch}\n")
    LOG_FILE.write(f"æ–­ç‚¹ç»­ä¼ : {args.resume}\n")
    LOG_FILE.write(f"å¯ç”¨æ€è€ƒæ¨¡å¼: {args.enable_thinking}\n")
    LOG_FILE.write(f"æ—¥å¿—æ¨¡å¼: {args.log_mode} ({'è¯¦ç»†' if args.log_mode == 'detailed' else 'ç®€åŒ–'})\n")
    if args.limit:
        LOG_FILE.write(f"é™åˆ¶å¤„ç†æ•°é‡: {args.limit}\n")
    LOG_FILE.write("="*80 + "\n")
    LOG_FILE.write("\n")
    LOG_FILE.flush()
    
    return log_path

def log_model_response(image_id: str, question_index: int, response, prompt: str = "", api_time: float = 0):
    """
    è®°å½•æ¨¡å‹è¿”å›çš„æ—¥å¿—ï¼ˆæ”¯æŒè¯¦ç»†/ç®€åŒ–ä¸¤ç§æ¨¡å¼ï¼‰
    api_time: APIè°ƒç”¨è€—æ—¶ï¼ˆç§’ï¼‰
    """
    global LOG_FILE
    
    if LOG_FILE is None:
        return
    
    log_mode = GLOBAL_CONFIG.get("log_mode", "simple")
    
    with log_lock:
        try:
            LOG_FILE.write(f"\n{'='*80}\n")
            LOG_FILE.write(f"[{time.strftime('%H:%M:%S')}] image_id:{image_id} | question_index:{question_index}\n")
            LOG_FILE.write(f"{'='*80}\n")
            
            if log_mode == "detailed":
                # ğŸ“ è¯¦ç»†æ¨¡å¼ï¼šè¾“å‡ºå®Œæ•´ä¿¡æ¯
                LOG_FILE.write("\nã€æç¤ºè¯ã€‘\n")
                LOG_FILE.write(prompt + "\n")
                LOG_FILE.write(f"\n{'-'*80}\n")
                
                LOG_FILE.write("\nã€æ¨¡å‹å“åº” - å®Œæ•´åºåˆ—åŒ–ã€‘\n")
                try:
                    if hasattr(response, 'model_dump'):
                        response_dict = response.model_dump()
                    else:
                        response_dict = {
                            "id": getattr(response, 'id', None),
                            "object": getattr(response, 'object', None),
                            "created": getattr(response, 'created', None),
                            "model": getattr(response, 'model', None),
                        }
                        if hasattr(response, 'choices') and response.choices:
                            choice = response.choices[0]
                            choice_dict = {
                                "index": getattr(choice, 'index', None),
                                "finish_reason": getattr(choice, 'finish_reason', None),
                            }
                            if hasattr(choice, 'message'):
                                message = choice.message
                                message_dict = {
                                    "role": getattr(message, 'role', None),
                                    "content": getattr(message, 'content', None),
                                }
                                if hasattr(message, 'reasoning_content'):
                                    message_dict["reasoning_content"] = message.reasoning_content
                                choice_dict["message"] = message_dict
                            response_dict["choices"] = [choice_dict]
                        
                        if hasattr(response, 'usage'):
                            response_dict["usage"] = {
                                "prompt_tokens": getattr(response.usage, 'prompt_tokens', None),
                                "completion_tokens": getattr(response.usage, 'completion_tokens', None),
                                "total_tokens": getattr(response.usage, 'total_tokens', None),
                            }
                    
                    LOG_FILE.write(json.dumps(response_dict, indent=2, ensure_ascii=False, default=str))
                    LOG_FILE.write("\n")
                except Exception as e:
                    LOG_FILE.write(f"âš ï¸ åºåˆ—åŒ–å¤±è´¥: {e}\n")
                    LOG_FILE.write(f"å“åº”å­—ç¬¦ä¸²: {str(response)}\n")
            
            else:
                # ğŸ“ ç®€åŒ–æ¨¡å¼ï¼šåªè¾“å‡ºå…³é”®ä¿¡æ¯
                if hasattr(response, 'choices') and response.choices:
                    message = response.choices[0].message
                    
                    # Contentï¼ˆçœç•¥æ˜¾ç¤ºï¼‰
                    if message.content:
                        content_len = len(message.content)
                        if content_len > 300:
                            content_preview = message.content[:300] + f"...(å…±{content_len}å­—ç¬¦)"
                        else:
                            content_preview = message.content
                        LOG_FILE.write(f"\nã€Contentã€‘({content_len}å­—ç¬¦)\n{content_preview}\n")
                    
                    # Reasoning Contentï¼ˆçœç•¥æ˜¾ç¤ºï¼‰
                    if hasattr(message, 'reasoning_content') and message.reasoning_content:
                        reasoning_len = len(message.reasoning_content)
                        if reasoning_len > 300:
                            reasoning_preview = message.reasoning_content[:300] + f"...(å…±{reasoning_len}å­—ç¬¦)"
                        else:
                            reasoning_preview = message.reasoning_content
                        LOG_FILE.write(f"\nã€Reasoning Contentã€‘({reasoning_len}å­—ç¬¦)\n{reasoning_preview}\n")
                
                # Tokenä½¿ç”¨æƒ…å†µ
                LOG_FILE.write(f"\n{'-'*80}\n")
                if hasattr(response, 'usage') and response.usage:
                    usage = response.usage
                    prompt_tokens = getattr(usage, 'prompt_tokens', 0)
                    completion_tokens = getattr(usage, 'completion_tokens', 0)
                    total_tokens = getattr(usage, 'total_tokens', 0)
                    LOG_FILE.write(f"ã€Tokenä½¿ç”¨ã€‘è¾“å…¥:{prompt_tokens} | è¾“å‡º:{completion_tokens} | æ€»è®¡:{total_tokens}\n")
                else:
                    LOG_FILE.write(f"ã€Tokenä½¿ç”¨ã€‘æ— usageä¿¡æ¯\n")
                
                # APIè€—æ—¶
                LOG_FILE.write(f"ã€APIè€—æ—¶ã€‘{api_time:.2f}ç§’\n")
            
            LOG_FILE.write(f"{'='*80}\n\n")
            
            # æ¯5æ¬¡æ‰flushä¸€æ¬¡ï¼ˆæ‰¹é‡å†™å…¥ï¼‰
            if question_index % 5 == 0:
                LOG_FILE.flush()
        except Exception as e:
            # æ—¥å¿—å¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼Œé™é»˜å¤„ç†
            pass

def close_log_file():
    """
    å…³é—­æ—¥å¿—æ–‡ä»¶
    """
    global LOG_FILE
    if LOG_FILE:
        with log_lock:
            try:
                LOG_FILE.write("="*80 + "\n")
                LOG_FILE.write(f"æ—¥å¿—ç»“æŸæ—¶é—´: {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
                LOG_FILE.write("="*80 + "\n")
                LOG_FILE.close()
                LOG_FILE = None
            except:
                pass

def encode_image(image_path):
    """
    ç¼–ç å›¾ç‰‡ä¸º Base64ï¼Œå¹¶è¿”å› MIME ç±»å‹
    
    Returns:
        tuple: (base64_string, mime_type) æˆ– (None, None) å¦‚æœå¤±è´¥
    """
    try:
        if not os.path.exists(image_path):
            return None, None
        
        # æ ¹æ®æ–‡ä»¶åç¼€åˆ¤æ–­ MIME ç±»å‹
        ext = os.path.splitext(image_path)[1].lower()
        mime_types = {
            '.jpg': 'image/jpeg',
            '.jpeg': 'image/jpeg',
            '.png': 'image/png',
            '.gif': 'image/gif',
            '.webp': 'image/webp',
            '.bmp': 'image/bmp',
            '.tiff': 'image/tiff',
            '.tif': 'image/tiff',
        }
        mime_type = mime_types.get(ext, 'image/jpeg')  # é»˜è®¤ä½¿ç”¨ jpeg
        
        with open(image_path, "rb") as image_file:
            base64_str = base64.b64encode(image_file.read()).decode('utf-8')
            return base64_str, mime_type
    except:
        return None, None

def write_jsonl_item(item):
    """JSONL æ ¼å¼ï¼šå®æ—¶å†™å…¥å•æ¡æ•°æ®ï¼ˆé€è¡Œè¿½åŠ ï¼‰"""
    global OUTPUT_FORMAT
    if OUTPUT_FORMAT != "jsonl":
        return False
    
    with file_lock:
        try:
            with open(OUTPUT_PATH, "a", encoding="utf-8") as f:
                f.write(json.dumps(item, ensure_ascii=False) + "\n")
            return True
        except Exception as e:
            print(f"âŒ [JSONLå®æ—¶å†™å…¥å¤±è´¥] {e}")
            return False

def flush_buffer():
    """æ‰¹é‡å†™å…¥ç¼“å†²åŒºæ•°æ®åˆ°æ–‡ä»¶ï¼ˆä»…ç”¨äº JSON æ ¼å¼ï¼ŒJSONL æ ¼å¼ä¸ä½¿ç”¨æ­¤å‡½æ•°ï¼‰"""
    global result_buffer, OUTPUT_FORMAT
    
    # JSONL æ ¼å¼ä¸ä½¿ç”¨ bufferï¼Œç›´æ¥è¿”å›
    if OUTPUT_FORMAT == "jsonl":
        return
    
    with buffer_lock:
        if not result_buffer: 
            return
        current_batch = list(result_buffer)
        result_buffer = [] 
    
    flush_start = time.time()
    
    with file_lock:
        try:
            # JSON æ ¼å¼ï¼šéœ€è¦è¯»å–æ•´ä¸ªæ–‡ä»¶ï¼Œåˆå¹¶åå†™å…¥
            data = []
            
            # è¯»å–ç°æœ‰æ•°æ®
            if os.path.exists(OUTPUT_PATH):
                try:
                    with open(OUTPUT_PATH, "r", encoding="utf-8") as f:
                        content = f.read().strip()
                        if content: 
                            data = json.loads(content)
                except Exception as e:
                    print(f"âš ï¸ [è¯»å–å¤±è´¥] {e}")
                    data = []
            
            data.extend(current_batch)
            
            # å†™å…¥æ•°æ®
            with open(OUTPUT_PATH, "w", encoding="utf-8") as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
            
            flush_time = time.time() - flush_start
            
            # åªåœ¨å¼‚å¸¸æƒ…å†µä¸‹æ‰æ‰“å°è¯¦ç»†ä¿¡æ¯
            if flush_time > 2.0:
                file_size_mb = os.path.getsize(OUTPUT_PATH) / 1024 / 1024
                print(f"\nâš ï¸ [JSONä¿å­˜æ…¢] +{len(current_batch)}é¢˜ è€—æ—¶{flush_time:.1f}s æ–‡ä»¶{file_size_mb:.1f}MB")
                if file_size_mb > 10:
                    print(f"   ğŸ’¡ å»ºè®®ï¼šä½¿ç”¨ .jsonl æ ¼å¼ï¼ˆé€è¡Œè¿½åŠ ï¼Œæ— éœ€batchï¼‰æˆ–å¢å¤§--batchå‚æ•°ï¼ˆå½“å‰{GLOBAL_CONFIG['batch_size']}ï¼‰")
        except Exception as e: 
            print(f"âŒ [ä¿å­˜å¤±è´¥] {e}")

def signal_handler(signum, frame):
    """
    ä¿¡å·å¤„ç†å‡½æ•°ï¼šå¤„ç† Ctrl+C (SIGINT) å’Œ SIGTERM ä¿¡å·
    ç¡®ä¿åœ¨ä¸­æ–­æ—¶ä¹Ÿèƒ½ä¿å­˜ JSON æ ¼å¼çš„ buffer æ•°æ®
    """
    global shutdown_event, OUTPUT_FORMAT
    
    print("\n\nâš ï¸  æ£€æµ‹åˆ°ä¸­æ–­ä¿¡å· (Ctrl+C)ï¼Œæ­£åœ¨ä¼˜é›…å…³é—­...")
    print("   ğŸ“ æ­£åœ¨ä¿å­˜å·²å¤„ç†çš„æ•°æ®ï¼ˆJSONæ ¼å¼ä¼šä¿å­˜bufferä¸­çš„æ•°æ®ï¼‰...")
    
    # è®¾ç½®å…³é—­æ ‡å¿—
    shutdown_event.set()
    
    # ç«‹å³åˆ·æ–° JSON æ ¼å¼çš„ bufferï¼ˆJSONL æ ¼å¼å·²ç»æ˜¯å®æ—¶å†™å…¥çš„ï¼Œæ— éœ€å¤„ç†ï¼‰
    if OUTPUT_FORMAT == "json":
        print("   ğŸ’¾ æ­£åœ¨ä¿å­˜ JSON buffer ä¸­çš„æ•°æ®...")
        flush_buffer()
        print("   âœ… JSON buffer å·²ä¿å­˜")
    else:
        print("   âœ… JSONL æ ¼å¼å·²ç»æ˜¯å®æ—¶å†™å…¥ï¼Œæ— éœ€é¢å¤–ä¿å­˜")
    
    # å…³é—­æ—¥å¿—æ–‡ä»¶
    close_log_file()
    
    print("   âœ… æ•°æ®å·²ä¿å­˜ï¼Œæ­£åœ¨é€€å‡º...")
    sys.exit(0)

# ==============================================================================
# ğŸ§  æ ¸å¿ƒç”Ÿæˆé€»è¾‘
# ==============================================================================

def generate_single_qa(item, image_type, question_type, question_index, total_count, base64_image_cache=None, mime_type_cache=None):
    """
    ç”Ÿæˆå•ä¸ªé—®é¢˜ï¼ˆä¸€æ¬¡å¯¹è¯ç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼‰
    è¾“å…¥: 
        - item: å•ä¸ªå›¾ç‰‡ä¿¡æ¯
        - image_type: å›¾ç‰‡ç±»å‹
        - question_type: é—®é¢˜ç±»å‹
        - question_index: å½“å‰é—®é¢˜ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰
        - total_count: æ€»å…±è¦ç”Ÿæˆçš„é—®é¢˜æ•°
        - base64_image_cache: Base64ç¼–ç çš„å›¾ç‰‡ï¼ˆå¯é€‰ï¼Œå¦‚æœæä¾›åˆ™ä¸å†é‡æ–°ç¼–ç ï¼‰
        - mime_type_cache: å›¾ç‰‡çš„MIMEç±»å‹ï¼ˆå¯é€‰ï¼Œä¸base64_image_cacheä¸€èµ·ä½¿ç”¨ï¼‰
    è¾“å‡º: å•ä¸ªé—®ç­”å¯¹å­—å…¸ï¼Œå¦‚æœå¤±è´¥è¿”å› None
    """
    # æ€§èƒ½è¯Šæ–­ï¼šè®°å½•å„é˜¶æ®µè€—æ—¶
    stage_times = {}
    total_start = time.time()
    
    image_path = item.get("image_path")
    original_id = str(item.get("id", "unknown"))
    
    # ç¡®ä¿ image_type ä» item ä¸­è·å–æˆ–ä½¿ç”¨ä¼ å…¥çš„å‚æ•°
    item_image_type = item.get("image_type") or item.get("type") or image_type
    
    # å¦‚æœæä¾›äº†ç¼“å­˜çš„ base64ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™é‡æ–°ç¼–ç 
    if base64_image_cache is not None and mime_type_cache is not None:
        base64_image = base64_image_cache
        mime_type = mime_type_cache
    else:
        base64_image, mime_type = encode_image(image_path)
        if not base64_image:
            return None
        # å¦‚æœ mime_type ä¸º Noneï¼Œä½¿ç”¨é»˜è®¤å€¼
        if not mime_type:
            mime_type = 'image/jpeg'

    # è·å–å¯¹åº”ç»„åˆçš„æç¤ºè¯æ¨¡æ¿ï¼ˆæ¯æ¬¡ç”Ÿæˆ1ä¸ªé—®é¢˜ï¼‰
    template_key = item_image_type.lower()
    # å¦‚æœå›¾ç‰‡ç±»å‹ä¸åœ¨æ”¯æŒçš„åˆ—è¡¨ä¸­ï¼ˆæ’é™¤"all"ï¼‰ï¼Œé»˜è®¤ä½¿ç”¨ mixed
    valid_image_types = [t for t in IMAGE_TYPES if t != "all"]
    if template_key not in valid_image_types:
        template_key = "mixed"  # é»˜è®¤ä½¿ç”¨ mixed
    
    question_type_key = question_type.lower()
    if question_type_key not in QUESTION_TYPES:
        question_type_key = "essay"
    
    # è·å–è½®æ•°ï¼ˆä»…ç”¨äºå¤šè½®å¯¹è¯é¢˜å‹ï¼‰
    rounds = GLOBAL_CONFIG["rounds"]
    
    # ä½¿ç”¨æ–°çš„æ¨¡æ¿æ„å»ºå‡½æ•°ï¼ˆæ¯æ¬¡åªç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼‰
    include_process = GLOBAL_CONFIG.get("include_process", True)
    prompt = get_prompt_template(template_key, question_type_key, rounds=rounds, include_process=include_process)

    # è·å–é…ç½®å‚æ•°ï¼ˆè¿™äº›keyåœ¨main()ä¸­å·²ç¡®ä¿å­˜åœ¨ï¼‰
    max_retries = int(GLOBAL_CONFIG["max_retries"])
    base_sleep = float(GLOBAL_CONFIG["retry_sleep"])
    timeout = float(GLOBAL_CONFIG["request_timeout"])

    for attempt in range(max_retries):
        try:
            # æ„å»º API è°ƒç”¨å‚æ•°
            api_params = {
                "model": GLOBAL_CONFIG["model_name"],
                "messages": [
                    {
                        "role": "user",
                        "content": [
                            {"type": "text", "text": prompt},
                            {"type": "image_url", "image_url": {"url": f"data:{mime_type};base64,{base64_image}"}},
                        ],
                    }
                ],
                "max_tokens": GLOBAL_CONFIG["max_tokens"],
                "temperature": GLOBAL_CONFIG["temperature"],
                "timeout": timeout,
            }
            
            # å¦‚æœå¯ç”¨æ€è€ƒæ¨¡å¼ï¼Œæ·»åŠ  extra_body
            if GLOBAL_CONFIG.get("enable_thinking", False):
                api_params["extra_body"] = {"enable_thinking": True}
            
            # æ€§èƒ½è¯Šæ–­ï¼šè®°å½•APIè°ƒç”¨æ—¶é—´
            api_start = time.time()
            response = client.chat.completions.create(**api_params)
            api_time = time.time() - api_start
            stage_times['api_call'] = api_time
            
            # è®°å½•æ¨¡å‹è¿”å›æ—¥å¿—ï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰
            if LOG_FILE:
                log_model_response(original_id, question_index, response, prompt, api_time)
            
            content = response.choices[0].message.content.strip() if response.choices[0].message.content else ""
            message = response.choices[0].message
            
            # ==================== æ™ºèƒ½æå– JSON å’Œæ€è€ƒå†…å®¹ ====================
            # æ ¸å¿ƒé€»è¾‘ï¼š
            # 1. ä¼˜å…ˆä» content ä¸­æå– JSONï¼ˆå¤§å¤šæ•°æ¨¡å‹éƒ½åœ¨è¿™é‡Œè¾“å‡ºï¼‰
            # 2. content ä¸­é™¤ JSON å¤–çš„éƒ¨åˆ†éƒ½å½“ä½œæ€è€ƒè¿‡ç¨‹
            # 3. å¦‚æœ content ä¸­æ²¡æœ‰ JSONï¼Œå†ä» reasoning_content ä¸­æå–
            # 4. åˆå¹¶æ‰€æœ‰æ€è€ƒå†…å®¹
            
            qa_data = None
            json_source = None
            thinking_parts = []  # å­˜å‚¨æ‰€æœ‰æ€è€ƒå†…å®¹
            
            # ğŸ“ è¾…åŠ©å‡½æ•°ï¼šä»æ–‡æœ¬ä¸­æå– JSONï¼ˆç»ˆæä¼˜åŒ–ç‰ˆï¼‰
            def extract_json_from_text(text, source_name):
                """
                ä»æ–‡æœ¬ä¸­æå– JSONï¼Œè¿”å› (json_data, before_text, after_text)
                json_data: è§£æåçš„ JSON å¯¹è±¡
                before_text: JSON å‰çš„æ–‡æœ¬ï¼ˆæ€è€ƒè¿‡ç¨‹ï¼‰
                after_text: JSON åçš„æ–‡æœ¬ï¼ˆæ€è€ƒè¿‡ç¨‹ï¼‰
                
                ä¼˜åŒ–ç­–ç•¥ï¼š
                1. æœ€ä¼˜å…ˆæ£€æµ‹thinkingæ¨¡å‹æ ¼å¼ï¼ˆ</think>æ ‡ç­¾ï¼‰- é›¶å¼€é”€æ£€æµ‹
                2. å¿«é€Ÿè·¯å¾„ï¼šç›´æ¥è§£æå¸¸è§æ ¼å¼
                3. é€šç”¨è·¯å¾„ï¼šæ­£åˆ™+æ ˆåŒ¹é…ï¼ˆä»…ä½œä¸ºfallbackï¼‰
                """
                if not text:
                    return None, "", ""
                
                # ğŸ”§ è¾…åŠ©å‡½æ•°ï¼šå¿«é€Ÿæ‰¾åˆ°JSONç»“æŸä½ç½®ï¼ˆä½¿ç”¨æ ˆåŒ¹é…ï¼Œå¿½ç•¥å­—ç¬¦ä¸²å†…éƒ¨ï¼‰
                def find_json_end_fast(s):
                    """å¿«é€Ÿæ‰¾åˆ°JSONå¯¹è±¡/æ•°ç»„çš„ç»“æŸä½ç½®ï¼ŒO(n)æ—¶é—´å¤æ‚åº¦"""
                    if not s or s[0] not in ['{', '[']:
                        return -1
                    
                    stack = [s[0]]
                    pairs = {'}': '{', ']': '['}
                    in_string = False
                    escape = False
                    
                    for i in range(1, len(s)):
                        c = s[i]
                        
                        if escape:
                            escape = False
                            continue
                        
                        if c == '\\':
                            escape = True
                            continue
                        
                        if c == '"':
                            in_string = not in_string
                            continue
                        
                        if in_string:
                            continue
                        
                        if c in ['{', '[']:
                            stack.append(c)
                        elif c in ['}', ']']:
                            if not stack or stack[-1] != pairs[c]:
                                return -1
                            stack.pop()
                            if not stack:
                                return i + 1
                    
                    return -1
                
                # ğŸš€ æ–¹æ³•0: Thinkingæ¨¡å‹ä¸“ç”¨ - è¶…å¿«é€Ÿæå–ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
                # æ ¼å¼ï¼šæ€è€ƒè¿‡ç¨‹</think>\nJSONå†…å®¹ï¼ˆæœ€å¸¸è§ï¼‰
                # æ£€æµ‹æˆæœ¬ï¼šO(n) å­ä¸²æŸ¥æ‰¾ï¼Œä½†é€šå¸¸å¾ˆå¿«å› ä¸º</think>åœ¨å‰åŠéƒ¨åˆ†
                think_end_pos = text.find("</think>")
                if think_end_pos != -1:
                    # æ‰¾åˆ°</think>æ ‡ç­¾ï¼Œç›´æ¥åˆ†å‰²ï¼ˆé›¶é¢å¤–å†…å­˜åˆ†é…ï¼‰
                    thinking = text[:think_end_pos].strip()
                    # ç§»é™¤å¯èƒ½çš„ <think> å¼€å¤´æ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼‰
                    if thinking.startswith("<think>"):
                        thinking = thinking[7:].strip()
                    
                    # JSONéƒ¨åˆ†ä»</think>åå¼€å§‹ï¼ˆ+8æ˜¯</think>çš„é•¿åº¦ï¼‰
                    json_start = think_end_pos + 8
                    json_part = text[json_start:].strip()
                    
                    # å¿«é€Ÿè·¯å¾„1ï¼šç›´æ¥æ˜¯JSONå¯¹è±¡/æ•°ç»„ï¼ˆæœ€å¸¸è§ï¼Œ80%+çš„æƒ…å†µï¼‰
                    if json_part and (json_part[0] == '{' or json_part[0] == '['):
                        # ä½¿ç”¨æ ˆå¿«é€Ÿæ‰¾åˆ°JSONç»“æŸä½ç½®
                        json_end = find_json_end_fast(json_part)
                        if json_end > 0:
                            json_str = json_part[:json_end]
                            try:
                                json_data = json.loads(json_str)
                                after = json_part[json_end:].strip()
                                return json_data, thinking, after
                            except:
                                pass  # è§£æå¤±è´¥ï¼Œç»§ç»­å°è¯•
                    
                    # å¿«é€Ÿè·¯å¾„2ï¼šåœ¨```jsonä»£ç å—ä¸­
                    json_marker = json_part.find("```json")
                    if json_marker != -1:
                        json_content_start = json_marker + 7  # len("```json")
                        json_content_end = json_part.find("```", json_content_start)
                        if json_content_end != -1:
                            json_str = json_part[json_content_start:json_content_end].strip()
                            try:
                                json_data = json.loads(json_str)
                                after = json_part[json_content_end + 3:].strip()
                                return json_data, thinking, after
                            except:
                                pass
                    
                    # å¿«é€Ÿè·¯å¾„3ï¼šåœ¨æ™®é€š```ä»£ç å—ä¸­
                    code_marker = json_part.find("```")
                    if code_marker != -1:
                        json_content_start = code_marker + 3
                        json_content_end = json_part.find("```", json_content_start)
                        if json_content_end != -1:
                            json_str = json_part[json_content_start:json_content_end].strip()
                            if json_str and (json_str[0] == '{' or json_str[0] == '['):
                                try:
                                    json_data = json.loads(json_str)
                                    after = json_part[json_content_end + 3:].strip()
                                    return json_data, thinking, after
                                except:
                                    pass
                    
                    # å¦‚æœå¿«é€Ÿè·¯å¾„éƒ½å¤±è´¥ï¼Œè¯´æ˜æ ¼å¼å¼‚å¸¸
                    # ä¸å†ç»§ç»­å°è¯•ï¼Œç›´æ¥è¿”å›Noneï¼ˆé¿å…æµªè´¹æ—¶é—´ï¼‰
                    return None, thinking, ""
                
                # æ–¹æ³•1: æå– ```json``` ä»£ç å—ï¼ˆæ¬¡ä¼˜å…ˆï¼‰
                json_marker = text.find("```json")
                if json_marker != -1:
                    before = text[:json_marker].strip()
                    json_content_start = json_marker + 7
                    json_content_end = text.find("```", json_content_start)
                    if json_content_end != -1:
                        json_str = text[json_content_start:json_content_end].strip()
                        after = text[json_content_end + 3:].strip()
                        try:
                            json_data = json.loads(json_str)
                            return json_data, before, after
                        except:
                            # ```json``` å­˜åœ¨ä½†è§£æå¤±è´¥ï¼Œç›´æ¥è¿”å›ï¼ˆä¸å†å°è¯•å…¶ä»–æ–¹æ³•ï¼‰
                            return None, before, after
                
                # æ–¹æ³•2: æå–æ™®é€š ``` ä»£ç å—
                code_marker = text.find("```")
                if code_marker != -1:
                    before = text[:code_marker].strip()
                    json_content_start = code_marker + 3
                    json_content_end = text.find("```", json_content_start)
                    if json_content_end != -1:
                        json_str = text[json_content_start:json_content_end].strip()
                        after = text[json_content_end + 3:].strip()
                        if json_str and (json_str[0] == '{' or json_str[0] == '['):
                            try:
                                json_data = json.loads(json_str)
                                return json_data, before, after
                            except:
                                pass
                
                # æ–¹æ³•3: ç›´æ¥è§£ææ•´ä¸ªæ–‡æœ¬ï¼ˆå¸¸è§äºçº¯JSONè¾“å‡ºï¼‰
                text_stripped = text.strip()
                if text_stripped and (text_stripped[0] == '{' or text_stripped[0] == '['):
                    try:
                        json_data = json.loads(text_stripped)
                        return json_data, "", ""
                    except:
                        # å¯èƒ½JSONåé¢æœ‰é¢å¤–å†…å®¹ï¼Œä½¿ç”¨æ ˆåŒ¹é…
                        json_end = find_json_end_fast(text_stripped)
                        if json_end > 0:
                            json_str = text_stripped[:json_end]
                            after = text_stripped[json_end:].strip()
                            try:
                                json_data = json.loads(json_str)
                                return json_data, "", after
                            except:
                                pass
                
                # æ–¹æ³•4: æŸ¥æ‰¾æ–‡æœ¬ä¸­çš„JSONï¼ˆæœ€æ…¢ï¼Œä»…ä½œä¸ºfallbackï¼‰
                for i, char in enumerate(text):
                    if char in ['{', '[']:
                        json_end = find_json_end_fast(text[i:])
                        if json_end > 0:
                            before = text[:i].strip()
                            json_str = text[i:i+json_end]
                            after = text[i+json_end:].strip()
                            try:
                                json_data = json.loads(json_str)
                                return json_data, before, after
                            except:
                                continue
                
                # æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥
                return None, "", ""
            
            # æ€§èƒ½è¯Šæ–­ï¼šè®°å½•JSONæå–æ—¶é—´
            extract_start = time.time()
            
            # ğŸ” æ­¥éª¤1: ä¼˜å…ˆä» content ä¸­æå– JSON
            if content:
                json_data_temp, before_text, after_text = extract_json_from_text(content, "content")
                
                if json_data_temp is not None:
                    qa_data = json_data_temp
                    json_source = "content"
                    
                    # content ä¸­ JSON å‰åçš„æ–‡æœ¬éƒ½æ˜¯æ€è€ƒè¿‡ç¨‹
                    if before_text:
                        thinking_parts.append(("contentå‰æ®µ", before_text))
                    if after_text:
                        thinking_parts.append(("contentåæ®µ", after_text))
                else:
                    # å¦‚æœ content æ•´ä½“ä¸æ˜¯ JSONï¼Œå…¨éƒ¨ä½œä¸ºæ€è€ƒè¿‡ç¨‹
                    if content:
                        thinking_parts.append(("contentå…¨æ–‡", content))
            
            # ğŸ“ è¾…åŠ©å‡½æ•°ï¼šè·å– reasoning_content å­—æ®µï¼ˆé™é»˜æ¨¡å¼ï¼‰
            def get_reasoning_content():
                """ä» response å¯¹è±¡çš„å¤šä¸ªå¯èƒ½ä½ç½®è·å– reasoning_content"""
                if hasattr(message, 'reasoning_content') and message.reasoning_content:
                    return message.reasoning_content.strip()
                elif hasattr(response, 'reasoning_content') and response.reasoning_content:
                    return response.reasoning_content.strip()
                elif hasattr(message, 'reasoning') and message.reasoning:
                    return message.reasoning.strip()
                elif hasattr(response, 'reasoning') and response.reasoning:
                    return response.reasoning.strip()
                return None
            
            # ğŸ” æ­¥éª¤2: å¦‚æœ content ä¸­æ²¡æ‰¾åˆ° JSONï¼Œå†ä» reasoning_content ä¸­æ‰¾
            if qa_data is None:
                reasoning_content = get_reasoning_content()
                
                if reasoning_content:
                    json_data_temp, before_text, after_text = extract_json_from_text(reasoning_content, "reasoning_content")
                    
                    if json_data_temp is not None:
                        qa_data = json_data_temp
                        json_source = "reasoning_content"
                        
                        # reasoning_content ä¸­ JSON å‰åçš„æ–‡æœ¬éƒ½æ˜¯æ€è€ƒè¿‡ç¨‹
                        if before_text:
                            thinking_parts.append(("reasoningå‰æ®µ", before_text))
                        if after_text:
                            thinking_parts.append(("reasoningåæ®µ", after_text))
                    else:
                        # å¦‚æœ reasoning_content æ•´ä½“ä¸æ˜¯ JSONï¼Œå…¨éƒ¨ä½œä¸ºæ€è€ƒè¿‡ç¨‹
                        thinking_parts.append(("reasoningå…¨æ–‡", reasoning_content))
            else:
                # å¦‚æœå·²ç»ä» content ä¸­æå–åˆ°äº† JSONï¼Œä½†ä¹Ÿæœ‰ reasoning_contentï¼Œ
                # åˆ™å°† reasoning_content å…¨éƒ¨ä½œä¸ºæ€è€ƒè¿‡ç¨‹
                reasoning_content = get_reasoning_content()
                
                if reasoning_content:
                    thinking_parts.append(("reasoningå­—æ®µ", reasoning_content))
            
            # ğŸ” æ­¥éª¤3: å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ° JSONï¼ŒæŠ¥é”™
            if qa_data is None:
                error_msg = "æ— æ³•ä» content æˆ– reasoning_content ä¸­æå– JSON æ ¼å¼çš„é—®ç­”æ•°æ®"
                if content:
                    error_msg += f"\ncontent å†…å®¹: {content[:200]}..."
                if thinking_parts:
                    error_msg += f"\næ‰¾åˆ° {len(thinking_parts)} æ®µæ€è€ƒå†…å®¹ï¼Œä½†æ²¡æœ‰ JSON"
                raise ValueError(error_msg)
            
            # ğŸ“¦ æ­¥éª¤4: åˆå¹¶æ‰€æœ‰æ€è€ƒå†…å®¹
            final_reasoning_content = ""
            if thinking_parts:
                formatted_parts = []
                for label, text in thinking_parts:
                    formatted_parts.append(f"ã€{label}ã€‘\n{text}")
                final_reasoning_content = "\n\n".join(formatted_parts)
            
            # æ€§èƒ½ç»Ÿè®¡
            extract_time = time.time() - extract_start
            stage_times['json_extract'] = extract_time
            
            # 7ï¸âƒ£ ç»Ÿä¸€å¤„ç†ï¼šå¦‚æœæ˜¯æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ªï¼›å¦‚æœæ˜¯å¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨
            if isinstance(qa_data, list):
                if len(qa_data) > 0:
                    qa_data = qa_data[0]  # å–ç¬¬ä¸€ä¸ª
                else:
                    raise ValueError("è¿”å›çš„ JSON æ•°ç»„ä¸ºç©º")
            elif isinstance(qa_data, dict):
                pass  # å¯¹è±¡æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
            else:
                raise ValueError(f"æ— æ³•è¯†åˆ«çš„ JSON æ ¼å¼: {type(qa_data)}")

            # åˆ¤æ–­æ˜¯å¦ä¸ºå¤šè½®å¯¹è¯é¢˜å‹
            is_multi_round = "multi_round" in question_type_key
            
            if is_multi_round:
                # å¤šè½®å¯¹è¯ï¼šä¸€æ¬¡æ€§æå–æ‰€æœ‰å­—æ®µï¼ˆå‡å°‘å­—å…¸è®¿é—®ï¼‰
                question_dict = qa_data.get("question", {})
                options_dict = qa_data.get("options", {})
                answer_dict = qa_data.get("answer", {})
                process_dict = qa_data.get("qa_make_process") or qa_data.get("process", {})
                question_type_text = qa_data.get("question_type", "é—®ç­”é¢˜")
                
                # å¦‚æœå¯ç”¨äº†æ€è€ƒæ¨¡å¼ä¸”æœ‰æ¨ç†å†…å®¹ï¼Œåˆå¹¶åˆ°æ¯è½®çš„ qa_make_process
                include_process = GLOBAL_CONFIG.get("include_process", True)
                if include_process:
                    if GLOBAL_CONFIG.get("enable_thinking", False) and final_reasoning_content:
                        if not isinstance(process_dict, dict):
                            process_dict = {}
                        
                        rounds = GLOBAL_CONFIG["rounds"]
                        thinking_prefix = f"ã€æ¨¡å‹æ€è€ƒæ¨ç†è¿‡ç¨‹ã€‘\n{final_reasoning_content}"
                        
                        # æ‰¹é‡å¤„ç†æ‰€æœ‰è½®æ¬¡ï¼ˆé¿å…é‡å¤å­—ç¬¦ä¸²æ‹¼æ¥ï¼‰
                        for i in range(rounds):
                            round_key = f"round{i+1}"
                            round_process = process_dict.get(round_key, "")
                            process_dict[round_key] = f"{thinking_prefix}\n\nã€é—®é¢˜è§£ç­”è¿‡ç¨‹ã€‘\n{round_process}" if round_process else thinking_prefix
                    elif not isinstance(process_dict, dict):
                        process_dict = {f"round{i+1}": "" for i in range(GLOBAL_CONFIG["rounds"])}
                
                new_item = {
                    "image_id": str(original_id),
                    "image_path": image_path,
                    "image_type": item_image_type,
                    "question_id": f"{original_id}_{question_type}_{question_index}",
                    "question_type": QUESTION_TYPES.get(question_type_key, question_type_text),
                    "question": question_dict,
                    "options": options_dict or None,
                    "answer": answer_dict,
                }
                # åªæœ‰åœ¨éœ€è¦æ—¶æ‰æ·»åŠ  qa_make_process å­—æ®µ
                if include_process:
                    new_item["qa_make_process"] = process_dict if isinstance(process_dict, dict) else ""
            else:
                # å•è½®å¯¹è¯ï¼šä¿æŒåŸæœ‰æ ¼å¼
                # ä¼˜åŒ–ï¼šä¸€æ¬¡æ€§æå–æ‰€æœ‰éœ€è¦çš„å­—æ®µï¼Œå‡å°‘å­—å…¸è®¿é—®
                process_from_qa = qa_data.get("qa_make_process") or qa_data.get("process", "")
                question_text = qa_data.get("question", "")
                options_data = qa_data.get("options")
                answer_text = qa_data.get("answer", "")
                question_type_text = qa_data.get("question_type", "é—®ç­”é¢˜")
                
                # å¦‚æœå¯ç”¨äº†æ€è€ƒæ¨¡å¼ä¸”æœ‰æ¨ç†å†…å®¹ï¼Œåˆå¹¶åˆ° qa_make_process
                include_process = GLOBAL_CONFIG.get("include_process", True)
                if include_process:
                    if GLOBAL_CONFIG.get("enable_thinking", False) and final_reasoning_content:
                        qa_make_process = f"ã€æ¨¡å‹æ€è€ƒæ¨ç†è¿‡ç¨‹ã€‘\n{final_reasoning_content}\n\nã€é—®é¢˜è§£ç­”è¿‡ç¨‹ã€‘\n{process_from_qa}" if process_from_qa else f"ã€æ¨¡å‹æ€è€ƒæ¨ç†è¿‡ç¨‹ã€‘\n{final_reasoning_content}"
                    else:
                        qa_make_process = process_from_qa
                
                new_item = {
                    "image_id": str(original_id),
                    "image_path": image_path,
                    "image_type": item_image_type,
                    "question_id": f"{original_id}_{question_type}_{question_index}",
                    "question_type": QUESTION_TYPES.get(question_type_key, question_type_text),
                    "question": question_text,
                    "options": options_data,
                    "answer": answer_text,
                }
                # åªæœ‰åœ¨éœ€è¦æ—¶æ‰æ·»åŠ  qa_make_process å­—æ®µ
                if include_process:
                    new_item["qa_make_process"] = qa_make_process
            
            # æ‰“å°æ¯é“é¢˜çš„APIè€—æ—¶å’ŒTokenä¿¡æ¯
            api_time = stage_times.get('api_call', 0)
            
            # è·å–tokenä½¿ç”¨ä¿¡æ¯
            if hasattr(response, 'usage') and response.usage:
                prompt_tokens = getattr(response.usage, 'prompt_tokens', 0)
                completion_tokens = getattr(response.usage, 'completion_tokens', 0)
                total_tokens = getattr(response.usage, 'total_tokens', 0)
                print(f"âœ… [Q{question_index+1}] image_id={original_id} | APIè€—æ—¶:{api_time:.2f}s | Token: è¾“å…¥{prompt_tokens} + è¾“å‡º{completion_tokens} = {total_tokens}")
            else:
                print(f"âœ… [Q{question_index+1}] image_id={original_id} | APIè€—æ—¶:{api_time:.2f}s | Token: N/A")
            
            return new_item

        except Exception as e:
            # è·å–ç®€è¦é”™è¯¯ä¿¡æ¯ï¼ˆåªå–ç¬¬ä¸€è¡Œï¼‰
            error_msg = str(e).split('\n')[0][:100]  # é™åˆ¶é•¿åº¦
            
            # å¦‚æœè¿˜æœ‰é‡è¯•æœºä¼šï¼Œåˆ™ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
            if attempt < max_retries - 1:
                sleep_seconds = base_sleep * (2 ** attempt)
                print(f"âš ï¸ [Q{question_index+1}] image_id={original_id} | å¤±è´¥(å°è¯•{attempt + 1}/{max_retries}): {error_msg} | {sleep_seconds:.1f}såé‡è¯•")
                try:
                    time.sleep(sleep_seconds)
                except Exception:
                    pass
            else:
                print(f"âŒ [Q{question_index+1}] image_id={original_id} | å¤±è´¥(å·²é‡è¯•{max_retries}æ¬¡): {error_msg}")
                return None


def generate_qa_data(item, image_type, question_type):
    """
    è¾“å…¥: 
        - item: å•ä¸ªå›¾ç‰‡ä¿¡æ¯
        - image_type: å›¾ç‰‡ç±»å‹ (pure_image, pure_text, mixed, splice)
        - question_type: é—®é¢˜ç±»å‹ (single_choice, multiple_choice, true_false, essay)
    è¾“å‡º: ä¸€ä¸ª List (ç”Ÿæˆçš„ N ä¸ªé—®ç­”å¯¹)
    
    æ³¨æ„ï¼šç°åœ¨æ˜¯å¤šæ¬¡å¯¹è¯ï¼Œæ¯æ¬¡ç”Ÿæˆä¸€ä¸ªé—®é¢˜
    ä¼˜åŒ–ï¼šå›¾ç‰‡åªç¼–ç ä¸€æ¬¡ï¼Œé¿å…é‡å¤ I/O æ“ä½œ
    """
    count = GLOBAL_CONFIG["questions_per_image"]
    generated_items = []
    
    image_id = str(item.get("id", "unknown"))
    image_path = item.get("image_path")
    
    # ä¼˜åŒ–ï¼šåªç¼–ç ä¸€æ¬¡å›¾ç‰‡ï¼Œé¿å…é‡å¤ I/Oï¼ˆå½“æ¯å¼ å›¾ç”Ÿæˆå¤šä¸ªé—®é¢˜æ—¶ï¼‰
    base64_image, mime_type = encode_image(image_path)
    if not base64_image:
        print(f"âŒ [å›¾ç‰‡] image_id={image_id} | å›¾ç‰‡ç¼–ç å¤±è´¥: {image_path}")
        return []
    
    # å¦‚æœ mime_type ä¸º Noneï¼Œä½¿ç”¨é»˜è®¤å€¼
    if not mime_type:
        mime_type = 'image/jpeg'
    
    # å¤šæ¬¡å¯¹è¯ï¼Œæ¯æ¬¡ç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼ˆå¤ç”¨å·²ç¼–ç çš„å›¾ç‰‡ï¼‰
    for question_index in range(count):
        qa_item = generate_single_qa(
            item, 
            image_type, 
            question_type, 
            question_index, 
            count,
            base64_image_cache=base64_image,
            mime_type_cache=mime_type
        )
        if qa_item:
            generated_items.append(qa_item)
        # å¤±è´¥ä¿¡æ¯å·²ç»åœ¨ generate_single_qa ä¸­è¾“å‡ºäº†ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤
    
    return generated_items

def worker(item, total_images=0):
    """çº¿ç¨‹å·¥ä½œå•å…ƒï¼ˆä¼˜åŒ–ç‰ˆï¼šå‡å°‘é”ç«äº‰ï¼‰"""
    global CURRENT_IMAGE_TYPE, CURRENT_QUESTION_TYPE, progress_bar, OUTPUT_FORMAT, shutdown_event
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦å…³é—­
    if shutdown_event.is_set():
        return
    
    image_id = str(item.get("id", "unknown"))
    image_path = item.get("image_path", "")
    expected_count = GLOBAL_CONFIG["questions_per_image"]
    
    results = generate_qa_data(item, CURRENT_IMAGE_TYPE, CURRENT_QUESTION_TYPE)
    
    # å†æ¬¡æ£€æŸ¥æ˜¯å¦éœ€è¦å…³é—­ï¼ˆå¤„ç†è¿‡ç¨‹ä¸­å¯èƒ½æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼‰
    if shutdown_event.is_set():
        # å¦‚æœä½¿ç”¨ JSON æ ¼å¼ï¼Œéœ€è¦ä¿å­˜å½“å‰ç»“æœåˆ° bufferï¼ˆä¼šåœ¨ä¿¡å·å¤„ç†ä¸­ç»Ÿä¸€ä¿å­˜ï¼‰
        if OUTPUT_FORMAT == "json" and results:
            with buffer_lock:
                result_buffer.extend(results)
        return
    
    # ä¼˜åŒ–ï¼šåˆå¹¶é”æ“ä½œï¼Œå‡å°‘é”è·å–æ¬¡æ•°
    need_flush = False
    
    if results:
        # æ£€æŸ¥æ˜¯å¦æœ‰éƒ¨åˆ†å¤±è´¥
        actual_count = len(results)
        if actual_count < expected_count:
            print(f"âš ï¸ [å›¾ç‰‡] image_id={image_id} | éƒ¨åˆ†æˆåŠŸ: {actual_count}/{expected_count}é¢˜")
        
        # JSONL æ ¼å¼ï¼šå®æ—¶å†™å…¥æ¯æ¡ç»“æœ
        # JSON æ ¼å¼ï¼šæ”¾å…¥ bufferï¼Œè¾¾åˆ° batch_size æ—¶æ‰¹é‡å†™å…¥
        if OUTPUT_FORMAT == "jsonl":
            # JSONLï¼šæ¯æ¡å®æ—¶å†™å…¥
            for result_item in results:
                write_jsonl_item(result_item)
            
            # æ›´æ–°ç»Ÿè®¡ï¼ˆä¸éœ€è¦ bufferï¼‰
            with buffer_lock:
                stats["success"] += len(results)
                stats["questions_generated"] += len(results)
                stats["images_processed"] += 1
                stats["images_success"] += 1
        else:
            # JSONï¼šä½¿ç”¨ buffer æ‰¹é‡å†™å…¥
            with buffer_lock:
                result_buffer.extend(results)
                stats["success"] += len(results)
                stats["questions_generated"] += len(results)
                stats["images_processed"] += 1
                stats["images_success"] += 1
                
                if len(result_buffer) >= GLOBAL_CONFIG["batch_size"]:
                    need_flush = True
            
            if need_flush:
                flush_buffer()
        
        # æ¯å¼ å›¾ç‰‡å¤„ç†å®Œéƒ½æ›´æ–°è¿›åº¦æ¡
        if progress_bar:
            with progress_lock:
                progress_bar.update(1)
                progress_bar.set_postfix({
                    "æˆåŠŸ": stats['images_success'],
                    "å¤±è´¥": stats['images_failed'],
                    "é¢˜æ•°": stats['questions_generated']
                })
    else:
        # æ•´å¼ å›¾ç‰‡æ‰€æœ‰é—®é¢˜éƒ½å¤±è´¥
        print(f"âŒ [å›¾ç‰‡] image_id={image_id} | æ‰€æœ‰é—®é¢˜ç”Ÿæˆå¤±è´¥({expected_count}/{expected_count})")
        
        with buffer_lock:
            stats["failed"] += 1
            stats["images_failed"] += 1
            stats["images_processed"] += 1
        
        # æ¯å¼ å›¾ç‰‡å¤„ç†å®Œéƒ½æ›´æ–°è¿›åº¦æ¡
        if progress_bar:
            with progress_lock:
                progress_bar.update(1)
                progress_bar.set_postfix({
                    "æˆåŠŸ": stats['images_success'],
                    "å¤±è´¥": stats['images_failed'],
                    "é¢˜æ•°": stats['questions_generated']
                })

# ==============================================================================
# ğŸš€ ä¸»ç¨‹åº
# ==============================================================================
##æ·»åŠ æ–°é¢˜å‹å’Œå›¾ç‰‡ç±»å‹ï¼Œè¿™é‡Œé¢è¦åŠ 
def main():
    global client, OUTPUT_PATH, CURRENT_IMAGE_TYPE, CURRENT_QUESTION_TYPE
    
    parser = argparse.ArgumentParser(description="é—®é¢˜ç”Ÿæˆæ¨¡å— - æ ¹æ® image_type å’Œ question_type ç”Ÿæˆé¢˜ç›®")
    parser.add_argument("--input", required=True, help="è¾“å…¥JSONæ–‡ä»¶è·¯å¾„")
    parser.add_argument("--output", required=True, help="è¾“å‡ºJSONæ–‡ä»¶è·¯å¾„")
    parser.add_argument("--image_type", default="mixed", choices=IMAGE_TYPES, 
                       help="å›¾ç‰‡ç±»å‹: pure_image, pure_text, mixed, splice, all (allè¡¨ç¤ºå¤„ç†æ‰€æœ‰ç±»å‹ï¼Œä¸ç­›é€‰)")
    parser.add_argument("--question_type", default="essay", 
                       choices=["single_choice", "multiple_choice", "true_false", "essay", "multi_round_single_choice", "multi_round_essay"],
                       help="é—®é¢˜ç±»å‹: single_choice(å››é€‰å•é€‰), multiple_choice(å››é€‰å¤šé€‰), true_false(åˆ¤æ–­é¢˜), essay(é—®ç­”é¢˜), multi_round_single_choice(å¤šè½®å•é€‰é¢˜), multi_round_essay(å¤šè½®é—®ç­”é¢˜)")
    parser.add_argument("--num", type=int, default=GLOBAL_CONFIG["questions_per_image"], 
                       help=f"æ¯å¼ å›¾ç‰‡ç”Ÿæˆçš„é—®é¢˜æ•°é‡ï¼ˆé»˜è®¤: {GLOBAL_CONFIG['questions_per_image']}ï¼‰")
    parser.add_argument("--rounds", type=int, default=GLOBAL_CONFIG["rounds"], 
                       help=f"å¤šè½®å¯¹è¯çš„è½®æ•°ï¼ˆä»…ç”¨äºå¤šè½®å¯¹è¯é¢˜å‹ï¼Œé»˜è®¤{GLOBAL_CONFIG['rounds']}è½®ï¼‰")
    parser.add_argument("--resume", action="store_true", help="æ–­ç‚¹ç»­ä¼ ")
    parser.add_argument("--limit", type=int, default=None, help="é™åˆ¶å¤„ç†çš„å›¾ç‰‡æ•°é‡")
    parser.add_argument("--random", action="store_true",
                       help="éšæœºé€‰æ‹©æ ·æœ¬ï¼šå¦‚æœè®¾ç½®äº† --limitï¼Œåˆ™éšæœºé€‰æ‹© N ä¸ªï¼›å¦åˆ™éšæœºæ‰“ä¹±é¡ºåº")
    parser.add_argument("--seed", type=int, default=None,
                       help="éšæœºç§å­ï¼šç”¨äºå¯å¤ç°çš„éšæœºé€‰æ‹©ï¼ˆä»…å½“ --random å¯ç”¨æ—¶æœ‰æ•ˆï¼‰")
    
    # API Params (é»˜è®¤å€¼å¼•ç”¨ GLOBAL_CONFIGï¼Œç»Ÿä¸€é…ç½®ç®¡ç†)
    parser.add_argument("--api_base", default="http://localhost:22002/v1")
    parser.add_argument("--api_key", default="EMPTY")
    parser.add_argument("--model", default="Qwen3-VL-235B")
    parser.add_argument("--temp", type=float, default=GLOBAL_CONFIG["temperature"],
                       help=f"æ¸©åº¦å‚æ•°ï¼ˆé»˜è®¤: {GLOBAL_CONFIG['temperature']}ï¼‰")
    parser.add_argument("--tokens", type=int, default=GLOBAL_CONFIG["max_tokens"],
                       help=f"æœ€å¤§Tokenæ•°ï¼ˆé»˜è®¤: {GLOBAL_CONFIG['max_tokens']}ï¼‰")
    parser.add_argument("--batch", type=int, default=GLOBAL_CONFIG["batch_size"],
                       help=f"jsonæ‰¹é‡å†™å…¥å¤§å°ï¼ˆé»˜è®¤: {GLOBAL_CONFIG['batch_size']}ï¼‰")
    parser.add_argument("--workers", type=int, default=GLOBAL_CONFIG["max_workers"],
                       help=f"å¹¶å‘çº¿ç¨‹æ•°ï¼ˆé»˜è®¤: {GLOBAL_CONFIG['max_workers']}ï¼‰")
    parser.add_argument("--enable_thinking", action="store_true", 
                       help="å¯ç”¨æ€è€ƒæ¨¡å¼ï¼ˆä¼šæå– reasoning_content å¹¶åˆå¹¶åˆ° qa_make_processï¼‰")
    parser.add_argument("--timeout", type=float, default=GLOBAL_CONFIG["request_timeout"],
                       help=f"å•æ¬¡è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤{GLOBAL_CONFIG['request_timeout']}s")
    parser.add_argument("--retries", type=int, default=GLOBAL_CONFIG["max_retries"],
                       help=f"è¯·æ±‚å¤±è´¥æ—¶çš„æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤{GLOBAL_CONFIG['max_retries']}æ¬¡")
    parser.add_argument("--retry_sleep", type=float, default=GLOBAL_CONFIG["retry_sleep"],
                       help=f"è¯·æ±‚å¤±è´¥åçš„åŸºç¡€é‡è¯•é—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤{GLOBAL_CONFIG['retry_sleep']}sï¼Œåç»­æŒ‰æŒ‡æ•°é€€é¿")
    parser.add_argument("--log_dir", type=str, default="./logs", 
                       help="æ—¥å¿—æ–‡ä»¶ä¿å­˜ç›®å½•ï¼ˆé»˜è®¤: ./logsï¼‰")
    parser.add_argument("--log_mode", type=str, default="simple", choices=["simple", "detailed"],
                       help="æ—¥å¿—æ¨¡å¼: simple(ç®€åŒ–ï¼Œåªè®°å½•å…³é”®ä¿¡æ¯+tokenæ•°) æˆ– detailed(è¯¦ç»†ï¼Œè®°å½•å®Œæ•´å“åº”)")
    parser.add_argument("--no_process", action="store_true",
                       help="ä¸ç”Ÿæˆ qa_make_process å­—æ®µï¼ˆæ¨ç†è¿‡ç¨‹ï¼‰ï¼Œåªç”Ÿæˆé—®é¢˜ã€é€‰é¡¹å’Œç­”æ¡ˆ")
    
    args = parser.parse_args()

    # æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°ï¼ˆå¤„ç† Ctrl+C å’Œ SIGTERMï¼‰
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    # æ³¨å…¥é…ç½®
    GLOBAL_CONFIG["api_base"] = args.api_base
    GLOBAL_CONFIG["api_key"] = args.api_key
    GLOBAL_CONFIG["model_name"] = args.model
    GLOBAL_CONFIG["temperature"] = args.temp
    GLOBAL_CONFIG["max_tokens"] = args.tokens
    GLOBAL_CONFIG["batch_size"] = args.batch
    GLOBAL_CONFIG["max_workers"] = args.workers
    GLOBAL_CONFIG["questions_per_image"] = args.num
    GLOBAL_CONFIG["enable_thinking"] = args.enable_thinking
    GLOBAL_CONFIG["rounds"] = args.rounds
    GLOBAL_CONFIG["request_timeout"] = args.timeout
    GLOBAL_CONFIG["max_retries"] = args.retries
    GLOBAL_CONFIG["retry_sleep"] = args.retry_sleep
    GLOBAL_CONFIG["log_mode"] = args.log_mode
    GLOBAL_CONFIG["include_process"] = not args.no_process  # å¦‚æœè®¾ç½®äº† --no_processï¼Œåˆ™ include_process ä¸º False
    
    CURRENT_IMAGE_TYPE = args.image_type
    CURRENT_QUESTION_TYPE = args.question_type
    client = OpenAI(api_key=GLOBAL_CONFIG["api_key"], base_url=GLOBAL_CONFIG["api_base"])
    
    # åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶
    log_path = init_log_file(args.log_dir, args)
    print(f"ğŸ“ [æ—¥å¿—] æ—¥å¿—æ–‡ä»¶: {log_path}")
    print(f"ğŸ“ [æ—¥å¿—æ¨¡å¼] {'ğŸ“‹ è¯¦ç»†æ¨¡å¼(å®Œæ•´å“åº”)' if args.log_mode == 'detailed' else 'âš¡ ç®€åŒ–æ¨¡å¼(å…³é”®ä¿¡æ¯+token)'}")
    
    if args.enable_thinking:
        print("ğŸ§  [é…ç½®] å·²å¯ç”¨æ€è€ƒæ¨¡å¼ (enable_thinking=True)")
    
    if "multi_round" in args.question_type:
        print(f"ğŸ”„ [é…ç½®] å¤šè½®å¯¹è¯é¢˜å‹ï¼Œè½®æ•°: {args.rounds}")

    # è·¯å¾„ä¸æ–­ç‚¹ç»­ä¼ 
    if args.resume:
        OUTPUT_PATH = args.output
        print(f"ğŸ”„ [æ–­ç‚¹ç»­ä¼ ] {OUTPUT_PATH}")
    else:
        OUTPUT_PATH = get_next_version_path(args.output)
        print(f"ğŸ†• [å…¨æ–°è¿è¡Œ] {OUTPUT_PATH}")
    
    # æ ¹æ®æ–‡ä»¶æ‰©å±•åè‡ªåŠ¨åˆ¤æ–­è¾“å‡ºæ ¼å¼
    global OUTPUT_FORMAT
    if OUTPUT_PATH.lower().endswith('.jsonl'):
        OUTPUT_FORMAT = "jsonl"
        print(f"ğŸ“ [æ ¼å¼] æ£€æµ‹åˆ° .jsonl æ‰©å±•åï¼Œä½¿ç”¨ JSONL æ ¼å¼ï¼ˆå®æ—¶é€è¡Œè¿½åŠ å†™å…¥ï¼‰")
        print(f"   ğŸ’¡ JSONL æ ¼å¼ä¼˜åŠ¿ï¼šæ¯æ¡ç»“æœå®æ—¶å†™å…¥ï¼Œæ— éœ€bufferï¼Œbatchå‚æ•°ä¸ç”Ÿæ•ˆ")
        # å¦‚æœæ˜¯å…¨æ–°è¿è¡Œä¸”æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ¸…ç©ºæ–‡ä»¶ï¼ˆJSONL è¿½åŠ æ¨¡å¼éœ€è¦ï¼‰
        if not args.resume and os.path.exists(OUTPUT_PATH):
            with open(OUTPUT_PATH, "w", encoding="utf-8") as f:
                pass  # æ¸…ç©ºæ–‡ä»¶
    else:
        OUTPUT_FORMAT = "json"
        print(f"ğŸ“ [æ ¼å¼] ä½¿ç”¨ JSON æ ¼å¼ï¼ˆæ‰¹é‡ä¿å­˜ï¼Œbatch={GLOBAL_CONFIG['batch_size']}ï¼‰")
        print(f"   ğŸ’¡ æç¤ºï¼šå¦‚éœ€å¤„ç†å¤§é‡æ•°æ®ï¼Œå»ºè®®ä½¿ç”¨ .jsonl æ ¼å¼ï¼ˆé€è¡Œè¿½åŠ ï¼Œæ€§èƒ½æ›´å¥½ï¼‰")

    if not os.path.exists(args.input):
        print(f"âŒ è¾“å…¥ä¸å­˜åœ¨: {args.input}")
        return
    
    # æ ¹æ®æ–‡ä»¶æ‰©å±•åè‡ªåŠ¨åˆ¤æ–­è¾“å…¥æ ¼å¼
    input_format = "jsonl" if args.input.lower().endswith('.jsonl') else "json"
    
    if input_format == "jsonl":
        # JSONL æ ¼å¼ï¼šé€è¡Œè¯»å–
        print(f"ğŸ“¥ [è¾“å…¥æ ¼å¼] æ£€æµ‹åˆ° .jsonl æ‰©å±•åï¼Œä½¿ç”¨ JSONL æ ¼å¼è¯»å–")
        input_data = []
        with open(args.input, "r", encoding="utf-8") as f:
            for line_num, line in enumerate(f, 1):
                line = line.strip()
                if not line:
                    continue
                try:
                    item = json.loads(line)
                    input_data.append(item)
                except json.JSONDecodeError as e:
                    print(f"âš ï¸ è­¦å‘Šï¼šç¬¬ {line_num} è¡ŒJSONè§£æå¤±è´¥: {e}ï¼Œè·³è¿‡")
                    continue
        print(f"ğŸ“¥ [è¾“å…¥] ä» JSONL æ–‡ä»¶è¯»å–åˆ° {len(input_data)} æ¡æ•°æ®")
    else:
        # JSON æ ¼å¼ï¼šæ ‡å‡†è¯»å–
        print(f"ğŸ“¥ [è¾“å…¥æ ¼å¼] ä½¿ç”¨ JSON æ ¼å¼è¯»å–")
        with open(args.input, "r", encoding="utf-8") as f:
            input_data = json.load(f)
        # å¤„ç†ä¸åŒçš„ JSON ç»“æ„
        if isinstance(input_data, dict) and "items" in input_data:
            input_data = input_data["items"]
        elif not isinstance(input_data, list):
            print(f"âŒ é”™è¯¯ï¼šè¾“å…¥ JSON æ ¼å¼ä¸æ­£ç¡®ï¼ŒæœŸæœ›æ•°ç»„æˆ–åŒ…å« 'items' å­—æ®µçš„å¯¹è±¡")
            return
        print(f"ğŸ“¥ [è¾“å…¥] ä» JSON æ–‡ä»¶è¯»å–åˆ° {len(input_data)} æ¡æ•°æ®")

    # è‡ªåŠ¨åˆ›å»ºçˆ¶ç›®å½•
    output_dir = os.path.dirname(OUTPUT_PATH)
    if output_dir and not os.path.exists(output_dir):
        try:
            os.makedirs(output_dir, exist_ok=True)
            print(f"ğŸ“ è‡ªåŠ¨åˆ›å»ºç¼ºå¤±çš„ç›®å½•: {output_dir}")
        except Exception as e:
            print(f"âŒ æ— æ³•åˆ›å»ºç›®å½•: {e}")
            return

    # æ–­ç‚¹ç»­ä¼ ï¼šè¯»å–å·²å¤„ç†çš„å›¾ç‰‡IDï¼ˆåŸºäº image_id åˆ¤æ–­ï¼Œæ”¯æŒ JSON å’Œ JSONLï¼‰
    processed_ids = set()
    if args.resume and os.path.exists(OUTPUT_PATH):
        try:
            if OUTPUT_FORMAT == "jsonl":
                # JSONL æ ¼å¼ï¼šé€è¡Œè¯»å–
                with open(OUTPUT_PATH, "r", encoding="utf-8") as f:
                    for line in f:
                        line = line.strip()
                        if not line:
                            continue
                        try:
                            x = json.loads(line)
                            # image_id ç°åœ¨ç›´æ¥å°±æ˜¯åŸå§‹IDï¼Œä¸éœ€è¦åˆ†å‰²
                            # å…¼å®¹æ—§æ ¼å¼ï¼šå¦‚æœå­˜åœ¨ id å­—æ®µä¹Ÿæ”¯æŒï¼ˆæ—§æ ¼å¼å¯èƒ½æ˜¯ "orig_id_index"ï¼‰
                            image_id = str(x.get("image_id", ""))
                            if not image_id:
                                # å…¼å®¹æ—§æ ¼å¼ï¼šä» id å­—æ®µæå–ï¼ˆæ ¼å¼å¯èƒ½æ˜¯ "orig_id_index"ï¼‰
                                old_id = str(x.get("id", ""))
                                if "_" in old_id:
                                    parts = old_id.rsplit("_", 1)
                                    image_id = parts[0]
                                else:
                                    image_id = old_id
                            if image_id:
                                processed_ids.add(image_id)
                        except json.JSONDecodeError:
                            continue  # è·³è¿‡æ— æ•ˆè¡Œ
            else:
                # JSON æ ¼å¼ï¼šæ ‡å‡†è¯»å–
                with open(OUTPUT_PATH, "r", encoding="utf-8") as f:
                    existing = json.load(f)
                    for x in existing:
                        # image_id ç°åœ¨ç›´æ¥å°±æ˜¯åŸå§‹IDï¼Œä¸éœ€è¦åˆ†å‰²
                        # å…¼å®¹æ—§æ ¼å¼ï¼šå¦‚æœå­˜åœ¨ id å­—æ®µä¹Ÿæ”¯æŒï¼ˆæ—§æ ¼å¼å¯èƒ½æ˜¯ "orig_id_index"ï¼‰
                        image_id = str(x.get("image_id", ""))
                        if not image_id:
                            # å…¼å®¹æ—§æ ¼å¼ï¼šä» id å­—æ®µæå–ï¼ˆæ ¼å¼å¯èƒ½æ˜¯ "orig_id_index"ï¼‰
                            old_id = str(x.get("id", ""))
                            if "_" in old_id:
                                parts = old_id.rsplit("_", 1)
                                image_id = parts[0]
                            else:
                                image_id = old_id
                        if image_id:
                            processed_ids.add(image_id)
            print(f"ğŸ“Š [æ–­ç‚¹ç»­ä¼ ] ä»è¾“å‡ºæ–‡ä»¶ä¸­è¯»å–åˆ° {len(processed_ids)} å¼ å·²å¤„ç†çš„å›¾ç‰‡")
        except Exception as e:
            print(f"âš ï¸ [æ–­ç‚¹ç»­ä¼ ] è¯»å–å·²å¤„ç†å›¾ç‰‡åˆ—è¡¨å¤±è´¥: {e}")
            processed_ids = set()

    # ç¬¬ä¸€æ­¥ï¼šæ ¹æ® image_type ç­›é€‰å›¾ç‰‡ï¼ˆå¦‚æœè®¾ç½®äº†å…·ä½“ç±»å‹ï¼‰
    filtered_data = []
    if CURRENT_IMAGE_TYPE.lower() == "all":
        # å¦‚æœè®¾ç½®ä¸º "all"ï¼Œä¸è¿›è¡Œç­›é€‰ï¼Œå¤„ç†æ‰€æœ‰å›¾ç‰‡
        print(f"ğŸ“‹ [ç­›é€‰] å›¾ç‰‡ç±»å‹è®¾ç½®ä¸º 'all'ï¼Œå°†å¤„ç†æ‰€æœ‰ç±»å‹çš„å›¾ç‰‡ï¼ˆä¸ç­›é€‰ï¼‰")
        filtered_data = input_data
    else:
        # ç­›é€‰æŒ‡å®šç±»å‹çš„å›¾ç‰‡
        print(f"ğŸ“‹ [ç­›é€‰] åªå¤„ç†å›¾ç‰‡ç±»å‹ä¸º '{CURRENT_IMAGE_TYPE}' çš„å›¾ç‰‡")
        for item in input_data:
            # ä» item ä¸­è·å–å›¾ç‰‡ç±»å‹ï¼ˆæ”¯æŒ image_type æˆ– type å­—æ®µï¼‰
            item_image_type = item.get("image_type") or item.get("type", "")
            if item_image_type:
                item_image_type = item_image_type.lower()
            else:
                item_image_type = ""
            
            # åŒ¹é…å›¾ç‰‡ç±»å‹ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
            if item_image_type == CURRENT_IMAGE_TYPE.lower():
                filtered_data.append(item)
        print(f"ğŸ“‹ [ç­›é€‰] ä» {len(input_data)} å¼ å›¾ç‰‡ä¸­ç­›é€‰å‡º {len(filtered_data)} å¼  '{CURRENT_IMAGE_TYPE}' ç±»å‹çš„å›¾ç‰‡")
    
    # ç¬¬äºŒæ­¥ï¼šè¿‡æ»¤å·²å¤„ç†çš„é¡¹ï¼ˆä»…åœ¨å¼€å¯æ–­ç‚¹ç»­ä¼ æ—¶è·³è¿‡ï¼‰
    todo_items = []
    skipped_count = 0
    for item in filtered_data:
        item_id = str(item.get("id", ""))
        # åªæœ‰åœ¨å¼€å¯æ–­ç‚¹ç»­ä¼ æ—¶æ‰è·³è¿‡å·²å¤„ç†çš„é¡¹
        if args.resume and item_id in processed_ids:
            skipped_count += 1
            continue
        
        # ç¡®ä¿ item ä¸­æœ‰ image_type å­—æ®µï¼ˆç”¨äºåç»­ç”Ÿæˆæ—¶ä½¿ç”¨ï¼‰
        item_image_type = item.get("image_type") or item.get("type")
        if not item_image_type:
            # å¦‚æœè¾“å…¥æ•°æ®ä¸­æ²¡æœ‰ image_typeï¼Œä½¿ç”¨å½“å‰è®¾ç½®çš„ç±»å‹ï¼ˆé™¤éæ˜¯"all"ï¼‰
            if CURRENT_IMAGE_TYPE.lower() != "all":
                item_image_type = CURRENT_IMAGE_TYPE
            else:
                item_image_type = "mixed"  # é»˜è®¤ä½¿ç”¨ mixed
        item["image_type"] = item_image_type
        todo_items.append(item)
    
    if skipped_count > 0:
        print(f"ğŸ“‹ [æ–­ç‚¹ç»­ä¼ ] è·³è¿‡å·²å¤„ç†çš„ {skipped_count} å¼ å›¾ç‰‡")
    
    # æ˜¾ç¤ºæœ€ç»ˆå¾…å¤„ç†åˆ—è¡¨ä¿¡æ¯
    if CURRENT_IMAGE_TYPE.lower() == "all":
        print(f"ğŸ“‹ [æœ€ç»ˆ] å¾…å¤„ç†å›¾ç‰‡: {len(todo_items)} å¼ ï¼ˆæ‰€æœ‰ç±»å‹ï¼‰")
    else:
        print(f"ğŸ“‹ [æœ€ç»ˆ] å¾…å¤„ç†å›¾ç‰‡: {len(todo_items)} å¼ ï¼ˆä»… '{CURRENT_IMAGE_TYPE}' ç±»å‹ï¼‰")
    
    # åº”ç”¨ LIMIT é™åˆ¶å’Œéšæœºé€‰æ‹©
    # é‡è¦ï¼šlimit æ˜¯æœ¬æ¬¡è¿è¡Œè¦å¤„ç†çš„æ•°é‡ï¼Œä¸æ˜¯ç´¯è®¡æ€»æ•°
    # é€»è¾‘ï¼š
    #   - å¦‚æœå¼€å¯äº†æ–­ç‚¹ç»­ä¼ ï¼šå…ˆè¿‡æ»¤æ‰å·²å¤„ç†çš„å›¾ç‰‡ï¼Œç„¶åä»å‰©ä½™å›¾ç‰‡ä¸­é€‰æ‹© limit æ•°é‡
    #   - å¦‚æœæ²¡æœ‰å¼€å¯æ–­ç‚¹ç»­ä¼ ï¼šç›´æ¥ä»æ‰€æœ‰å›¾ç‰‡ä¸­é€‰æ‹© limit æ•°é‡
    # ä½¿ç”¨å±€éƒ¨å˜é‡é¿å…ä¸ random æ¨¡å—åæ··æ·†
    use_random = args.random
    original_todo_count = len(todo_items)
    if args.limit:
        # limit æ˜¯æœ¬æ¬¡è¿è¡Œè¦å¤„ç†çš„æ•°é‡ï¼Œç›´æ¥ä½¿ç”¨ limit
        print(f"âœ‚ï¸  [é™åˆ¶] æœ¬æ¬¡è¿è¡Œå°†å¤„ç† {args.limit} å¼ å›¾ç‰‡")
        
        if use_random:
            # éšæœºé€‰æ‹©
            if args.seed is not None:
                random.seed(args.seed)
                print(f"ğŸ² [éšæœºé€‰æ‹©] ä½¿ç”¨éšæœºç§å­: {args.seed}")
            if args.limit < len(todo_items):
                todo_items = random.sample(todo_items, args.limit)
                print(f"ğŸ² [éšæœºé€‰æ‹©] ä» {original_todo_count} ä¸ªå¾…å¤„ç†å›¾ç‰‡ä¸­éšæœºé€‰æ‹© {args.limit} å¼ ")
            else:
                print(f"ğŸ“Š [é™åˆ¶] é™åˆ¶æ•°é‡ {args.limit} å¤§äºç­‰äºå¾…å¤„ç†å›¾ç‰‡æ•° {original_todo_count}ï¼Œå¤„ç†å…¨éƒ¨")
        else:
            # æŒ‰é¡ºåºé€‰æ‹©å‰ N ä¸ª
            if args.limit < len(todo_items):
                todo_items = todo_items[:args.limit]
                print(f"ğŸ“Š [é™åˆ¶] æŒ‰é¡ºåºé€‰æ‹©å‰ {args.limit} å¼ å›¾ç‰‡ï¼ˆå…± {original_todo_count} å¼ å¾…å¤„ç†ï¼‰")
            else:
                print(f"ğŸ“Š [é™åˆ¶] é™åˆ¶æ•°é‡ {args.limit} å¤§äºç­‰äºå¾…å¤„ç†å›¾ç‰‡æ•° {original_todo_count}ï¼Œå¤„ç†å…¨éƒ¨")
    elif use_random:
        # å¦‚æœè®¾ç½®äº† use_random ä½†æ²¡æœ‰ limitï¼Œåˆ™éšæœºæ‰“ä¹±é¡ºåº
        if args.seed is not None:
            random.seed(args.seed)
            print(f"ğŸ² [éšæœºæ‰“ä¹±] ä½¿ç”¨éšæœºç§å­: {args.seed}")
        random.shuffle(todo_items)
        print(f"ğŸ² [éšæœºæ‰“ä¹±] å·²æ‰“ä¹± {len(todo_items)} å¼ å¾…å¤„ç†å›¾ç‰‡çš„é¡ºåº")

    total_images = len(todo_items)
    total_questions_expected = total_images * args.num
    
    print(f"ğŸ“‹ ä»»åŠ¡: {total_images} å›¾ x {args.num} é¢˜ = {total_questions_expected} é¢˜")
    print(f"ğŸ“‹ å›¾ç‰‡ç±»å‹: {CURRENT_IMAGE_TYPE}, é—®é¢˜ç±»å‹: {QUESTION_TYPES.get(CURRENT_QUESTION_TYPE, CURRENT_QUESTION_TYPE)}")
    print(f"ğŸ“‹ å¹¶å‘: {args.workers}")
    print("="*80)
    
    if not todo_items:
        print("âœ… æ— éœ€å¤„ç†")
        return

    start_time = time.time()
    
    # åˆå§‹åŒ–è¿›åº¦æ¡
    global progress_bar
    if TQDM_AVAILABLE:
        progress_bar = tqdm(
            total=total_images,
            desc="å¤„ç†å›¾ç‰‡",
            unit="å›¾",
            ncols=120,
            bar_format='{l_bar}{bar}| {n_fmt}/{total_fmt} [{elapsed}<{remaining}] {postfix}',
            initial=0
        )
        # åˆå§‹åŒ–åç¼€æ˜¾ç¤º
        progress_bar.set_postfix({
            "å·²å¤„ç†": f"0/{total_images}",
            "æˆåŠŸå›¾": "0",
            "å¤±è´¥å›¾": "0",
            "æ€»é¢˜æ•°": "0"
        })
    else:
        print(f"ğŸš€ å¼€å§‹å¤„ç† {total_images} å¼ å›¾ç‰‡...")
        progress_bar = None
    
    try:
        with concurrent.futures.ThreadPoolExecutor(max_workers=GLOBAL_CONFIG['max_workers']) as executor:
            # ä½¿ç”¨ submit è€Œä¸æ˜¯ mapï¼Œä»¥ä¾¿æ›´å¥½åœ°æ§åˆ¶è¿›åº¦
            futures = {executor.submit(worker, item, total_images): item for item in todo_items}
            
            # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼ˆæ£€æŸ¥å…³é—­æ ‡å¿—ï¼‰
            for future in concurrent.futures.as_completed(futures):
                # å¦‚æœæ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œå–æ¶ˆæœªå®Œæˆçš„ä»»åŠ¡
                if shutdown_event.is_set():
                    print("\nâš ï¸  æ­£åœ¨å–æ¶ˆæœªå®Œæˆçš„ä»»åŠ¡...")
                    for f in futures:
                        f.cancel()
                    break
                
                try:
                    future.result()  # è·å–ç»“æœï¼Œå¦‚æœæœ‰å¼‚å¸¸ä¼šæŠ›å‡º
                except Exception as e:
                    # å¦‚æœæ˜¯å› ä¸ºå…³é—­å¯¼è‡´çš„å¼‚å¸¸ï¼Œå¿½ç•¥
                    if shutdown_event.is_set():
                        break
                    item = futures[future]
                    error_msg = str(e).split('\n')[0][:100]  # é™åˆ¶é•¿åº¦
                    print(f"âŒ [å›¾ç‰‡] image_id={item.get('id', 'unknown')} | å¤„ç†å¼‚å¸¸: {error_msg}")
                    with buffer_lock:
                        stats["failed"] += 1
                        stats["images_failed"] += 1
                        stats["images_processed"] += 1
                    if progress_bar:
                        with progress_lock:
                            progress_bar.update(1)
                            progress_bar.set_postfix({
                                "æˆåŠŸ": stats['images_success'],
                                "å¤±è´¥": stats['images_failed'],
                                "é¢˜æ•°": stats['questions_generated']
                            })
    
    except KeyboardInterrupt:
        # æ•è· KeyboardInterruptï¼ˆè™½ç„¶ä¿¡å·å¤„ç†å·²ç»å¤„ç†äº†ï¼Œä½†è¿™é‡Œä½œä¸ºåŒé‡ä¿é™©ï¼‰
        print("\nâš ï¸  æ£€æµ‹åˆ° KeyboardInterruptï¼Œæ­£åœ¨ä¿å­˜æ•°æ®...")
        shutdown_event.set()
    finally:
        # ç¡®ä¿æœ€ååˆ·æ–°ç¼“å†²åŒºï¼ˆJSONæ ¼å¼ä¼šä¿å­˜bufferä¸­çš„æ•°æ®ï¼ŒJSONLæ ¼å¼å·²ç»æ˜¯å®æ—¶å†™å…¥çš„ï¼‰
        if OUTPUT_FORMAT == "json":
            print("ğŸ’¾ æ­£åœ¨ä¿å­˜ JSON buffer ä¸­çš„å‰©ä½™æ•°æ®...")
        flush_buffer()
        
        # å…³é—­è¿›åº¦æ¡
        if progress_bar:
            progress_bar.close()
            progress_bar = None
        
        # å…³é—­æ—¥å¿—æ–‡ä»¶
        close_log_file()
    
    elapsed_time = time.time() - start_time
    print("\n" + "="*80)
    print("âœ… å¤„ç†å®Œæˆ!")
    print(f"â±ï¸  æ€»è€—æ—¶: {elapsed_time:.2f}s ({elapsed_time/60:.2f}åˆ†é’Ÿ)")
    print(f"ğŸ“Š å¤„ç†ç»Ÿè®¡:")
    print(f"   - å›¾ç‰‡æ€»æ•°: {total_images} å¼ ")
    print(f"   - å·²å¤„ç†å›¾ç‰‡: {stats['images_processed']} å¼ ")
    print(f"   - æˆåŠŸå›¾ç‰‡: {stats['images_success']} å¼  ({stats['images_success']/max(stats['images_processed'], 1)*100:.1f}%)")
    print(f"   - å¤±è´¥å›¾ç‰‡: {stats['images_failed']} å¼  ({stats['images_failed']/max(stats['images_processed'], 1)*100:.1f}%)")
    print(f"   - ç”Ÿæˆé—®é¢˜æ•°: {stats['questions_generated']}/{total_questions_expected} é¢˜")
    print(f"   - é—®é¢˜ç”Ÿæˆç‡: {stats['questions_generated']/max(total_questions_expected, 1)*100:.1f}%")
    if stats['images_processed'] > 0:
        avg_time = elapsed_time / stats['images_processed']
        print(f"   - å¹³å‡æ¯å›¾: {avg_time:.2f}s")
        if stats['questions_generated'] > 0:
            avg_time_per_q = elapsed_time / stats['questions_generated']
            print(f"   - å¹³å‡æ¯é¢˜: {avg_time_per_q:.2f}s")
    print("="*80)

if __name__ == "__main__":
    main()