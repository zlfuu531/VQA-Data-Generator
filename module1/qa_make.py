import os
import json
import base64
import time
import threading
import re
import concurrent.futures
import argparse
from openai import OpenAI
try:
    from tqdm import tqdm
    TQDM_AVAILABLE = True
except ImportError:
    TQDM_AVAILABLE = False
    print("âš ï¸ æç¤º: å®‰è£… tqdm å¯ä»¥è·å¾—æ›´å¥½çš„è¿›åº¦æ˜¾ç¤º: pip install tqdm")

# ==============================================================================
# ğŸŒ å…¨å±€é…ç½®å®¹å™¨
# ==============================================================================
GLOBAL_CONFIG = {
    "api_base": "",
    "api_key": "",
    "model_name": "",
    "temperature": 0.7,
    "max_tokens": 8192,
    "batch_size": 10,
    "max_workers": 4,
    "questions_per_image": 1,
    "enable_thinking": False,  # æ˜¯å¦å¯ç”¨æ€è€ƒæ¨¡å¼ï¼ˆå¯ç”¨åä¼šæå– reasoning_contentï¼‰
    "rounds": 3,               # å¤šè½®å¯¹è¯çš„è½®æ•°ï¼ˆä»…ç”¨äºå¤šè½®å¯¹è¯é¢˜å‹ï¼‰
    "request_timeout": 600.0,   # å•æ¬¡è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    "max_retries": 3,          # è¯·æ±‚æœ€å¤§é‡è¯•æ¬¡æ•°
    "retry_sleep": 1.0         # å¤±è´¥åçš„åŸºç¡€é‡è¯•é—´éš”ï¼ˆç§’ï¼‰
}

# ==============================================================================
# ğŸ“ é—®é¢˜ç±»å‹å®šä¹‰
# ==============================================================================
# ğŸ”§ æ‰©å±•è¯´æ˜ï¼šè¦æ·»åŠ æ–°é—®é¢˜ç±»å‹ï¼Œåªéœ€åœ¨è¿™é‡Œæ·»åŠ æ˜ å°„å…³ç³»
QUESTION_TYPES = {
    "single_choice": "å››é€‰å•é€‰",      # å•é€‰é¢˜
    "multiple_choice": "å››é€‰å¤šé€‰",    # å¤šé€‰é¢˜
    "true_false": "åˆ¤æ–­é¢˜",           # åˆ¤æ–­é¢˜
    "essay": "é—®ç­”é¢˜",                # é—®ç­”é¢˜
    "multi_round_single_choice": "å¤šè½®å•é€‰é¢˜",  # å¤šè½®å•é€‰é¢˜
    "multi_round_essay": "å¤šè½®é—®ç­”é¢˜"  # å¤šè½®é—®ç­”é¢˜
    # æ·»åŠ æ–°é—®é¢˜ç±»å‹ç¤ºä¾‹ï¼š
    # "fill_blank": "å¡«ç©ºé¢˜",
    # "matching": "åŒ¹é…é¢˜",
}

# ==============================================================================
# ğŸ“ å›¾ç‰‡ç±»å‹å®šä¹‰
# ==============================================================================
# ğŸ”§ æ‰©å±•è¯´æ˜ï¼šè¦æ·»åŠ æ–°å›¾ç‰‡ç±»å‹ï¼Œåªéœ€åœ¨è¿™é‡Œæ·»åŠ 
IMAGE_TYPES = ["pure_image", "pure_text", "mixed", "splice", "all"]
# "all" è¡¨ç¤ºå¤„ç†æ‰€æœ‰ç±»å‹çš„å›¾ç‰‡ï¼Œä¸è¿›è¡Œç­›é€‰
# æ·»åŠ æ–°å›¾ç‰‡ç±»å‹ç¤ºä¾‹ï¼š
# IMAGE_TYPES = ["pure_image", "pure_text", "mixed", "splice", "all", "video_frame", "3d_model"]

# ==============================================================================
# ğŸ“ æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿ (å¯æ‰©å±•è®¾è®¡)
# ==============================================================================

def get_image_type_prompt(image_type: str, question_type_name_cn: str, rounds: int = 1) -> str:
    """
    è·å–ç‰¹å®šå›¾ç‰‡ç±»å‹çš„å®Œæ•´å‡ºé¢˜æç¤ºè¯
    ğŸ”§ æ‰©å±•è¯´æ˜ï¼šæ·»åŠ æ–°å›¾ç‰‡ç±»å‹æ—¶ï¼Œåªéœ€åœ¨è¿™é‡Œæ·»åŠ å¯¹åº”çš„å®Œæ•´å‡ºé¢˜é€»è¾‘
    æ³¨æ„ï¼šæ¯ç§å›¾ç‰‡ç±»å‹éƒ½æœ‰ç‹¬ç«‹çš„å‡ºé¢˜é€»è¾‘ï¼Œä¸å…±äº«é€šç”¨éƒ¨åˆ†
    rounds: å¤šè½®å¯¹è¯çš„è½®æ•°ï¼ˆä»…ç”¨äºå¤šè½®å¯¹è¯é¢˜å‹ï¼‰
    """
    # åˆ¤æ–­æ˜¯å¦ä¸ºå¤šè½®å¯¹è¯é¢˜å‹
    is_multi_round = "å¤šè½®" in question_type_name_cn
    rounds_text = f"{rounds}è½®" if is_multi_round else ""
    
    prompts = {
        "pure_image": f"""
ä½ æ˜¯ä¸€åä¸“ä¸šçš„é‡‘èæ¨ç†é¢˜ç›®æ„å»ºä¸“å®¶ï¼Œæ“…é•¿æ ¹æ®å›¾åƒå†…å®¹ç”Ÿæˆé«˜è´¨é‡çš„å›°éš¾é‡‘èå¤šæ¨¡æ€ VQA é—®é¢˜ã€‚

è¯·åŸºäºæä¾›çš„é‡‘èå›¾åƒï¼ˆå¯èƒ½æ˜¯**ç»Ÿè®¡å›¾è¡¨**å¦‚æŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€é¥¼å›¾ã€é›·è¾¾å›¾ç­‰ï¼Œä¹Ÿå¯èƒ½æ˜¯**çº¯æŠ¥è¡¨**å¦‚è´¢åŠ¡æŠ¥è¡¨ã€æ•°æ®è¡¨æ ¼ã€è‚¡æƒç»“æ„è¡¨ç­‰ï¼‰ï¼Œç”Ÿæˆä¸€é“ã€{question_type_name_cn}ã€‘ï¼Œç”¨äºè¯„ä¼°å¤§æ¨¡å‹åœ¨é‡‘èå›¾åƒç²¾å‡†å®šä½ä¸ç†è§£æ–¹é¢çš„èƒ½åŠ›ã€‚

**ã€æ€»ä½“åŸåˆ™ï¼šå®ç¼ºæ¯‹æ»¥ã€‘**

- ä½ åªéœ€è¦ä¸ºæ¯å¼ å›¾ç‰‡æ„é€ **å°‘é‡ä½†é«˜è´¨é‡ã€é«˜åŒºåˆ†åº¦**çš„é—®é¢˜ã€‚
- å¦‚æœå›¾åƒä¿¡æ¯æœ‰é™ï¼Œå®å¯åªæå‡º 1-2 é“éå¸¸å¥½çš„é¢˜ç›®ï¼Œä¹Ÿä¸è¦ä¸ºäº†æ•°é‡ç‰ºç‰²è´¨é‡ã€‚
- æ¯ä¸€é“é¢˜éƒ½è¦æœ‰æ˜ç¡®çš„è€ƒå¯Ÿç‚¹å’Œæ¸…æ™°çš„è§£é¢˜è·¯å¾„ï¼Œè€Œä¸æ˜¯ç®€å•è¯»æ•°é¢˜æˆ–å•æ­¥æŸ¥è¯»ã€‚

**ã€ä»»åŠ¡è¦æ±‚ã€‘**

1. **å¿…é¡»ç”Ÿæˆéœ€è¦å¤šæ­¥æ¨ç†çš„é‡‘èæ¨ç†é—®é¢˜**ï¼Œé—®é¢˜çš„ç­”æ¡ˆåªèƒ½ä¾èµ–å›¾åƒä¸­çš„å†…å®¹å¾—åˆ°ã€‚å¯ä»¥åŒ…æ‹¬ä½†ä¸é™äºï¼š
   - **è´¢åŠ¡æŒ‡æ ‡æ¨ç†**ï¼ˆå¯è®¡ç®—æˆ–é€»è¾‘æ¨æ–­å‡å¯ï¼‰ï¼šè¿ä¹˜/è¿åŠ è®¡ç®—ã€æƒç›Šæ¯”ä¾‹æ‹†è§£ã€å¹´åŒ–æ”¶ç›Šç‡æ¨ç®—ã€åŠ æƒå¹³å‡ã€å¢é•¿ç‡è®¡ç®—ç­‰
   - **å›¾è¡¨è¶‹åŠ¿åˆ†æä¸æ¨æ–­**ï¼šæ—¶é—´åºåˆ—çš„è¶‹åŠ¿åˆ†æã€æå€¼æ¯”è¾ƒã€æ‹ç‚¹è¯†åˆ«ã€å‘¨æœŸæ€§åˆ¤æ–­ç­‰
   - **ç»“æ„åŒ–å›¾å½¢æ¨ç†**ï¼ˆå¦‚è‚¡æƒç»“æ„ã€èµ„äº§ç»“æ„ã€ä¸šåŠ¡æ„æˆï¼‰ï¼šå±‚çº§å…³ç³»ã€æŒè‚¡æ¯”ä¾‹ã€é—´æ¥æŒè‚¡è®¡ç®—ç­‰
   - **å¤šå®ä½“å…³ç³»æ¨æ–­**ï¼šæ¯”è¾ƒã€æ’åºã€å…³è”åˆ†æã€å·®å€¼æˆ–æ¯”å€¼è¿ç®—ç­‰
   - **æ¯”è¾ƒç±»é—®é¢˜**ï¼šå¢é•¿æœ€å¿«ã€å æ¯”æœ€é«˜ã€ç»“æ„å˜åŒ–ã€ç›¸å¯¹è¡¨ç°ç­‰
   - **ç»æµæˆ–ä¸šåŠ¡å«ä¹‰æ¨æ–­**ï¼ˆå¿…é¡»åŸºäºå›¾ä¸­å®¢è§‚ä¿¡æ¯ï¼‰ï¼šé£é™©æ”¶ç›Šç‰¹å¾ã€é£é™©æº¢ä»·å˜åŒ–ç­‰
   - **è·¨å›¾è¡¨/è·¨è¡¨æ ¼ç»¼åˆåˆ†æ**ï¼šå¤šé¡¹æŒ‡æ ‡ä¹‹é—´çš„é“¾å¼æ¨ç†ï¼ˆå¦‚ Aâ†’Bâ†’Cï¼‰

2. **é—®é¢˜å¿…é¡»å±äºé‡‘èé¢†åŸŸçš„å®é™…å­ä»»åŠ¡ä¹‹ä¸€**ï¼Œå¦‚ï¼š
   - å…¬å¸é‡‘èï¼šè´¢åŠ¡æŠ¥è¡¨åˆ†æã€åˆ©æ¶¦ç»“æ„ã€èµ„äº§è´Ÿå€ºè¡¨é¡¹ç›®æ¨ç®—
   - è¡Œä¸šåˆ†æï¼šè¡Œä¸šæŒ‡æ ‡æ¯”è¾ƒã€å¸‚åœºä»½é¢å˜åŒ–ã€ç«äº‰æ ¼å±€
   - è‚¡ç¥¨ä¼°å€¼ï¼šä¼°å€¼æŒ‡æ ‡è®¡ç®—ã€è´¢åŠ¡æ¯”ç‡æ¨å¯¼
   - é£é™©ç®¡ç†ï¼šé£é™©æŒ‡æ ‡è¯†åˆ«ã€æ³¢åŠ¨ç‡æ¯”è¾ƒ
   - èµ„äº§ç®¡ç†ï¼šèµ„äº§é…ç½®ã€æŠ•èµ„ç»„åˆè¡¨ç°
   - å¸‚åœºåˆ†æï¼šå®è§‚ç»æµå›¾è¡¨ï¼ˆé€šèƒ€ã€å·¥ä¸šã€åœ°äº§ã€å•†å“ã€åˆ©ç‡ç­‰ï¼‰ã€å¸‚åœºæˆäº¤é‡ä¸ä»·æ ¼è”åŠ¨
   - è´¢åŠ¡æŒ‡æ ‡è®¡ç®—ï¼šROEã€ROAã€æ¯›åˆ©ç‡ã€å‡€åˆ©ç‡ç­‰æŒ‡æ ‡æ¨ç®—
   - è‚¡æƒç»“æ„åˆ†æï¼šæŒè‚¡æ¯”ä¾‹ã€æ§åˆ¶æƒç©¿é€ã€å®é™…æ§åˆ¶äººè¯†åˆ«

3. **æ‰€æœ‰é—®é¢˜å¿…é¡»æ»¡è¶³**ï¼š
   - ç­”æ¡ˆå”¯ä¸€ã€å®¢è§‚ã€å¯éªŒè¯ï¼ˆä¸èƒ½æœ‰æ­§ä¹‰æˆ–å¤šç§è§£é‡Šï¼‰
   - å¿…é¡»ä¸¥æ ¼ä¾èµ–å›¾åƒä¸­çš„ä¿¡æ¯ï¼ˆä¸èƒ½ä¾èµ–å›¾å¤–çŸ¥è¯†æˆ–å‡è®¾ï¼‰
   - é¢˜å¹²ä¸å…è®¸ç›´æ¥ç»™å‡ºå›¾ç‰‡å†…å·²æœ‰çš„æ•°å€¼ã€ç»“æ„åŒ–ä¿¡æ¯æˆ–ç°æˆç»“è®ºï¼Œåªèƒ½å¼•ç”¨å›¾é¢˜ã€å›¾ä¾‹åç§°ã€ç§‘ç›®åç§°ã€æ—¶é—´ç‚¹/ç±»åˆ«åç§°ç­‰ä½œä¸ºçº¿ç´¢
   - ä¸å…è®¸ä¸»è§‚ç±»é—®é¢˜ï¼ˆå¦‚"ä½ æ€ä¹ˆçœ‹""æ˜¯å¦åˆç†"ï¼‰
   - ä¸å…è®¸å¼€æ”¾å¼å›ç­”ï¼ˆå¦‚"åˆ—å‡ºå¯èƒ½çš„åŸå› "ï¼‰

4. **å¿…é¡»é¿å…ç®€å•æŸ¥è¯»ï¼Œè¦æ±‚å¤šæ­¥æ¨ç†**ï¼š
   - **é’ˆå¯¹ç»Ÿè®¡å›¾è¡¨**ï¼šä¸èƒ½æ˜¯"ç›´æ¥ä»å›¾ä¸­è¯»å‡ºæŸä¸ªæ•°å€¼"çš„å•æ­¥æŸ¥è¯»ï¼Œéœ€è¦åŒ…å«å®šä½ â†’ è¯†åˆ« â†’ è¯»æ•° â†’ æ¯”è¾ƒ/è®¡ç®— â†’ ç»¼åˆåˆ¤æ–­ç­‰å¤šä¸ªæ­¥éª¤
   - **é’ˆå¯¹æŠ¥è¡¨/è¡¨æ ¼**ï¼šä¸èƒ½æ˜¯"ç›´æ¥è¯»å–è¡¨ä¸­æŸä¸€æ ¼æ•°å€¼"ï¼Œéœ€è¦æ¶‰åŠå¤šä¸ªå•å…ƒæ ¼çš„è®¡ç®—ã€æ¯”ä¾‹æ¨ç®—ã€è·¨è¡Œ/è·¨åˆ—çš„ç»¼åˆåˆ†æç­‰

5. **é’ˆå¯¹ç»Ÿè®¡å›¾è¡¨çš„ç‰¹æ®Šè¦æ±‚**ï¼š
   - **æ˜¾å¼è€ƒå¯Ÿ"è¯»å›¾èƒ½åŠ›"**ï¼ˆæ¨ªè½´ã€çºµè½´ã€å›¾ä¾‹ï¼‰ï¼š
     * ä½¿ç”¨æ¨ªè½´ä¿¡æ¯å®šä½æ—¶é—´æˆ–ç±»åˆ«
     * ä½¿ç”¨çºµè½´ä¿¡æ¯ç†è§£åˆ»åº¦å’Œå•ä½
     * ä½¿ç”¨å›¾ä¾‹/é¢œè‰²/çº¿å‹åŒºåˆ†ä¸åŒæ•°æ®ç³»åˆ—
   - **è¯»å›¾ç²¾åº¦ä¸æé—®æ–¹å¼**ï¼š
     * å¦‚æœæ•°æ®ç‚¹ä½äºæ¸…æ™°çš„åˆ»åº¦æˆ–ç½‘æ ¼çº¿ä½ç½®ï¼Œå¯è¦æ±‚ç²¾ç¡®æ•°å€¼å¹¶è¿›è¡Œè®¡ç®—
     * å¦‚æœæ•°æ®ç‚¹å¤„äºåˆ»åº¦ä¹‹é—´æˆ–è¶…å‡ºèŒƒå›´ï¼Œåªå…è®¸è®¾è®¡æ¯”è¾ƒæˆ–åŒºé—´ç±»å‹é—®é¢˜
     * é¿å…è€ƒå¯Ÿè‚‰çœ¼éš¾ä»¥åŒºåˆ†çš„æå°å·®å¼‚
   - **å¤šå­å›¾å…³è”**ï¼šå¦‚æœå›¾ç‰‡ä¸­å­˜åœ¨å¤šä¸ªå­å›¾ï¼Œä¼˜å…ˆè®¾è®¡éœ€è¦åŒæ—¶ä½¿ç”¨å¤šä¸ªå­å›¾ä¿¡æ¯çš„é“¾å¼æ¨ç†é¢˜

6. **é’ˆå¯¹æŠ¥è¡¨/è¡¨æ ¼çš„ç‰¹æ®Šè¦æ±‚**ï¼š
   - éœ€è¦è·¨è¡Œã€è·¨åˆ—æˆ–è·¨è¡¨çš„æ•°æ®æ•´åˆ
   - æ¶‰åŠç§‘ç›®ä¹‹é—´çš„å‹¾ç¨½å…³ç³»éªŒè¯
   - éœ€è¦ç†è§£ä¼šè®¡ç§‘ç›®çš„å±‚çº§å…³ç³»ï¼ˆå¦‚æ€»ç§‘ç›®ä¸æ˜ç»†ç§‘ç›®ï¼‰
   - éœ€è¦è¿›è¡Œæ¯”ç‡ã€ç™¾åˆ†æ¯”ã€å¢é•¿ç‡ç­‰è´¢åŠ¡æŒ‡æ ‡çš„è®¡ç®—

7. **æ€ç»´é“¾è¦æ±‚**ï¼š
   å¿…é¡»åœ¨ qa_make_process å­—æ®µä¸­è¯¦ç»†è®°å½•è§£é¢˜çš„å®Œæ•´æ¨ç†é“¾æ¡ï¼ŒåŒ…æ‹¬ï¼š
   - ä»å›¾åƒçš„å“ªäº›ä½ç½®è·å–äº†å“ªäº›ä¿¡æ¯ï¼ˆå…·ä½“çš„å›¾ä¾‹ã€åæ ‡ã€è¡¨æ ¼å•å…ƒæ ¼ç­‰ï¼‰
   - å¦‚ä½•å°†è¿™äº›ä¿¡æ¯ç»„åˆèµ·æ¥è¿›è¡Œæ¨ç†
   - æ¯ä¸€æ­¥çš„è®¡ç®—æˆ–é€»è¾‘åˆ¤æ–­è¿‡ç¨‹ï¼ˆåŒ…æ‹¬å…·ä½“å…¬å¼å’Œæ•°å€¼ï¼‰
   - æœ€ç»ˆå¦‚ä½•å¾—å‡ºç­”æ¡ˆ

8. **ä¸¥ç¦çš„è¡Œä¸º**ï¼š
   - ä¸å¾—ç¼–é€ å›¾ä¸­ä¸å­˜åœ¨çš„å›¾ä¾‹åç§°ã€æ—¶é—´åˆ»åº¦ã€æ•°å€¼ã€å•ä½ã€ç§‘ç›®åç§°æˆ–è¡¨æ ¼å†…å®¹
   - ä¸å¾—å¼•ç”¨å›¾å¤–æ­£æ–‡ã€é¡µçœ‰é¡µè„šæˆ–å…¶ä»–å›¾åƒå¤–çš„ä¿¡æ¯
   - ä¸å¾—åœ¨é¢˜å¹²æˆ–è¿‡ç¨‹é‡Œå‡è®¾è‚‰çœ¼éš¾ä»¥ä»å›¾ä¸­å¯é è¾¨è®¤çš„ç»†èŠ‚
   - ä¸å¾—è®¾è®¡ä¾èµ–å¤–éƒ¨çŸ¥è¯†æˆ–èƒŒæ™¯æ‰èƒ½å›ç­”çš„é—®é¢˜

{"9. **å¤šè½®å¯¹è¯è¦æ±‚**ï¼šéœ€è¦è®¾è®¡" + rounds_text + "è½®å¯¹è¯ï¼Œæ¯è½®éƒ½æœ‰ç‹¬ç«‹çš„é—®é¢˜å’Œç­”æ¡ˆï¼Œå½¢æˆå®Œæ•´çš„å¯¹è¯æµç¨‹ã€‚æ¯è½®é—®é¢˜éƒ½åº”éµå¾ªä¸Šè¿°æ‰€æœ‰è¦æ±‚ï¼Œä¸”å„è½®ä¹‹é—´åº”å½¢æˆé€»è¾‘é€’è¿›æˆ–å…³è”ï¼ˆå¦‚ï¼šç¬¬1è½®è¯»å–æ•°æ® â†’ ç¬¬2è½®è®¡ç®—æŒ‡æ ‡ â†’ ç¬¬3è½®ç»¼åˆåˆ¤æ–­ï¼‰ã€‚" if is_multi_round else ""}
""",
        "pure_text": f"""
ä½ æ˜¯ä¸€åä¸“ä¸šçš„é‡‘èæ–‡æœ¬æ¨ç†é¢˜ç›®æ„å»ºä¸“å®¶ï¼Œæ“…é•¿ä»é‡‘èç ”æŠ¥çš„çº¯æ–‡å­—å†…å®¹ä¸­ï¼Œè®¾è®¡éœ€è¦æ·±åº¦ç†è§£å’Œå¤šæ­¥æ¨ç†çš„é«˜è´¨é‡ VQA é—®é¢˜ã€‚

è¯·åŸºäºæä¾›çš„é‡‘èç ”æŠ¥æ–‡å­—å›¾åƒï¼ˆçº¯æ–‡æœ¬å†…å®¹ï¼Œæ²¡æœ‰å›¾è¡¨æˆ–è§†è§‰å…ƒç´ ï¼‰ï¼Œç”Ÿæˆä¸€é“ã€{question_type_name_cn}ã€‘ï¼Œç”¨äºè¯„ä¼°å¤§æ¨¡å‹åœ¨é‡‘èæ–‡æœ¬ç†è§£ã€ä¿¡æ¯æå–å’Œé€»è¾‘æ¨ç†æ–¹é¢çš„èƒ½åŠ›ã€‚

**ã€å›¾ç‰‡æ¥æºä¸ç‰¹ç‚¹ã€‘**

- å›¾ç‰‡æ¥æºï¼šé‡‘èç ”æŠ¥çš„æ–‡å­—å†…å®¹æˆªå›¾
- å†…å®¹ç‰¹ç‚¹ï¼šä¸»è¦åŒ…å«æ–‡å­—å†…å®¹ï¼Œå¯èƒ½åŒ…æ‹¬ç ”æŠ¥æ­£æ–‡ã€å…¬å¸ä»‹ç»ã€ä¸šåŠ¡æè¿°ã€è´¢åŠ¡åˆ†æã€è¡Œä¸šè¯„è¿°ã€æŠ•èµ„å»ºè®®ç­‰
- æ–‡æœ¬ç‰¹ç‚¹ï¼šä¸“ä¸šæ€§å¼ºï¼Œä¿¡æ¯å¯†é›†ï¼ŒåŒ…å«å…³é”®æ•°æ®ã€é€»è¾‘å…³ç³»ã€å› æœæ¨æ–­ç­‰

**ã€æ€»ä½“åŸåˆ™ï¼šå®ç¼ºæ¯‹æ»¥ã€‘**

- ä½ åªéœ€è¦ä¸ºæ¯å¼ å›¾ç‰‡æ„é€ **å°‘é‡ä½†é«˜è´¨é‡ã€é«˜åŒºåˆ†åº¦**çš„é—®é¢˜
- å¦‚æœæ–‡æœ¬ä¿¡æ¯æœ‰é™æˆ–è¿‡äºç®€å•ï¼Œå®å¯åªæå‡º 1-2 é“éå¸¸å¥½çš„é¢˜ç›®ï¼Œä¹Ÿä¸è¦ä¸ºäº†æ•°é‡ç‰ºç‰²è´¨é‡
- æ¯ä¸€é“é¢˜éƒ½è¦æœ‰æ˜ç¡®çš„è€ƒå¯Ÿç‚¹å’Œæ¸…æ™°çš„è§£é¢˜è·¯å¾„ï¼Œè€Œä¸æ˜¯ç®€å•çš„æ–‡æœ¬å¤åˆ¶

**ã€ä»»åŠ¡è¦æ±‚ã€‘**

1. **å¿…é¡»ç”Ÿæˆéœ€è¦å¤šæ­¥æ¨ç†çš„é‡‘èæ–‡æœ¬ç†è§£é—®é¢˜**ï¼Œé—®é¢˜çš„ç­”æ¡ˆåªèƒ½ä¾èµ–å›¾åƒä¸­çš„æ–‡æœ¬å†…å®¹å¾—åˆ°ã€‚å¯ä»¥åŒ…æ‹¬ä½†ä¸é™äºï¼š
   - **ä¿¡æ¯æå–ä¸æ•´åˆ**ï¼šä»å¤šä¸ªæ®µè½ä¸­æå–å¹¶æ•´åˆå…³é”®ä¿¡æ¯
   - **é€»è¾‘æ¨æ–­**ï¼šåŸºäºæ–‡æœ¬ä¸­çš„å‰ææ¡ä»¶ï¼Œæ¨å¯¼å‡ºéšå«çš„ç»“è®º
   - **å› æœå…³ç³»åˆ†æ**ï¼šè¯†åˆ«æ–‡æœ¬ä¸­çš„å› æœé“¾æ¡ï¼Œæ¨æ–­åŸå› æˆ–ç»“æœ
   - **æ•°å€¼è®¡ç®—**ï¼šåŸºäºæ–‡æœ¬ä¸­æåˆ°çš„æ•°æ®è¿›è¡Œè®¡ç®—ï¼ˆå¦‚å¢é•¿ç‡ã€å æ¯”ã€æ¯”ç‡ç­‰ï¼‰
   - **æ¯”è¾ƒä¸æ’åº**ï¼šæ¯”è¾ƒæ–‡æœ¬ä¸­æåˆ°çš„å¤šä¸ªå®ä½“ã€æŒ‡æ ‡æˆ–è§‚ç‚¹
   - **è¯­ä¹‰ç†è§£**ï¼šç†è§£ä¸“ä¸šæœ¯è¯­ã€ä¸šåŠ¡é€»è¾‘ã€è´¢åŠ¡æ¦‚å¿µçš„æ·±å±‚å«ä¹‰
   - **ç»“æ„åŒ–ä¿¡æ¯é‡ç»„**ï¼šå°†åˆ†æ•£åœ¨æ–‡æœ¬ä¸­çš„ä¿¡æ¯è¿›è¡Œç»“æ„åŒ–æ•´ç†å’Œæ¨ç†

2. **é—®é¢˜å¿…é¡»å±äºé‡‘èé¢†åŸŸçš„å®é™…ç†è§£ä»»åŠ¡**ï¼Œå¦‚ï¼š
   - å…¬å¸ä¸šåŠ¡æ¨¡å¼ç†è§£ï¼šå•†ä¸šæ¨¡å¼ã€ç›ˆåˆ©æ¨¡å¼ã€ä¸šåŠ¡ç»“æ„
   - è´¢åŠ¡çŠ¶å†µåˆ†æï¼šä»æ–‡å­—æè¿°ä¸­æå–è´¢åŠ¡ä¿¡æ¯å¹¶è¿›è¡Œåˆ†æ
   - è¡Œä¸šç«äº‰æ ¼å±€ï¼šè¯†åˆ«ç«äº‰å¯¹æ‰‹ã€å¸‚åœºåœ°ä½ã€ç«äº‰ä¼˜åŠ¿
   - é£é™©å› ç´ è¯†åˆ«ï¼šä»æ–‡æœ¬ä¸­æå–å’Œå½’çº³é£é™©ç‚¹
   - æŠ•èµ„é€»è¾‘æ¨å¯¼ï¼šç†è§£ç ”æŠ¥çš„æŠ•èµ„å»ºè®®åŠå…¶ä¾æ®
   - ä¸šç»©é©±åŠ¨å› ç´ ï¼šè¯†åˆ«å½±å“ä¸šç»©çš„å…³é”®å› ç´ åŠå…¶ä½œç”¨æœºåˆ¶
   - æ”¿ç­–å½±å“åˆ†æï¼šç†è§£æ”¿ç­–å¯¹å…¬å¸æˆ–è¡Œä¸šçš„å½±å“è·¯å¾„

3. **æ‰€æœ‰é—®é¢˜å¿…é¡»æ»¡è¶³**ï¼š
   - ç­”æ¡ˆå”¯ä¸€ã€å®¢è§‚ã€å¯éªŒè¯ï¼ˆåŸºäºæ–‡æœ¬å†…å®¹èƒ½æ˜ç¡®åˆ¤æ–­ï¼‰
   - å¿…é¡»ä¸¥æ ¼ä¾èµ–å›¾åƒä¸­çš„æ–‡æœ¬ä¿¡æ¯ï¼ˆä¸èƒ½ä¾èµ–å›¾å¤–çŸ¥è¯†æˆ–å‡è®¾ï¼‰
   - é¢˜å¹²ä¸å…è®¸ç›´æ¥ç»™å‡ºæ–‡æœ¬ä¸­çš„å…³é”®ä¿¡æ¯æˆ–ç»“è®ºï¼Œåªèƒ½æä¾›å®šä½çº¿ç´¢
   - ä¸å…è®¸ä¸»è§‚ç±»é—®é¢˜ï¼ˆå¦‚"ä½ æ€ä¹ˆçœ‹""ä½ æ˜¯å¦åŒæ„"ï¼‰
   - ä¸å…è®¸å¼€æ”¾å¼å›ç­”ï¼ˆå¦‚"åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„åŸå› "ï¼‰

4. **å¿…é¡»é¿å…ç®€å•æ–‡æœ¬å¤åˆ¶ï¼Œè¦æ±‚å¤šæ­¥æ¨ç†**ï¼š
   - ä¸èƒ½æ˜¯"æ–‡ä¸­æåˆ°äº†ä»€ä¹ˆ"çš„ç®€å•æŸ¥æ‰¾é¢˜
   - éœ€è¦è·¨æ®µè½ã€è·¨å¥å­çš„ä¿¡æ¯æ•´åˆ
   - éœ€è¦ç†è§£æ–‡æœ¬çš„é€»è¾‘ç»“æ„å’Œè®ºè¯å…³ç³»
   - éœ€è¦è¿›è¡Œæ¨ç†ã€è®¡ç®—æˆ–ç»¼åˆåˆ¤æ–­
   - å¯ä»¥æ¶‰åŠå¤šä¸ªä¿¡æ¯ç‚¹çš„å…³è”åˆ†æ

5. **æ–‡æœ¬å®šä½ä¸ç†è§£è¦æ±‚**ï¼š
   - é¢˜ç›®åº”å¼•å¯¼æ¨¡å‹å‡†ç¡®å®šä½ç›¸å…³æ–‡æœ¬æ®µè½æˆ–å¥å­
   - éœ€è¦ç†è§£é‡‘èä¸“ä¸šæœ¯è¯­çš„å‡†ç¡®å«ä¹‰
   - éœ€è¦è¯†åˆ«æ–‡æœ¬ä¸­çš„å…³é”®æ•°æ®ã€æ—¶é—´ã€å®ä½“åç§°ç­‰
   - éœ€è¦ç†è§£æ–‡æœ¬çš„å±‚æ¬¡ç»“æ„ï¼ˆå¦‚æ€»åˆ†å…³ç³»ã€å¹¶åˆ—å…³ç³»ã€é€’è¿›å…³ç³»ç­‰ï¼‰

6. **æ€ç»´é“¾è¦æ±‚**ï¼š
   å¿…é¡»åœ¨ qa_make_process å­—æ®µä¸­è¯¦ç»†è®°å½•è§£é¢˜çš„å®Œæ•´æ¨ç†é“¾æ¡ï¼ŒåŒ…æ‹¬ï¼š
   - ä»æ–‡æœ¬çš„å“ªäº›ä½ç½®ï¼ˆæ®µè½ã€å¥å­ï¼‰è·å–äº†å“ªäº›ä¿¡æ¯
   - å¦‚ä½•ç†è§£è¿™äº›ä¿¡æ¯ï¼ˆåŒ…æ‹¬ä¸“ä¸šæœ¯è¯­çš„è§£é‡Šï¼‰
   - å¦‚ä½•å°†å¤šä¸ªä¿¡æ¯ç‚¹ç»„åˆèµ·æ¥è¿›è¡Œæ¨ç†
   - æ¯ä¸€æ­¥çš„é€»è¾‘åˆ¤æ–­æˆ–è®¡ç®—è¿‡ç¨‹
   - æœ€ç»ˆå¦‚ä½•å¾—å‡ºç­”æ¡ˆ

7. **ä¸¥ç¦çš„è¡Œä¸º**ï¼š
   - ä¸å¾—ç¼–é€ æ–‡æœ¬ä¸­ä¸å­˜åœ¨çš„ä¿¡æ¯ã€æ•°æ®æˆ–ç»“è®º
   - ä¸å¾—å¼•ç”¨å›¾åƒå¤–çš„ä¿¡æ¯æˆ–èƒŒæ™¯çŸ¥è¯†
   - ä¸å¾—åœ¨é¢˜å¹²ä¸­ç›´æ¥æ³„éœ²æ–‡æœ¬ä¸­çš„å…³é”®ä¿¡æ¯æˆ–ç­”æ¡ˆ
   - ä¸å¾—è®¾è®¡ä¾èµ–å¸¸è¯†æˆ–å¤–éƒ¨çŸ¥è¯†æ‰èƒ½å›ç­”çš„é—®é¢˜
   - ä¸å¾—è®¾è®¡ç­”æ¡ˆæ¨¡ç³Šæˆ–æœ‰å¤šç§å¯èƒ½è§£é‡Šçš„é—®é¢˜

{"8. **å¤šè½®å¯¹è¯è¦æ±‚**ï¼šéœ€è¦è®¾è®¡" + rounds_text + "è½®å¯¹è¯ï¼Œæ¯è½®éƒ½æœ‰ç‹¬ç«‹çš„é—®é¢˜å’Œç­”æ¡ˆï¼Œå½¢æˆå®Œæ•´çš„å¯¹è¯æµç¨‹ã€‚æ¯è½®é—®é¢˜éƒ½åº”éµå¾ªä¸Šè¿°æ‰€æœ‰è¦æ±‚ï¼Œä¸”å„è½®ä¹‹é—´åº”å½¢æˆé€»è¾‘é€’è¿›æˆ–å…³è”ï¼ˆå¦‚ï¼šç¬¬1è½®ä¿¡æ¯æå– â†’ ç¬¬2è½®é€»è¾‘æ¨ç† â†’ ç¬¬3è½®ç»¼åˆåˆ¤æ–­ï¼‰ã€‚" if is_multi_round else ""}
""",
        "mixed": f"""
ä½ æ˜¯ä¸€åé¡¶çº§çš„é‡‘èå¤šæ¨¡æ€é«˜éš¾åº¦ VQA é¢˜ç›®æ„å»ºä¸“å®¶ï¼Œæ“…é•¿ä»å¤æ‚çš„"å›¾è¡¨+æ–‡å­—è¯´æ˜"ç±»é‡‘èå›¾åƒä¸­ï¼Œè®¾è®¡éœ€è¦å¤šå±‚é€»è¾‘é“¾æ¡çš„ä¸“ä¸šçº§åˆ†æé¢˜ã€‚

è¯·åŸºäºç»™å®šçš„é‡‘èå›¾åƒï¼ˆå¯èƒ½åŒ…å«æŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€é¥¼å›¾ã€åŒæ¯”/ç¯æ¯”æ•°æ®ã€ç™¾åˆ†æ¯”ç»“æ„ã€è¡¨æ ¼ã€è¯´æ˜æ–‡å­—ã€æŒ‡æ ‡å®šä¹‰ã€å›¾ä¾‹ã€æ³¨é‡Šç­‰å¤šç§å…ƒç´ ï¼‰ï¼Œç”Ÿæˆä¸€é“ã€{question_type_name_cn}ã€‘ã€‚é¢˜ç›®éš¾åº¦éœ€æ˜¾è‘—é«˜äºä¸€èˆ¬é‡‘èç ”ç©¶å‘˜æ°´å¹³ï¼Œå¿…é¡»ä¾èµ–å›¾ä¸­å¤šä¸ªä¿¡æ¯å—çš„äº¤å‰ä½¿ç”¨ï¼ˆå›¾è¡¨ + æ–‡å­—è¯´æ˜ + æ³¨é‡Š + å›¾ä¾‹ï¼‰ã€‚

**ã€ä»»åŠ¡è¦æ±‚ã€‘**

1. **é¢˜ç›®éš¾åº¦éœ€è¾¾åˆ°é‡‘èåˆ†æå¸ˆ/ç ”ç©¶å‘˜æ°´å¹³**
   å¿…é¡»ç”Ÿæˆéœ€è¦å¤šæ­¥æ¨ç†çš„é‡‘èæ¨ç†é—®é¢˜ï¼Œé—®é¢˜çš„ç­”æ¡ˆåªèƒ½ä¾èµ–å›¾åƒä¸­çš„å†…å®¹å¾—åˆ°ã€‚é¢˜ç›®ç±»å‹å¯ä»¥åŒ…æ‹¬ä½†ä¸é™äºï¼š
   - è´¢åŠ¡æŒ‡æ ‡æ¨ç†ï¼ˆåŸºäºå›¾ä¸­æ•°æ®è¿›è¡Œè®¡ç®—æˆ–é€»è¾‘æ¨æ–­ï¼‰
   - å›¾è¡¨è¶‹åŠ¿åˆ†æä¸æ¨æ–­ï¼ˆè¯†åˆ«æ‹ç‚¹ã€åŠ é€Ÿ/å‡é€Ÿã€å‘¨æœŸæ€§ç­‰ï¼‰
   - ç»“æ„åŒ–å›¾å½¢æ¨ç†ï¼ˆå¦‚è‚¡æƒç»“æ„ã€èµ„äº§ç»“æ„ã€ä¸šåŠ¡æ„æˆç­‰ï¼‰
   - å¤šå®ä½“å…³ç³»æ¨æ–­ï¼ˆæ¯”è¾ƒã€æ’åºã€å…³è”åˆ†æç­‰ï¼‰
   - æ¯”è¾ƒç±»é—®é¢˜ï¼ˆå¢é•¿æœ€å¿«ã€å æ¯”æœ€é«˜ã€ç»“æ„å˜åŒ–ã€ç›¸å¯¹è¡¨ç°ç­‰ï¼‰
   - ç»æµæˆ–ä¸šåŠ¡å«ä¹‰æ¨æ–­ï¼ˆåŸºäºå›¾ä¸­å®¢è§‚ä¿¡æ¯å¾—å‡ºç»“è®ºï¼‰
   - è·¨å›¾è¡¨ç»¼åˆåˆ†æï¼ˆå¤šé¡¹æŒ‡æ ‡ä¹‹é—´çš„é“¾å¼æ¨æ–­ï¼Œå¦‚ Aâ†’Bâ†’Cï¼‰

2. **æ‰€æœ‰é—®é¢˜å¿…é¡»æ»¡è¶³**ï¼š
   - ç­”æ¡ˆå”¯ä¸€ã€å®¢è§‚ã€å¯éªŒè¯ï¼ˆä¸èƒ½æœ‰æ­§ä¹‰æˆ–å¤šç§è§£é‡Šï¼‰
   - å¿…é¡»ä¸¥æ ¼ä¾èµ–å›¾åƒä¸­çš„ä¿¡æ¯ï¼ˆä¸èƒ½ä¾èµ–å›¾å¤–çŸ¥è¯†æˆ–å‡è®¾ï¼‰
   - é¢˜å¹²ä¸å¾—ç›´æ¥ç»™å‡ºå›¾ç‰‡å†…å·²æœ‰çš„ç»“æ„åŒ–æ•°æ®æˆ–ç»“è®º
   - ä¸å…è®¸ä¸»è§‚ç±»é—®é¢˜ï¼ˆå¦‚"ä½ æ€ä¹ˆçœ‹""æ˜¯å¦åˆç†"ï¼‰
   - ä¸å…è®¸å¼€æ”¾å¼å›ç­”ï¼ˆå¦‚"åˆ—å‡ºå¯èƒ½çš„åŸå› ""å¯èƒ½æœ‰å“ªäº›å½±å“"ï¼‰

3. **éš¾åº¦è¦æ±‚ï¼šæ¯ä¸€é¢˜è‡³å°‘æ»¡è¶³ä»¥ä¸‹ä»»æ„ä¸¤æ¡**ï¼š
   - æ¶‰åŠè·¨å¹´åº¦ã€è·¨å­£åº¦ã€è·¨åŒºåŸŸçš„è¶‹åŠ¿æ¯”è¾ƒ
   - åŒæ—¶ä½¿ç”¨å›¾è¡¨æ•°å€¼ + å›¾ä¾‹è§£é‡Š + æ–‡å­—è¯´æ˜
   - å¤šæŒ‡æ ‡ä¹‹é—´çš„é“¾å¼æ¨ç†ï¼ˆAâ†’Bâ†’Cï¼Œéœ€è¦è‡³å°‘ 2-3 æ­¥æ¨ç†ï¼‰
   - ç»“æ„å æ¯”å˜åŒ–æ¨æ–­ï¼ˆå¦‚"å“ªéƒ¨åˆ†è´¡çŒ®æœ€å¤§""ç»“æ„å¦‚ä½•å˜åŒ–"ï¼‰
   - ä»åŒæ¯” + ç¯æ¯”çš„å åŠ ä¿¡æ¯å¾—å‡ºåˆ¤æ–­
   - ä½¿ç”¨å›¾ä¸­å¤šä¸ªå›¾å—ï¼ˆå¦‚ä¸»å›¾ + å­å›¾ + è¡¨æ ¼ï¼‰ç»¼åˆæ¨æ–­

4. **æ€ç»´é“¾è¦æ±‚**ï¼š
   å¿…é¡»åœ¨ qa_make_process å­—æ®µä¸­è¯¦ç»†è®°å½•è§£é¢˜çš„å®Œæ•´æ¨ç†é“¾æ¡ï¼ŒåŒ…æ‹¬ï¼š
   - ä»å›¾ä¸­å“ªäº›ä½ç½®è·å–äº†å“ªäº›ä¿¡æ¯
   - å¦‚ä½•å°†è¿™äº›ä¿¡æ¯ç»„åˆèµ·æ¥è¿›è¡Œæ¨ç†
   - æ¯ä¸€æ­¥çš„è®¡ç®—æˆ–é€»è¾‘åˆ¤æ–­è¿‡ç¨‹
   - æœ€ç»ˆå¦‚ä½•å¾—å‡ºç­”æ¡ˆ

5. **ä¸¥ç¦çš„è¡Œä¸º**ï¼š
   - ä¸å¾—ç¼–é€ å›¾ä¸­ä¸å­˜åœ¨çš„æ•°æ®ã€å›¾ä¾‹ã€æ—¶é—´åˆ»åº¦ã€æŒ‡æ ‡åç§°
   - ä¸å¾—åœ¨é¢˜å¹²ä¸­ç›´æ¥æ³„éœ²å›¾ä¸­çš„å…³é”®æ•°æ®æˆ–ç»“è®º
   - ä¸å¾—è®¾è®¡ä¾èµ–å¤–éƒ¨çŸ¥è¯†æˆ–èƒŒæ™¯æ‰èƒ½å›ç­”çš„é—®é¢˜
   - ä¸å¾—è®¾è®¡ç­”æ¡ˆæ¨¡ç³Šæˆ–æœ‰å¤šç§å¯èƒ½è§£é‡Šçš„é—®é¢˜

{"6. **å¤šè½®å¯¹è¯è¦æ±‚**ï¼šéœ€è¦è®¾è®¡" + rounds_text + "è½®å¯¹è¯ï¼Œæ¯è½®éƒ½æœ‰ç‹¬ç«‹çš„é—®é¢˜å’Œç­”æ¡ˆï¼Œå½¢æˆå®Œæ•´çš„å¯¹è¯æµç¨‹ã€‚æ¯è½®é—®é¢˜éƒ½åº”éµå¾ªä¸Šè¿°æ‰€æœ‰è¦æ±‚ï¼Œä¸”å„è½®ä¹‹é—´åº”å½¢æˆé€»è¾‘é€’è¿›æˆ–å…³è”ï¼ˆå¦‚ï¼šç¬¬1è½®è¯†åˆ«æ•°æ® â†’ ç¬¬2è½®è®¡ç®—æŒ‡æ ‡ â†’ ç¬¬3è½®ç»¼åˆåˆ¤æ–­ï¼‰ã€‚" if is_multi_round else ""}
""",
        "splice": f"""
ä½ æ˜¯ä¸€åé¡¶çº§çš„é‡‘èå¤šæ¨¡æ€é«˜éš¾åº¦ VQA é¢˜ç›®æ„å»ºä¸“å®¶ï¼Œæ“…é•¿ä»å¤æ‚çš„"å›¾è¡¨+æ–‡å­—è¯´æ˜"ç±»é‡‘èå›¾åƒä¸­ï¼Œè®¾è®¡éœ€è¦å¤šå±‚é€»è¾‘é“¾æ¡çš„ä¸“ä¸šçº§åˆ†æé¢˜ã€‚

**ç‰¹åˆ«è¯´æ˜**ï¼šç»™å®šå›¾åƒä¸º**ä¸¤å¼ é‡‘èå›¾ç‰‡çš„æ‹¼æ¥**ï¼Œè¿™ä¸¤å¼ å›¾ç‰‡å¯èƒ½äº’ä¸ç›¸å…³ã€‚è¯·**åªé’ˆå¯¹å…¶ä¸­ä¸€å¼ å›¾ç‰‡çš„å†…å®¹å‡ºé¢˜**ï¼Œå‡ºé¢˜å†…å®¹è¦å’Œå¦ä¸€å¼ å›¾ç‰‡çš„å†…å®¹å°½å¯èƒ½ä¸ç›¸å¹²ï¼Œç›®çš„æ˜¯è€ƒå¯Ÿæ¨¡å‹çš„**ç²¾å‡†å®šä½èƒ½åŠ›**ï¼ˆèƒ½å¦å‡†ç¡®è¯†åˆ«å’Œèšç„¦äºç‰¹å®šå›¾ç‰‡åŒºåŸŸï¼‰ã€‚

è¯·åŸºäºé€‰å®šçš„é‚£å¼ é‡‘èå›¾åƒï¼ˆå¯èƒ½åŒ…å«æŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€é¥¼å›¾ã€åŒæ¯”/ç¯æ¯”æ•°æ®ã€ç™¾åˆ†æ¯”ç»“æ„ã€è¡¨æ ¼ã€è¯´æ˜æ–‡å­—ã€æŒ‡æ ‡å®šä¹‰ã€å›¾ä¾‹ã€æ³¨é‡Šç­‰ï¼‰ï¼Œç”Ÿæˆä¸€é“ã€{question_type_name_cn}ã€‘ã€‚é¢˜ç›®éš¾åº¦éœ€æ˜¾è‘—é«˜äºä¸€èˆ¬é‡‘èç ”ç©¶å‘˜æ°´å¹³ï¼Œå¿…é¡»ä¾èµ–æ‰€é€‰å›¾ç‰‡ä¸­å¤šä¸ªä¿¡æ¯å—çš„äº¤å‰ä½¿ç”¨ï¼ˆå›¾è¡¨ + æ–‡å­—è¯´æ˜ + æ³¨é‡Š + å›¾ä¾‹ï¼‰ã€‚

**ã€ä»»åŠ¡è¦æ±‚ã€‘**

1. **é¢˜ç›®éš¾åº¦éœ€è¾¾åˆ°é‡‘èåˆ†æå¸ˆ/ç ”ç©¶å‘˜æ°´å¹³**
   å¿…é¡»ç”Ÿæˆéœ€è¦å¤šæ­¥æ¨ç†çš„é‡‘èæ¨ç†é—®é¢˜ï¼Œé—®é¢˜çš„ç­”æ¡ˆåªèƒ½ä¾èµ–å›¾åƒä¸­çš„å†…å®¹å¾—åˆ°ã€‚é¢˜ç›®ç±»å‹å¯ä»¥åŒ…æ‹¬ä½†ä¸é™äºï¼š
   - è´¢åŠ¡æŒ‡æ ‡æ¨ç†ï¼ˆåŸºäºå›¾ä¸­æ•°æ®è¿›è¡Œè®¡ç®—æˆ–é€»è¾‘æ¨æ–­ï¼‰
   - å›¾è¡¨è¶‹åŠ¿åˆ†æä¸æ¨æ–­ï¼ˆè¯†åˆ«æ‹ç‚¹ã€åŠ é€Ÿ/å‡é€Ÿã€å‘¨æœŸæ€§ç­‰ï¼‰
   - ç»“æ„åŒ–å›¾å½¢æ¨ç†ï¼ˆå¦‚è‚¡æƒç»“æ„ã€èµ„äº§ç»“æ„ã€ä¸šåŠ¡æ„æˆç­‰ï¼‰
   - å¤šå®ä½“å…³ç³»æ¨æ–­ï¼ˆæ¯”è¾ƒã€æ’åºã€å…³è”åˆ†æç­‰ï¼‰
   - æ¯”è¾ƒç±»é—®é¢˜ï¼ˆå¢é•¿æœ€å¿«ã€å æ¯”æœ€é«˜ã€ç»“æ„å˜åŒ–ã€ç›¸å¯¹è¡¨ç°ç­‰ï¼‰
   - ç»æµæˆ–ä¸šåŠ¡å«ä¹‰æ¨æ–­ï¼ˆåŸºäºå›¾ä¸­å®¢è§‚ä¿¡æ¯å¾—å‡ºç»“è®ºï¼‰
   - è·¨å›¾è¡¨ç»¼åˆåˆ†æï¼ˆåœ¨æ‰€é€‰å›¾ç‰‡å†…ï¼Œå¤šé¡¹æŒ‡æ ‡ä¹‹é—´çš„é“¾å¼æ¨æ–­ï¼Œå¦‚ Aâ†’Bâ†’Cï¼‰

2. **æ‰€æœ‰é—®é¢˜å¿…é¡»æ»¡è¶³**ï¼š
   - ç­”æ¡ˆå”¯ä¸€ã€å®¢è§‚ã€å¯éªŒè¯ï¼ˆä¸èƒ½æœ‰æ­§ä¹‰æˆ–å¤šç§è§£é‡Šï¼‰
   - å¿…é¡»ä¸¥æ ¼ä¾èµ–æ‰€é€‰å›¾ç‰‡ä¸­çš„ä¿¡æ¯ï¼ˆä¸èƒ½ä¾èµ–å¦ä¸€å¼ å›¾ç‰‡æˆ–å›¾å¤–çŸ¥è¯†ï¼‰
   - é¢˜å¹²ä¸å¾—ç›´æ¥ç»™å‡ºå›¾ç‰‡å†…å·²æœ‰çš„ç»“æ„åŒ–æ•°æ®æˆ–ç»“è®º
   - é¢˜å¹²éœ€è¦é€šè¿‡æè¿°è®©æ¨¡å‹æ˜ç¡®çŸ¥é“æ˜¯é’ˆå¯¹å“ªå¼ å›¾ç‰‡å‡ºé¢˜ï¼ˆå¦‚"ä¸Šå›¾""ä¸‹å›¾""å·¦å›¾""å³å›¾"æˆ–é€šè¿‡å›¾ç‰‡ä¸»é¢˜æè¿°ï¼‰
   - ä¸å…è®¸ä¸»è§‚ç±»é—®é¢˜ï¼ˆå¦‚"ä½ æ€ä¹ˆçœ‹""æ˜¯å¦åˆç†"ï¼‰
   - ä¸å…è®¸å¼€æ”¾å¼å›ç­”ï¼ˆå¦‚"åˆ—å‡ºå¯èƒ½çš„åŸå› ""å¯èƒ½æœ‰å“ªäº›å½±å“"ï¼‰

3. **éš¾åº¦è¦æ±‚ï¼šæ¯ä¸€é¢˜è‡³å°‘æ»¡è¶³ä»¥ä¸‹ä»»æ„ä¸¤æ¡**ï¼š
   - æ¶‰åŠè·¨å¹´åº¦ã€è·¨å­£åº¦ã€è·¨åŒºåŸŸçš„è¶‹åŠ¿æ¯”è¾ƒ
   - åŒæ—¶ä½¿ç”¨å›¾è¡¨æ•°å€¼ + å›¾ä¾‹è§£é‡Š + æ–‡å­—è¯´æ˜
   - å¤šæŒ‡æ ‡ä¹‹é—´çš„é“¾å¼æ¨ç†ï¼ˆAâ†’Bâ†’Cï¼Œéœ€è¦è‡³å°‘ 2-3 æ­¥æ¨ç†ï¼‰
   - ç»“æ„å æ¯”å˜åŒ–æ¨æ–­ï¼ˆå¦‚"å“ªéƒ¨åˆ†è´¡çŒ®æœ€å¤§""ç»“æ„å¦‚ä½•å˜åŒ–"ï¼‰
   - ä»åŒæ¯” + ç¯æ¯”çš„å åŠ ä¿¡æ¯å¾—å‡ºåˆ¤æ–­
   - ä½¿ç”¨æ‰€é€‰å›¾ç‰‡ä¸­çš„å¤šä¸ªå›¾å—ï¼ˆå¦‚ä¸»å›¾ + å­å›¾ + è¡¨æ ¼ï¼‰ç»¼åˆæ¨æ–­

4. **ç²¾å‡†å®šä½è¦æ±‚ï¼ˆé‡è¦ï¼‰**ï¼š
   - é¢˜å¹²å¿…é¡»æ˜ç¡®æŒ‡å‘å…¶ä¸­ä¸€å¼ å›¾ç‰‡ï¼Œé¿å…æ¨¡ç³Šä¸æ¸…
   - å¯ä»¥ä½¿ç”¨ä½ç½®æè¿°è¯ï¼ˆä¸Šå›¾/ä¸‹å›¾/å·¦å›¾/å³å›¾ï¼‰æˆ–ä¸»é¢˜æè¿°ï¼ˆå¦‚"å…³äºXXçš„å›¾è¡¨"ï¼‰
   - ç­”æ¡ˆå¿…é¡»åªèƒ½ä»æ‰€é€‰å›¾ç‰‡ä¸­å¾—å‡ºï¼Œä¸èƒ½æ··ç”¨ä¸¤å¼ å›¾ç‰‡çš„ä¿¡æ¯
   - æ¨ç†è¿‡ç¨‹è¦æ˜ç¡®è¯´æ˜ä»æ‰€é€‰å›¾ç‰‡çš„å“ªäº›ä½ç½®è·å–äº†å“ªäº›ä¿¡æ¯

5. **æ€ç»´é“¾è¦æ±‚**ï¼š
   å¿…é¡»åœ¨ qa_make_process å­—æ®µä¸­è¯¦ç»†è®°å½•è§£é¢˜çš„å®Œæ•´æ¨ç†é“¾æ¡ï¼ŒåŒ…æ‹¬ï¼š
   - æ˜ç¡®è¯´æ˜é’ˆå¯¹çš„æ˜¯å“ªå¼ å›¾ç‰‡ï¼ˆå¦‚"åŸºäºä¸Šå›¾"æˆ–"åŸºäºå…³äºXXçš„å›¾è¡¨"ï¼‰
   - ä»è¯¥å›¾ç‰‡çš„å“ªäº›ä½ç½®è·å–äº†å“ªäº›ä¿¡æ¯
   - å¦‚ä½•å°†è¿™äº›ä¿¡æ¯ç»„åˆèµ·æ¥è¿›è¡Œæ¨ç†
   - æ¯ä¸€æ­¥çš„è®¡ç®—æˆ–é€»è¾‘åˆ¤æ–­è¿‡ç¨‹
   - æœ€ç»ˆå¦‚ä½•å¾—å‡ºç­”æ¡ˆ

6. **ä¸¥ç¦çš„è¡Œä¸º**ï¼š
   - ä¸å¾—æ··ç”¨ä¸¤å¼ å›¾ç‰‡çš„ä¿¡æ¯è¿›è¡Œå‡ºé¢˜æˆ–ä½œç­”
   - ä¸å¾—ç¼–é€ å›¾ä¸­ä¸å­˜åœ¨çš„æ•°æ®ã€å›¾ä¾‹ã€æ—¶é—´åˆ»åº¦ã€æŒ‡æ ‡åç§°
   - ä¸å¾—åœ¨é¢˜å¹²ä¸­ç›´æ¥æ³„éœ²å›¾ä¸­çš„å…³é”®æ•°æ®æˆ–ç»“è®º
   - ä¸å¾—è®¾è®¡ä¾èµ–å¤–éƒ¨çŸ¥è¯†æˆ–èƒŒæ™¯æ‰èƒ½å›ç­”çš„é—®é¢˜
   - ä¸å¾—è®¾è®¡ç­”æ¡ˆæ¨¡ç³Šæˆ–æœ‰å¤šç§å¯èƒ½è§£é‡Šçš„é—®é¢˜

{"7. **å¤šè½®å¯¹è¯è¦æ±‚**ï¼šéœ€è¦è®¾è®¡" + rounds_text + "è½®å¯¹è¯ï¼Œæ¯è½®éƒ½æœ‰ç‹¬ç«‹çš„é—®é¢˜å’Œç­”æ¡ˆï¼Œå½¢æˆå®Œæ•´çš„å¯¹è¯æµç¨‹ã€‚æ¯è½®é—®é¢˜éƒ½åº”éµå¾ªä¸Šè¿°æ‰€æœ‰è¦æ±‚ï¼Œä¸”å„è½®ä¹‹é—´åº”å½¢æˆé€»è¾‘é€’è¿›æˆ–å…³è”ï¼ˆå¦‚ï¼šç¬¬1è½®è¯†åˆ«æ•°æ® â†’ ç¬¬2è½®è®¡ç®—æŒ‡æ ‡ â†’ ç¬¬3è½®ç»¼åˆåˆ¤æ–­ï¼‰ã€‚æ‰€æœ‰è½®æ¬¡çš„é—®é¢˜éƒ½å¿…é¡»é’ˆå¯¹åŒä¸€å¼ å›¾ç‰‡ã€‚" if is_multi_round else ""}
"""
    }
    '''
    æ˜¯å¦éœ€è¦
    4. **å…³äºç­”æ¡ˆæ ¼å¼çš„è¦æ±‚ï¼ˆé‡è¦ï¼‰**ï¼š
   - è‹¥ç­”æ¡ˆä¸ºæ˜ç¡®çš„**æ•°å€¼å‹ç­”æ¡ˆ**ï¼ˆå¦‚ç™¾åˆ†æ¯”ã€é‡‘é¢ã€å¢é•¿ç‡ã€æ¯”ç‡ç­‰ï¼‰ï¼Œåˆ™ä¸ºè®¡ç®—é¢˜ï¼Œä¸éœ€è¦è®¾ç½®é€‰é¡¹
   - è‹¥ç­”æ¡ˆ**ä¸æ˜¯å•ä¸€æ•°å€¼**ï¼Œä½†ä¾ç„¶å®¢è§‚å”¯ä¸€ï¼ˆå¦‚"å¢é•¿æœ€å¿«çš„æ˜¯æŸè¡Œä¸š""å æ¯”æœ€é«˜çš„æ˜¯æŸåœ°åŒº"ï¼‰ï¼Œåˆ™å¿…é¡»è®¾è®¡ä¸ºé€‰æ‹©é¢˜ï¼Œéœ€æä¾›åˆç†çš„å¹²æ‰°é€‰é¡¹
   - æ³¨æ„ï¼šé¢˜å‹ï¼ˆ{question_type_name_cn}ï¼‰å·²æŒ‡å®šï¼Œéœ€è¦ä¸¥æ ¼æŒ‰ç…§é¢˜å‹è¦æ±‚è®¾è®¡é¢˜ç›®
   '''

    # ğŸ”§ æ‰©å±•è¯´æ˜ï¼šæ·»åŠ æ–°å›¾ç‰‡ç±»å‹æ—¶ï¼Œåœ¨è¿™é‡Œæ·»åŠ å¯¹åº”çš„å®Œæ•´å‡ºé¢˜é€»è¾‘
    # prompts["video_frame"] = f"""
    # ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è§†è§‰æ¨ç†è¯„æµ‹å‡ºé¢˜ä¸“å®¶ã€‚è¯·åŸºäºè¿™å¼ å›¾ç‰‡çš„å†…å®¹ï¼Œè®¾è®¡ä¸€é“ã€{question_type_name_cn}ã€‘ã€‚
    # 
    # **å›¾ç‰‡ç±»å‹**: video_frameï¼ˆè§†é¢‘å¸§ç±»å‹ï¼‰
    # **å›¾ç‰‡ç‰¹ç‚¹**ï¼šåŒ…å«æ—¶é—´åºåˆ—ä¿¡æ¯ï¼Œæ˜¯è§†é¢‘ä¸­çš„ä¸€å¸§ã€‚
    # **å‡ºé¢˜é‡ç‚¹**ï¼šå…³æ³¨æ—¶é—´å˜åŒ–ã€åŠ¨ä½œè¯†åˆ«ã€åŠ¨æ€ç‰¹å¾ç­‰ã€‚
    # **å‡ºé¢˜è¦æ±‚**ï¼š
    # 1. **æ·±åº¦æ¨ç†**ï¼š...
    # 2. **æ—¶é—´åˆ†æ**ï¼š...
    # 3. **æ€ç»´é“¾**ï¼š...
    # """
    
    return prompts.get(image_type, prompts["mixed"])  # é»˜è®¤ä½¿ç”¨ mixed ç±»å‹

def get_question_type_specific_requirements(question_type: str) -> str:
    """
    è·å–ç‰¹å®šé—®é¢˜ç±»å‹çš„è¦æ±‚å’Œè¾“å‡ºæ ¼å¼
    ğŸ”§ æ‰©å±•è¯´æ˜ï¼šæ·»åŠ æ–°é—®é¢˜ç±»å‹æ—¶ï¼Œåªéœ€åœ¨è¿™é‡Œæ·»åŠ å¯¹åº”çš„è¦æ±‚
    æ³¨æ„ï¼šæ¯æ¬¡åªç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥è¾“å‡ºæ ¼å¼æ˜¯å•ä¸ªå¯¹è±¡ï¼Œä¸æ˜¯æ•°ç»„
    """
    requirements = {
        "single_choice": """
**æ ¼å¼è§„èŒƒ**ï¼šå¿…é¡»æä¾› A, B, C, D å››ä¸ªé€‰é¡¹ï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªæ˜¯æ­£ç¡®ç­”æ¡ˆã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼š
{{
    "question_type": "å››é€‰å•é€‰",
    "question": "é—®é¢˜å†…å®¹...",
    "options": {{"A": "...", "B": "...", "C": "...", "D": "..."}},
    "qa_make_process": "æ¨ç†è¿‡ç¨‹...",
    "answer": "ä¸€ä¸ªé€‰é¡¹å­—æ¯"
}}
""",
        "multiple_choice": """
**æ ¼å¼è§„èŒƒ**ï¼šå¿…é¡»æä¾› A, B, C, D å››ä¸ªé€‰é¡¹ï¼Œå…¶ä¸­è‡³å°‘æœ‰ä¸¤ä¸ªæ˜¯æ­£ç¡®ç­”æ¡ˆã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼š
{{
    "question_type": "å››é€‰å¤šé€‰",
    "question": "é—®é¢˜å†…å®¹...",
    "options": {{"A": "...", "B": "...", "C": "...", "D": "..."}},
    "qa_make_process": "æ¨ç†è¿‡ç¨‹...",
    "answer": "å¤šä¸ªé€‰é¡¹å­—æ¯"  // å¤šä¸ªæ­£ç¡®ç­”æ¡ˆç”¨å­—æ¯ç»„åˆï¼Œå¦‚ "AB", "ACD" ç­‰
}}
""",
        "true_false": """
**æ ¼å¼è§„èŒƒ**ï¼šåˆ¤æ–­é¢˜çš„é€‰é¡¹å›ºå®šä¸ºnullï¼Œansweræ˜¯ true æˆ–è€… falseï¼Œ

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼š
{{
    "question_type": "åˆ¤æ–­é¢˜",
    "question": "é—®é¢˜å†…å®¹...",
    "options": null,
    "qa_make_process": "æ¨ç†è¿‡ç¨‹...",
    "answer": "true" æˆ–è€… "false" // trueè¡¨ç¤ºæ­£ç¡®ï¼Œfalseè¡¨ç¤ºé”™è¯¯
}}
""",
        "essay": """
**ç­”æ¡ˆç®€ç»ƒ**ï¼šç­”æ¡ˆå¿…é¡»æ˜¯å…·ä½“çš„å®ä½“åç§°ã€æ•°å­—ç»“æœæˆ–å…³é”®çŸ­è¯­ã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼š
{{
    "question_type": "é—®ç­”é¢˜",
    "question": "é—®é¢˜å†…å®¹...",
    "options": null,
    "qa_make_process": "æ¨ç†è¿‡ç¨‹...",
    "answer": "æ­£ç¡®ç­”æ¡ˆ"
}}
""",
        "multi_round_single_choice": """
**æ ¼å¼è§„èŒƒ**ï¼šå¤šè½®å•é€‰é¢˜éœ€è¦è®¾è®¡å¤šè½®å¯¹è¯ï¼Œæ¯è½®éƒ½æ˜¯å•é€‰é¢˜ï¼Œå¿…é¡»æä¾› A, B, C, D å››ä¸ªé€‰é¡¹ã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼ŒåŒ…å« round1, round2, round3 ç­‰å­—æ®µï¼ˆæ ¹æ®æŒ‡å®šçš„è½®æ•°ç”Ÿæˆå¯¹åº”æ•°é‡çš„å­—æ®µï¼‰ã€‚
""",
        "multi_round_essay": """
**æ ¼å¼è§„èŒƒ**ï¼šå¤šè½®é—®ç­”é¢˜éœ€è¦è®¾è®¡å¤šè½®å¯¹è¯ï¼Œæ¯è½®éƒ½æ˜¯é—®ç­”é¢˜ï¼Œç­”æ¡ˆå¿…é¡»æ˜¯å…·ä½“çš„å®ä½“åç§°ã€æ•°å­—ç»“æœæˆ–å…³é”®çŸ­è¯­ã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼ŒåŒ…å« round1, round2, round3 ç­‰å­—æ®µï¼ˆæ ¹æ®æŒ‡å®šçš„è½®æ•°ç”Ÿæˆå¯¹åº”æ•°é‡çš„å­—æ®µï¼‰ã€‚
"""
    }
    
    # ğŸ”§ æ‰©å±•è¯´æ˜ï¼šæ·»åŠ æ–°é—®é¢˜ç±»å‹æ—¶ï¼Œåœ¨è¿™é‡Œæ·»åŠ å¯¹åº”çš„è¦æ±‚
    # requirements["fill_blank"] = """
    # **æ ¼å¼è§„èŒƒ**ï¼šå¡«ç©ºé¢˜éœ€è¦æä¾›ç©ºç™½ä½ç½®ï¼Œç­”æ¡ˆåº”ç®€æ´æ˜ç¡®ã€‚
    # ...
    # """
    
    return requirements.get(question_type, requirements["essay"])  # é»˜è®¤ä½¿ç”¨é—®ç­”é¢˜æ ¼å¼


def build_prompt_template(image_type: str, question_type: str, rounds: int = 3) -> str:
    """
    æ„å»ºå®Œæ•´çš„æç¤ºè¯æ¨¡æ¿
    ğŸ”§ æ‰©å±•è¯´æ˜ï¼šè¿™ä¸ªå‡½æ•°ä¼šè‡ªåŠ¨ç»„åˆæ‰€æœ‰éƒ¨åˆ†ï¼Œæ— éœ€ä¿®æ”¹
    æ³¨æ„ï¼šç°åœ¨åªç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥ä¸éœ€è¦ count å‚æ•°
    æç¤ºè¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šå›¾ç‰‡ç±»å‹å‡ºé¢˜é€»è¾‘ + é¢˜ç›®ç±»å‹è¦æ±‚ï¼ˆåŒ…æ‹¬è¾“å‡ºæ ¼å¼ï¼‰
    rounds: å¤šè½®å¯¹è¯çš„è½®æ•°ï¼ˆä»…ç”¨äºå¤šè½®å¯¹è¯é¢˜å‹ï¼‰
    """
    question_type_name_cn = QUESTION_TYPES.get(question_type, "é—®ç­”é¢˜")
    
    # ç»„åˆä¸¤éƒ¨åˆ†ï¼šå›¾ç‰‡ç±»å‹å‡ºé¢˜é€»è¾‘ + é¢˜ç›®ç±»å‹è¦æ±‚ï¼ˆåŒ…æ‹¬è¾“å‡ºæ ¼å¼ï¼‰
    image_prompt = get_image_type_prompt(image_type, question_type_name_cn, rounds)
    type_requirements = get_question_type_specific_requirements(question_type)
    
    # å¦‚æœæ˜¯å¤šè½®å¯¹è¯ï¼ŒåŠ¨æ€ç”Ÿæˆè¾“å‡ºæ ¼å¼ç¤ºä¾‹
    if "multi_round" in question_type:
        # ç”Ÿæˆè½®æ•°å­—æ®µåˆ—è¡¨
        rounds_list = [f"round{i+1}" for i in range(rounds)]
        
        # ç”Ÿæˆç¤ºä¾‹æ ¼å¼
        question_example = ",\n        ".join([f'"{r}": "ç¬¬{i+1}è½®é—®é¢˜å†…å®¹..."' for i, r in enumerate(rounds_list)])
        
        if "single_choice" in question_type:
            # å¤šè½®å•é€‰é¢˜
            options_example = ",\n        ".join([f'"{r}": {{"A": "...", "B": "...", "C": "...", "D": "..."}}' for r in rounds_list])
            answer_example = ",\n        ".join([f'"{r}": "ä¸€ä¸ªé€‰é¡¹å­—æ¯"' for r in rounds_list])
            process_example = ",\n        ".join([f'"{r}": "ç¬¬{i+1}è½®æ¨ç†è¿‡ç¨‹..."' for i, r in enumerate(rounds_list)])
            
            format_example = f"""
**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼ŒåŒ…å« {rounds} è½®å¯¹è¯å­—æ®µï¼š
{{
    "question_type": "å¤šè½®å•é€‰é¢˜",
    "question": {{
        {question_example}
    }},
    "options": {{
        {options_example}
    }},
    "qa_make_process": {{
        {process_example}
    }},
    "answer": {{
        {answer_example}
    }}
}}
"""
        else:
            # å¤šè½®é—®ç­”é¢˜
            process_example = ",\n        ".join([f'"{r}": "ç¬¬{i+1}è½®æ¨ç†è¿‡ç¨‹..."' for i, r in enumerate(rounds_list)])
            answer_example = ",\n        ".join([f'"{r}": "ç¬¬{i+1}è½®ç­”æ¡ˆ"' for i, r in enumerate(rounds_list)])
            
            format_example = f"""
**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼ŒåŒ…å« {rounds} è½®å¯¹è¯å­—æ®µï¼š
{{
    "question_type": "å¤šè½®é—®ç­”é¢˜",
    "question": {{
        {question_example}
    }},
    "options": null,
    "qa_make_process": {{
        {process_example}
    }},
    "answer": {{
        {answer_example}
    }}
}}
"""
        
        type_requirements = type_requirements + format_example
    
    # æ‹¼æ¥ï¼šå›¾ç‰‡ç±»å‹æç¤ºè¯ + é¢˜ç›®ç±»å‹è¦æ±‚
    prompt = image_prompt + type_requirements
    return prompt

# åˆå§‹åŒ–æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿï¼ˆå»¶è¿Ÿç”Ÿæˆï¼ŒæŒ‰éœ€æ„å»ºï¼‰
PROMPT_TEMPLATES = {}

def get_prompt_template(image_type: str, question_type: str, count: int = 1, rounds: int = 3) -> str:
    """
    è·å–æç¤ºè¯æ¨¡æ¿ï¼ˆå»¶è¿Ÿç”Ÿæˆï¼Œæ”¯æŒåŠ¨æ€æ‰©å±•ï¼‰
    ğŸ”§ æ‰©å±•è¯´æ˜ï¼šæ·»åŠ æ–°ç±»å‹åï¼Œè¿™ä¸ªå‡½æ•°ä¼šè‡ªåŠ¨æ”¯æŒï¼Œæ— éœ€ä¿®æ”¹
    æ³¨æ„ï¼šcount å‚æ•°ä¿ç•™ä»¥å…¼å®¹æ—§ä»£ç ï¼Œä½†å®é™…ä¸å†ä½¿ç”¨ï¼ˆæ¯æ¬¡åªç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼‰
    rounds: å¤šè½®å¯¹è¯çš„è½®æ•°ï¼ˆä»…ç”¨äºå¤šè½®å¯¹è¯é¢˜å‹ï¼‰
    """
    # å¯¹äºå¤šè½®å¯¹è¯ï¼Œéœ€è¦åŒ…å«è½®æ•°ä¿¡æ¯åœ¨ç¼“å­˜é”®ä¸­
    if "multi_round" in question_type:
        cache_key = f"{image_type}_{question_type}_r{rounds}"
    else:
        cache_key = f"{image_type}_{question_type}"
    
    if cache_key not in PROMPT_TEMPLATES:
        PROMPT_TEMPLATES[cache_key] = build_prompt_template(image_type, question_type, rounds)
    
    return PROMPT_TEMPLATES[cache_key]

# ==============================================================================
# âš™ï¸ å…¨å±€å˜é‡ä¸é”
# ==============================================================================
client = None
file_lock = threading.Lock()
buffer_lock = threading.Lock()
result_buffer = [] 
stats = {"success": 0, "failed": 0, "images_processed": 0, "questions_generated": 0}
OUTPUT_PATH = "" 
CURRENT_IMAGE_TYPE = ""
CURRENT_QUESTION_TYPE = ""
FIRST_ITEM_PROCESSED = False  # ç”¨äºæ ‡è®°æ˜¯å¦å·²å¤„ç†ç¬¬ä¸€é“é¢˜ï¼ˆç”¨äºè°ƒè¯•è¾“å‡ºï¼‰
progress_bar = None  # è¿›åº¦æ¡å¯¹è±¡
progress_lock = threading.Lock()  # è¿›åº¦æ¡æ›´æ–°é”
LOG_FILE = None  # æ—¥å¿—æ–‡ä»¶å¯¹è±¡
log_lock = threading.Lock()  # æ—¥å¿—å†™å…¥é”

# ==============================================================================
# ğŸ› ï¸ å·¥å…·å‡½æ•°
# ==============================================================================
def get_next_version_path(original_path):
    if not os.path.exists(original_path): return original_path
    dir_name, file_name = os.path.split(original_path)
    base_name, ext = os.path.splitext(file_name)
    counter = 2
    while True:
        new_name = f"{base_name}_v{counter}{ext}"
        new_path = os.path.join(dir_name, new_name)
        if not os.path.exists(new_path): return new_path
        counter += 1

def init_log_file(log_dir: str, args) -> str:
    """
    åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶
    è¿”å›æ—¥å¿—æ–‡ä»¶è·¯å¾„
    """
    global LOG_FILE
    
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    if not os.path.exists(log_dir):
        os.makedirs(log_dir, exist_ok=True)
    
    # ç”Ÿæˆæ—¥å¿—æ–‡ä»¶åï¼ˆåŒ…å«è¿è¡Œå‚æ•°å’Œæ—¶é—´æˆ³ï¼‰
    timestamp = time.strftime("%Y%m%d_%H%M%S")
    log_filename = f"{timestamp}_{args.image_type}_{args.question_type}_num{args.num}"
    if "multi_round" in args.question_type:
        log_filename += f"_rounds{args.rounds}"
    log_filename += ".log"
    
    log_path = os.path.join(log_dir, log_filename)
    
    # æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼ˆè¿½åŠ æ¨¡å¼ï¼‰
    LOG_FILE = open(log_path, "w", encoding="utf-8")
    
    # å†™å…¥è¿è¡Œå‚æ•°
    LOG_FILE.write("="*80 + "\n")
    LOG_FILE.write("ğŸ“‹ è¿è¡Œå‚æ•°\n")
    LOG_FILE.write("="*80 + "\n")
    LOG_FILE.write(f"è¿è¡Œæ—¶é—´: {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
    LOG_FILE.write(f"è¾“å…¥æ–‡ä»¶: {args.input}\n")
    LOG_FILE.write(f"è¾“å‡ºæ–‡ä»¶: {args.output}\n")
    LOG_FILE.write(f"å›¾ç‰‡ç±»å‹: {args.image_type}\n")
    LOG_FILE.write(f"é—®é¢˜ç±»å‹: {args.question_type}\n")
    LOG_FILE.write(f"æ¯å¼ å›¾ç‰‡ç”Ÿæˆé—®é¢˜æ•°: {args.num}\n")
    if "multi_round" in args.question_type:
        LOG_FILE.write(f"å¤šè½®å¯¹è¯è½®æ•°: {args.rounds}\n")
    LOG_FILE.write(f"æ¨¡å‹: {args.model}\n")
    LOG_FILE.write(f"API Base: {args.api_base}\n")
    LOG_FILE.write(f"æ¸©åº¦: {args.temp}\n")
    LOG_FILE.write(f"æœ€å¤§Tokenæ•°: {args.tokens}\n")
    LOG_FILE.write(f"å¹¶å‘çº¿ç¨‹æ•°: {args.workers}\n")
    LOG_FILE.write(f"æ‰¹é‡å†™å…¥å¤§å°: {args.batch}\n")
    LOG_FILE.write(f"æ–­ç‚¹ç»­ä¼ : {args.resume}\n")
    LOG_FILE.write(f"å¯ç”¨æ€è€ƒæ¨¡å¼: {args.enable_thinking}\n")
    if args.limit:
        LOG_FILE.write(f"é™åˆ¶å¤„ç†æ•°é‡: {args.limit}\n")
    LOG_FILE.write("="*80 + "\n")
    LOG_FILE.write("\n")
    LOG_FILE.flush()
    
    return log_path

def log_model_response(image_id: str, question_index: int, response, prompt: str = ""):
    """
    è®°å½•æ¨¡å‹è¿”å›çš„æ—¥å¿—
    """
    global LOG_FILE
    
    if LOG_FILE is None:
        return
    
    with log_lock:
        try:
            LOG_FILE.write("="*80 + "\n")
            LOG_FILE.write(f"ğŸ“ æ¨¡å‹è¿”å›æ—¥å¿— - image_id: {image_id}, question_index: {question_index}\n")
            LOG_FILE.write(f"æ—¶é—´: {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
            LOG_FILE.write("-"*80 + "\n")
            
            # è®°å½•æç¤ºè¯ï¼ˆå¯é€‰ï¼Œå¦‚æœå¤ªé•¿å¯ä»¥æˆªæ–­ï¼‰
            if prompt:
                prompt_preview = prompt[:500] + "..." if len(prompt) > 500 else prompt
                LOG_FILE.write(f"æç¤ºè¯é¢„è§ˆ: {prompt_preview}\n")
                LOG_FILE.write("-"*80 + "\n")
            
            # è®°å½•å“åº”å¯¹è±¡
            try:
                if hasattr(response, 'model_dump'):
                    response_dict = response.model_dump()
                else:
                    # å°è¯•æ‰‹åŠ¨æ„å»ºå­—å…¸
                    response_dict = {
                        "id": getattr(response, 'id', None),
                        "object": getattr(response, 'object', None),
                        "created": getattr(response, 'created', None),
                        "model": getattr(response, 'model', None),
                    }
                    if hasattr(response, 'choices') and len(response.choices) > 0:
                        choice = response.choices[0]
                        choice_dict = {
                            "index": getattr(choice, 'index', None),
                            "finish_reason": getattr(choice, 'finish_reason', None),
                        }
                        if hasattr(choice, 'message'):
                            message = choice.message
                            message_dict = {
                                "role": getattr(message, 'role', None),
                                "content": getattr(message, 'content', None),
                            }
                            # æ£€æŸ¥æ˜¯å¦æœ‰ reasoning_content
                            if hasattr(message, 'reasoning_content'):
                                message_dict["reasoning_content"] = message.reasoning_content
                            choice_dict["message"] = message_dict
                        response_dict["choices"] = [choice_dict]
                
                LOG_FILE.write("å®Œæ•´å“åº”å¯¹è±¡:\n")
                LOG_FILE.write(json.dumps(response_dict, indent=2, ensure_ascii=False, default=str))
                LOG_FILE.write("\n")
            except Exception as e:
                LOG_FILE.write(f"âš ï¸ æ— æ³•åºåˆ—åŒ–å“åº”å¯¹è±¡: {e}\n")
                LOG_FILE.write(f"å“åº”å¯¹è±¡å­—ç¬¦ä¸²: {str(response)}\n")
            
            LOG_FILE.write("="*80 + "\n")
            LOG_FILE.write("\n")
            LOG_FILE.flush()
        except Exception as e:
            print(f"âš ï¸ å†™å…¥æ—¥å¿—å¤±è´¥: {e}")

def close_log_file():
    """
    å…³é—­æ—¥å¿—æ–‡ä»¶
    """
    global LOG_FILE
    if LOG_FILE:
        with log_lock:
            try:
                LOG_FILE.write("="*80 + "\n")
                LOG_FILE.write(f"æ—¥å¿—ç»“æŸæ—¶é—´: {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
                LOG_FILE.write("="*80 + "\n")
                LOG_FILE.close()
                LOG_FILE = None
            except:
                pass

def encode_image(image_path):
    try:
        if not os.path.exists(image_path): return None
        with open(image_path, "rb") as image_file:
            return base64.b64encode(image_file.read()).decode('utf-8')
    except: return None

def flush_buffer():
    global result_buffer
    with buffer_lock:
        if not result_buffer: return
        current_batch = list(result_buffer)
        result_buffer = [] 
    
    with file_lock:
        data = []
        if os.path.exists(OUTPUT_PATH):
            try:
                with open(OUTPUT_PATH, "r", encoding="utf-8") as f:
                    content = f.read().strip()
                    if content: data = json.loads(content)
            except: data = []
        data.extend(current_batch)
        try:
            with open(OUTPUT_PATH, "w", encoding="utf-8") as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
            print(f"ğŸ’¾ [è‡ªåŠ¨ä¿å­˜] å†™å…¥ {len(current_batch)} æ¡æ•°æ® | æ€»æ•°: {len(data)}")
        except Exception as e: print(f"âŒ å†™å…¥å¤±è´¥: {e}")

# ==============================================================================
# ğŸ§  æ ¸å¿ƒç”Ÿæˆé€»è¾‘
# ==============================================================================

def generate_single_qa(item, image_type, question_type, question_index, total_count):
    """
    ç”Ÿæˆå•ä¸ªé—®é¢˜ï¼ˆä¸€æ¬¡å¯¹è¯ç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼‰
    è¾“å…¥: 
        - item: å•ä¸ªå›¾ç‰‡ä¿¡æ¯
        - image_type: å›¾ç‰‡ç±»å‹
        - question_type: é—®é¢˜ç±»å‹
        - question_index: å½“å‰é—®é¢˜ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰
        - total_count: æ€»å…±è¦ç”Ÿæˆçš„é—®é¢˜æ•°
    è¾“å‡º: å•ä¸ªé—®ç­”å¯¹å­—å…¸ï¼Œå¦‚æœå¤±è´¥è¿”å› None
    """
    image_path = item.get("image_path")
    original_id = str(item.get("id", "unknown"))
    
    # ç¡®ä¿ image_type ä» item ä¸­è·å–æˆ–ä½¿ç”¨ä¼ å…¥çš„å‚æ•°
    item_image_type = item.get("image_type") or item.get("type") or image_type
    
    base64_image = encode_image(image_path)
    if not base64_image: return None

    # è·å–å¯¹åº”ç»„åˆçš„æç¤ºè¯æ¨¡æ¿ï¼ˆæ¯æ¬¡ç”Ÿæˆ1ä¸ªé—®é¢˜ï¼‰
    template_key = item_image_type.lower()
    # å¦‚æœå›¾ç‰‡ç±»å‹ä¸åœ¨æ”¯æŒçš„åˆ—è¡¨ä¸­ï¼ˆæ’é™¤"all"ï¼‰ï¼Œé»˜è®¤ä½¿ç”¨ mixed
    valid_image_types = [t for t in IMAGE_TYPES if t != "all"]
    if template_key not in valid_image_types:
        template_key = "mixed"  # é»˜è®¤ä½¿ç”¨ mixed
    
    question_type_key = question_type.lower()
    if question_type_key not in QUESTION_TYPES:
        question_type_key = "essay"
    
    # è·å–è½®æ•°ï¼ˆä»…ç”¨äºå¤šè½®å¯¹è¯é¢˜å‹ï¼‰
    rounds = GLOBAL_CONFIG["rounds"]
    
    # ä½¿ç”¨æ–°çš„æ¨¡æ¿æ„å»ºå‡½æ•°ï¼ˆæ¯æ¬¡åªç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼‰
    prompt = get_prompt_template(template_key, question_type_key, rounds=rounds)

    # è·å–é…ç½®å‚æ•°ï¼ˆè¿™äº›keyåœ¨main()ä¸­å·²ç¡®ä¿å­˜åœ¨ï¼‰
    max_retries = int(GLOBAL_CONFIG["max_retries"])
    base_sleep = float(GLOBAL_CONFIG["retry_sleep"])
    timeout = float(GLOBAL_CONFIG["request_timeout"])

    for attempt in range(max_retries):
        try:
            # æ„å»º API è°ƒç”¨å‚æ•°
            api_params = {
                "model": GLOBAL_CONFIG["model_name"],
                "messages": [
                    {
                        "role": "user",
                        "content": [
                            {"type": "text", "text": prompt},
                            {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}},
                        ],
                    }
                ],
                "max_tokens": GLOBAL_CONFIG["max_tokens"],
                "temperature": GLOBAL_CONFIG["temperature"],
                "timeout": timeout,
            }
            
            # å¦‚æœå¯ç”¨æ€è€ƒæ¨¡å¼ï¼Œæ·»åŠ  extra_body
            if GLOBAL_CONFIG.get("enable_thinking", False):
                api_params["extra_body"] = {"enable_thinking": True}
            
            response = client.chat.completions.create(**api_params)
            
            # è®°å½•æ¨¡å‹è¿”å›æ—¥å¿—
            log_model_response(original_id, question_index, response, prompt)
            
            # ==================== è°ƒè¯•ï¼šæ‰“å°ç¬¬ä¸€é“é¢˜çš„åŸå§‹å“åº” ====================
            global FIRST_ITEM_PROCESSED, progress_bar
            is_first_item = not FIRST_ITEM_PROCESSED and question_index == 0
            if is_first_item:
                FIRST_ITEM_PROCESSED = True
                print("\n" + "="*80)
                print(f"ğŸ” [è°ƒè¯•] ç¬¬ä¸€é“é¢˜çš„æ¨¡å‹åŸå§‹è¿”å›è¾“å‡º (image_id: {original_id}, question_index: {question_index})")
                print("="*80)
                print(f"ğŸ“‹ å“åº”å¯¹è±¡ç±»å‹: {type(response)}")
                print(f"ğŸ“‹ å“åº”å¯¹è±¡å±æ€§: {dir(response)}")
                
                # æ‰“å°å®Œæ•´çš„å“åº”å¯¹è±¡ï¼ˆè½¬æ¢ä¸ºå­—å…¸ï¼‰
                try:
                    response_dict = response.model_dump() if hasattr(response, 'model_dump') else str(response)
                    print(f"\nğŸ“¦ å®Œæ•´å“åº”å¯¹è±¡:")
                    print(json.dumps(response_dict, indent=2, ensure_ascii=False, default=str))
                except Exception as e:
                    print(f"âš ï¸ æ— æ³•åºåˆ—åŒ–å“åº”å¯¹è±¡: {e}")
                    print(f"ğŸ“¦ å“åº”å¯¹è±¡å­—ç¬¦ä¸²: {str(response)}")
                
                # æ£€æŸ¥ choices[0] çš„ç»“æ„
                if hasattr(response, 'choices') and len(response.choices) > 0:
                    choice = response.choices[0]
                    print(f"\nğŸ“‹ choice å¯¹è±¡ç±»å‹: {type(choice)}")
                    print(f"ğŸ“‹ choice å¯¹è±¡å±æ€§: {dir(choice)}")
                    
                    if hasattr(choice, 'message'):
                        message = choice.message
                        print(f"\nğŸ“‹ message å¯¹è±¡ç±»å‹: {type(message)}")
                        print(f"ğŸ“‹ message å¯¹è±¡å±æ€§: {dir(message)}")
                        
                        # æ£€æŸ¥æ˜¯å¦æœ‰ reasoning_content
                        if hasattr(message, 'reasoning_content'):
                            rc = message.reasoning_content
                            if rc:
                                # æœ‰å­—æ®µä¸”ä¸ä¸ºç©ºï¼Œå®‰å…¨æˆªæ–­æ‰“å°
                                print(f"\nâœ… æ‰¾åˆ° reasoning_content: {str(rc)[:500]}...")
                            else:
                                # æœ‰å­—æ®µä½†ä¸º None æˆ–ç©º
                                print(f"\nâ„¹ï¸ å­˜åœ¨ reasoning_content å­—æ®µï¼Œä½†å€¼ä¸ºç©ºæˆ– None")
                        else:
                            print(f"\nâŒ æœªæ‰¾åˆ° reasoning_content å±æ€§")
                        
                        # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ¨ç†ç›¸å…³å­—æ®µ
                        reasoning_fields = [attr for attr in dir(message) if 'reason' in attr.lower() or 'think' in attr.lower()]
                        if reasoning_fields:
                            print(f"\nğŸ” å‘ç°æ¨ç†ç›¸å…³å­—æ®µ: {reasoning_fields}")
                            for field in reasoning_fields:
                                try:
                                    value = getattr(message, field)
                                    print(f"  - {field}: {str(value)[:200]}...")
                                except:
                                    pass
                    
                    # æ£€æŸ¥å“åº”å¯¹è±¡æœ¬èº«æ˜¯å¦æœ‰ reasoning_content
                    if hasattr(response, 'reasoning_content'):
                        print(f"\nâœ… å“åº”å¯¹è±¡æœ‰ reasoning_content: {response.reasoning_content[:500]}...")
                
                print("="*80 + "\n")

                # è°ƒè¯•æ‰“å°å®Œåï¼Œåˆ·æ–°ä¸€æ¬¡è¿›åº¦æ¡ï¼Œé¿å…è¿›åº¦ä¿¡æ¯è¢«é¡¶åˆ°å±å¹•ä¸Šæ–¹
                if TQDM_AVAILABLE and progress_bar:
                    try:
                        with progress_lock:
                            progress_bar.refresh()
                    except Exception as e:
                        print(f"âš ï¸ åˆ·æ–°è¿›åº¦æ¡å¤±è´¥: {e}")
            # ==================== è°ƒè¯•ç»“æŸ ====================
            
            content = response.choices[0].message.content.strip() if response.choices[0].message.content else ""
            message = response.choices[0].message
            
            # ==================== æ™ºèƒ½æå– JSON å’Œæ€è€ƒå†…å®¹ ====================
            # æ ¸å¿ƒé€»è¾‘ï¼š
            # 1. ä¼˜å…ˆä» content ä¸­æå– JSONï¼ˆå¤§å¤šæ•°æ¨¡å‹éƒ½åœ¨è¿™é‡Œè¾“å‡ºï¼‰
            # 2. content ä¸­é™¤ JSON å¤–çš„éƒ¨åˆ†éƒ½å½“ä½œæ€è€ƒè¿‡ç¨‹
            # 3. å¦‚æœ content ä¸­æ²¡æœ‰ JSONï¼Œå†ä» reasoning_content ä¸­æå–
            # 4. åˆå¹¶æ‰€æœ‰æ€è€ƒå†…å®¹
            
            qa_data = None
            json_source = None
            thinking_parts = []  # å­˜å‚¨æ‰€æœ‰æ€è€ƒå†…å®¹
            
            # ğŸ“ è¾…åŠ©å‡½æ•°ï¼šä»æ–‡æœ¬ä¸­æå– JSON
            def extract_json_from_text(text, source_name):
                """
                ä»æ–‡æœ¬ä¸­æå– JSONï¼Œè¿”å› (json_data, before_text, after_text)
                json_data: è§£æåçš„ JSON å¯¹è±¡
                before_text: JSON å‰çš„æ–‡æœ¬ï¼ˆæ€è€ƒè¿‡ç¨‹ï¼‰
                after_text: JSON åçš„æ–‡æœ¬ï¼ˆæ€è€ƒè¿‡ç¨‹ï¼‰
                """
                if not text:
                    return None, "", ""
                
                # æ–¹æ³•1: æå– ```json``` ä»£ç å—ï¼ˆæœ€ä¼˜å…ˆï¼Œæœ€æ˜ç¡®ï¼‰
                if "```json" in text:
                    parts = text.split("```json", 1)
                    before = parts[0].strip()
                    json_and_after = parts[1].split("```", 1)
                    json_str = json_and_after[0].strip()
                    after = json_and_after[1].strip() if len(json_and_after) > 1 else ""
                    
                    try:
                        json_data = json.loads(json_str)
                        print(f"âœ… [JSONæå–] ä» {source_name} çš„ ```json``` ä»£ç å—ä¸­æˆåŠŸæå–")
                        return json_data, before, after
                    except Exception as e:
                        print(f"âš ï¸ [JSONæå–] {source_name} çš„ ```json``` ä»£ç å—è§£æå¤±è´¥: {e}")
                        # å°è¯•æ¸…ç† JSON å­—ç¬¦ä¸²åå†è§£æ
                        try:
                            # ç§»é™¤å¯èƒ½çš„æ³¨é‡Šå’Œå¤šä½™ç©ºç™½
                            cleaned_json = re.sub(r'//.*?\n|/\*.*?\*/', '', json_str, flags=re.DOTALL)
                            json_data = json.loads(cleaned_json)
                            print(f"âœ… [JSONæå–] {source_name} çš„ ```json``` ä»£ç å—æ¸…ç†åè§£ææˆåŠŸ")
                            return json_data, before, after
                        except:
                            pass
                        
                        # å¦‚æœ ```json``` ä»£ç å—å­˜åœ¨ä½†æ— æ³•è§£æï¼Œä¸å†å°è¯•å…¶ä»–æ–¹æ³•
                        # å› ä¸ºè¿™æ˜¯æœ€æ˜ç¡®çš„ JSON æ ‡è®°ï¼Œè§£æå¤±è´¥è¯´æ˜çœŸçš„æœ‰é—®é¢˜
                        print(f"âŒ [JSONæå–] {source_name} çš„ ```json``` ä»£ç å—æ— æ³•è§£æï¼Œåœæ­¢å°è¯•")
                        return None, before, after
                
                # æ–¹æ³•2: æå–æ™®é€š ``` ä»£ç å—
                if "```" in text:
                    parts = text.split("```", 2)
                    if len(parts) >= 2:
                        before = parts[0].strip()
                        json_str = parts[1].strip()
                        after = parts[2].strip() if len(parts) > 2 else ""
                        
                        # æ£€æŸ¥ä»£ç å—æ˜¯å¦ä»¥ JSON å¼€å¤´
                        if json_str.startswith("{") or json_str.startswith("["):
                            try:
                                json_data = json.loads(json_str)
                                print(f"âœ… [JSONæå–] ä» {source_name} çš„ ``` ä»£ç å—ä¸­æˆåŠŸæå–")
                                return json_data, before, after
                            except Exception as e:
                                print(f"âš ï¸ [JSONæå–] {source_name} çš„ ``` ä»£ç å—è§£æå¤±è´¥: {e}")
                
                # æ–¹æ³•3: ä½¿ç”¨æ ˆåŒ¹é…æå–å®Œæ•´çš„ JSONï¼ˆæ”¯æŒä»»æ„åµŒå¥—ï¼‰
                def find_json_by_brackets(s):
                    """ä½¿ç”¨æ ˆåŒ¹é…æ‰¾åˆ°å®Œæ•´çš„ JSON å¯¹è±¡æˆ–æ•°ç»„ï¼Œå¿½ç•¥å­—ç¬¦ä¸²å†…éƒ¨çš„æ‹¬å·"""
                    for start_idx, char in enumerate(s):
                        if char not in ['{', '[']:
                            continue
                        
                        stack = [char]
                        pairs = {'}': '{', ']': '['}
                        in_string = False
                        escape = False
                        
                        for end_idx in range(start_idx + 1, len(s)):
                            c = s[end_idx]
                            
                            # å¤„ç†è½¬ä¹‰å­—ç¬¦
                            if escape:
                                escape = False
                                continue
                            
                            if c == '\\':
                                escape = True
                                continue
                            
                            # å¤„ç†å­—ç¬¦ä¸²è¾¹ç•Œ
                            if c == '"':
                                in_string = not in_string
                                continue
                            
                            # å¦‚æœåœ¨å­—ç¬¦ä¸²å†…éƒ¨ï¼Œè·³è¿‡æ‹¬å·å¤„ç†
                            if in_string:
                                continue
                            
                            # å¤„ç†æ‹¬å·åŒ¹é…
                            if c in ['{', '[']:
                                stack.append(c)
                            elif c in ['}', ']']:
                                if not stack or stack[-1] != pairs[c]:
                                    break
                                stack.pop()
                                if not stack:  # æ‰¾åˆ°å®Œæ•´åŒ¹é…
                                    return start_idx, end_idx + 1
                        
                        # å¦‚æœè¿™ä¸ªèµ·ç‚¹æ²¡æ‰¾åˆ°å®Œæ•´åŒ¹é…ï¼Œç»§ç»­æ‰¾ä¸‹ä¸€ä¸ª
                        continue
                    
                    return None, None
                
                start_idx, end_idx = find_json_by_brackets(text)
                if start_idx is not None and end_idx is not None:
                    json_str = text[start_idx:end_idx]
                    before = text[:start_idx].strip()
                    after = text[end_idx:].strip()
                    
                    try:
                        json_data = json.loads(json_str)
                        print(f"âœ… [JSONæå–] ä» {source_name} ä¸­ä½¿ç”¨æ ˆåŒ¹é…æå– JSON æˆåŠŸ")
                        return json_data, before, after
                    except Exception as e:
                        print(f"âš ï¸ [JSONæå–] {source_name} çš„æ ˆåŒ¹é… JSON è§£æå¤±è´¥: {e}")
                
                # æ–¹æ³•4: å°è¯•ç›´æ¥è§£ææ•´ä¸ªæ–‡æœ¬ï¼ˆæœ€åçš„å°è¯•ï¼‰
                text_stripped = text.strip()
                if text_stripped.startswith("{") or text_stripped.startswith("["):
                    try:
                        json_data = json.loads(text_stripped)
                        print(f"âœ… [JSONæå–] {source_name} æ•´ä½“è§£æä¸º JSON æˆåŠŸ")
                        return json_data, "", ""
                    except Exception as e:
                        print(f"âš ï¸ [JSONæå–] {source_name} æ•´ä½“è§£æå¤±è´¥: {e}")
                        
                        # æœ€åçš„å°è¯•ï¼šå¤„ç†å•å¼•å· JSONï¼ˆéæ ‡å‡†ä½†æœ‰äº›æ¨¡å‹ä¼šè¾“å‡ºï¼‰
                        try:
                            # ç®€å•æ›¿æ¢å•å¼•å·ä¸ºåŒå¼•å·ï¼ˆæ³¨æ„ï¼šè¿™ä¸æ˜¯å®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼Œä½†å¯ä»¥å¤„ç†ç®€å•æƒ…å†µï¼‰
                            fixed_json = text_stripped.replace("'", '"')
                            json_data = json.loads(fixed_json)
                            print(f"âœ… [JSONæå–] {source_name} ä¿®å¤å•å¼•å·åè§£ææˆåŠŸ")
                            return json_data, "", ""
                        except:
                            pass
                
                return None, "", ""
            
            # ğŸ” æ­¥éª¤1: ä¼˜å…ˆä» content ä¸­æå– JSON
            if content:
                json_data_temp, before_text, after_text = extract_json_from_text(content, "content")
                
                if json_data_temp is not None:
                    qa_data = json_data_temp
                    json_source = "content"
                    
                    # content ä¸­ JSON å‰åçš„æ–‡æœ¬éƒ½æ˜¯æ€è€ƒè¿‡ç¨‹
                    if before_text:
                        thinking_parts.append(("contentå‰æ®µ", before_text))
                    if after_text:
                        thinking_parts.append(("contentåæ®µ", after_text))
                else:
                    # å¦‚æœ content æ•´ä½“ä¸æ˜¯ JSONï¼Œå…¨éƒ¨ä½œä¸ºæ€è€ƒè¿‡ç¨‹
                    if content:
                        thinking_parts.append(("contentå…¨æ–‡", content))
            
            # ğŸ“ è¾…åŠ©å‡½æ•°ï¼šè·å– reasoning_content å­—æ®µ
            def get_reasoning_content():
                """ä» response å¯¹è±¡çš„å¤šä¸ªå¯èƒ½ä½ç½®è·å– reasoning_content"""
                if hasattr(message, 'reasoning_content') and message.reasoning_content:
                    content = message.reasoning_content.strip()
                    print(f"ğŸ§  [æ¨ç†å­—æ®µ] ä» message.reasoning_content è·å– ({len(content)} å­—ç¬¦)")
                    return content
                elif hasattr(response, 'reasoning_content') and response.reasoning_content:
                    content = response.reasoning_content.strip()
                    print(f"ğŸ§  [æ¨ç†å­—æ®µ] ä» response.reasoning_content è·å– ({len(content)} å­—ç¬¦)")
                    return content
                elif hasattr(message, 'reasoning') and message.reasoning:
                    content = message.reasoning.strip()
                    print(f"ğŸ§  [æ¨ç†å­—æ®µ] ä» message.reasoning è·å– ({len(content)} å­—ç¬¦)")
                    return content
                elif hasattr(response, 'reasoning') and response.reasoning:
                    content = response.reasoning.strip()
                    print(f"ğŸ§  [æ¨ç†å­—æ®µ] ä» response.reasoning è·å– ({len(content)} å­—ç¬¦)")
                    return content
                return None
            
            # ğŸ” æ­¥éª¤2: å¦‚æœ content ä¸­æ²¡æ‰¾åˆ° JSONï¼Œå†ä» reasoning_content ä¸­æ‰¾
            if qa_data is None:
                reasoning_content = get_reasoning_content()
                
                if reasoning_content:
                    json_data_temp, before_text, after_text = extract_json_from_text(reasoning_content, "reasoning_content")
                    
                    if json_data_temp is not None:
                        qa_data = json_data_temp
                        json_source = "reasoning_content"
                        
                        # reasoning_content ä¸­ JSON å‰åçš„æ–‡æœ¬éƒ½æ˜¯æ€è€ƒè¿‡ç¨‹
                        if before_text:
                            thinking_parts.append(("reasoningå‰æ®µ", before_text))
                        if after_text:
                            thinking_parts.append(("reasoningåæ®µ", after_text))
                    else:
                        # å¦‚æœ reasoning_content æ•´ä½“ä¸æ˜¯ JSONï¼Œå…¨éƒ¨ä½œä¸ºæ€è€ƒè¿‡ç¨‹
                        thinking_parts.append(("reasoningå…¨æ–‡", reasoning_content))
            else:
                # å¦‚æœå·²ç»ä» content ä¸­æå–åˆ°äº† JSONï¼Œä½†ä¹Ÿæœ‰ reasoning_contentï¼Œ
                # åˆ™å°† reasoning_content å…¨éƒ¨ä½œä¸ºæ€è€ƒè¿‡ç¨‹
                reasoning_content = get_reasoning_content()
                
                if reasoning_content:
                    thinking_parts.append(("reasoningå­—æ®µ", reasoning_content))
                    print(f"ğŸ§  [æ¨ç†å­—æ®µ] é¢å¤–æ·»åŠ  reasoning å†…å®¹ä½œä¸ºæ€è€ƒè¿‡ç¨‹ ({len(reasoning_content)} å­—ç¬¦)")
            
            # ğŸ” æ­¥éª¤3: å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ° JSONï¼ŒæŠ¥é”™
            if qa_data is None:
                error_msg = "æ— æ³•ä» content æˆ– reasoning_content ä¸­æå– JSON æ ¼å¼çš„é—®ç­”æ•°æ®"
                if content:
                    error_msg += f"\ncontent å†…å®¹: {content[:200]}..."
                if thinking_parts:
                    error_msg += f"\næ‰¾åˆ° {len(thinking_parts)} æ®µæ€è€ƒå†…å®¹ï¼Œä½†æ²¡æœ‰ JSON"
                raise ValueError(error_msg)
            
            # ğŸ“¦ æ­¥éª¤4: åˆå¹¶æ‰€æœ‰æ€è€ƒå†…å®¹
            final_reasoning_content = ""
            if thinking_parts:
                formatted_parts = []
                for label, text in thinking_parts:
                    formatted_parts.append(f"ã€{label}ã€‘\n{text}")
                final_reasoning_content = "\n\n".join(formatted_parts)
                
                if GLOBAL_CONFIG.get("enable_thinking", False):
                    print(f"ğŸ§  [æ€è€ƒå†…å®¹] åˆå¹¶äº† {len(thinking_parts)} æ®µå†…å®¹ï¼Œæ€»è®¡ {len(final_reasoning_content)} å­—ç¬¦")
            
            print(f"âœ… [æ•°æ®æ¥æº] JSON æ¥è‡ª: {json_source}")
            
            # 7ï¸âƒ£ ç»Ÿä¸€å¤„ç†ï¼šå¦‚æœæ˜¯æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ªï¼›å¦‚æœæ˜¯å¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨
            if isinstance(qa_data, list):
                if len(qa_data) > 0:
                    qa_data = qa_data[0]  # å–ç¬¬ä¸€ä¸ª
                    print(f"ğŸ“¦ [JSONæ ¼å¼] æ•°ç»„æ ¼å¼ï¼Œå·²æå–ç¬¬ä¸€ä¸ªå…ƒç´ ")
                else:
                    raise ValueError("è¿”å›çš„ JSON æ•°ç»„ä¸ºç©º")
            elif isinstance(qa_data, dict):
                print(f"ğŸ“¦ [JSONæ ¼å¼] å¯¹è±¡æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨")
            else:
                raise ValueError(f"æ— æ³•è¯†åˆ«çš„ JSON æ ¼å¼: {type(qa_data)}")

            # åˆ¤æ–­æ˜¯å¦ä¸ºå¤šè½®å¯¹è¯é¢˜å‹
            is_multi_round = "multi_round" in question_type_key
            
            if is_multi_round:
                # å¤šè½®å¯¹è¯ï¼šå¤„ç† round1, round2, round3 ç­‰ç»“æ„
                question_dict = qa_data.get("question", {})
                options_dict = qa_data.get("options", {})
                answer_dict = qa_data.get("answer", {})
                process_dict = qa_data.get("qa_make_process", qa_data.get("process", {}))
                
                # å¦‚æœå¯ç”¨äº†æ€è€ƒæ¨¡å¼ä¸”æœ‰æ¨ç†å†…å®¹ï¼Œåˆå¹¶åˆ°æ¯è½®çš„ qa_make_process
                if GLOBAL_CONFIG.get("enable_thinking", False) and final_reasoning_content:
                    if isinstance(process_dict, dict):
                        # ä¸ºæ¯è½®æ·»åŠ æ¨ç†å†…å®¹
                        for round_key in process_dict.keys():
                            round_process = process_dict.get(round_key, "")
                            if round_process:
                                process_dict[round_key] = f"ã€æ¨¡å‹æ€è€ƒæ¨ç†è¿‡ç¨‹ã€‘\n{final_reasoning_content}\n\nã€é—®é¢˜è§£ç­”è¿‡ç¨‹ã€‘\n{round_process}"
                            else:
                                process_dict[round_key] = f"ã€æ¨¡å‹æ€è€ƒæ¨ç†è¿‡ç¨‹ã€‘\n{final_reasoning_content}"
                    else:
                        # å¦‚æœ process_dict ä¸æ˜¯å­—å…¸ï¼Œè½¬æ¢ä¸ºå­—å…¸æ ¼å¼
                        process_dict = {}
                        rounds = GLOBAL_CONFIG["rounds"]
                        for i in range(rounds):
                            round_key = f"round{i+1}"
                            process_dict[round_key] = f"ã€æ¨¡å‹æ€è€ƒæ¨ç†è¿‡ç¨‹ã€‘\n{final_reasoning_content}"
                elif not isinstance(process_dict, dict):
                    # å¦‚æœ process_dict ä¸æ˜¯å­—å…¸ï¼Œè½¬æ¢ä¸ºå­—å…¸æ ¼å¼
                    process_dict = {}
                    rounds = GLOBAL_CONFIG["rounds"]
                    for i in range(rounds):
                        round_key = f"round{i+1}"
                        process_dict[round_key] = ""
                
                new_item = {
                    "image_id": str(original_id),
                    "image_path": image_path,
                    "image_type": item_image_type,
                    "question_id": f"{original_id}_{question_type}_{question_index}",
                    "question_type": QUESTION_TYPES.get(question_type_key, qa_data.get("question_type", "é—®ç­”é¢˜")),
                    "question": question_dict,  # å­—å…¸æ ¼å¼ï¼š{"round1": "...", "round2": "..."}
                    "options": options_dict if options_dict else None,  # å­—å…¸æ ¼å¼æˆ– null
                    "answer": answer_dict,  # å­—å…¸æ ¼å¼ï¼š{"round1": "...", "round2": "..."}
                    "qa_make_process": process_dict  # å­—å…¸æ ¼å¼ï¼š{"round1": "...", "round2": "..."}
                }
            else:
                # å•è½®å¯¹è¯ï¼šä¿æŒåŸæœ‰æ ¼å¼
                process_from_qa = qa_data.get("qa_make_process", qa_data.get("process", ""))
                
                # å¦‚æœå¯ç”¨äº†æ€è€ƒæ¨¡å¼ä¸”æœ‰æ¨ç†å†…å®¹ï¼Œåˆå¹¶åˆ° qa_make_process
                if GLOBAL_CONFIG.get("enable_thinking", False) and final_reasoning_content:
                    if process_from_qa:
                        # åˆå¹¶æ¨ç†å†…å®¹å’Œé—®é¢˜ç”Ÿæˆè¿‡ç¨‹
                        qa_make_process = f"ã€æ¨¡å‹æ€è€ƒæ¨ç†è¿‡ç¨‹ã€‘\n{final_reasoning_content}\n\nã€é—®é¢˜è§£ç­”è¿‡ç¨‹ã€‘\n{process_from_qa}"
                    else:
                        # åªæœ‰æ¨ç†å†…å®¹
                        qa_make_process = f"ã€æ¨¡å‹æ€è€ƒæ¨ç†è¿‡ç¨‹ã€‘\n{final_reasoning_content}"
                else:
                    # åªä½¿ç”¨é—®é¢˜ç”Ÿæˆè¿‡ç¨‹
                    qa_make_process = process_from_qa
                
                new_item = {
                    "image_id": str(original_id),  # å›¾ç‰‡IDï¼šåªä¸å›¾ç‰‡è·¯å¾„ç»‘å®šï¼ŒåŒä¸€å¼ å›¾ç‰‡çš„æ‰€æœ‰é—®é¢˜ä½¿ç”¨ç›¸åŒçš„image_id
                    "image_path": image_path,
                    "image_type": item_image_type,
                    "question_id": f"{original_id}_{question_type}_{question_index}",  # question_idï¼šæ¯ä¸ªé—®é¢˜å”¯ä¸€
                    "question_type": QUESTION_TYPES.get(question_type_key, qa_data.get("question_type", "é—®ç­”é¢˜")),
                    "question": qa_data.get("question", ""),
                    "options": qa_data.get("options", None),
                    "answer": qa_data.get("answer", ""),
                    "qa_make_process": qa_make_process
                }
            
            return new_item

        except Exception as e:
            print(f"âŒ ç”Ÿæˆå¤±è´¥ (question_index={question_index}, attempt={attempt + 1}/{max_retries}): {e}")
            import traceback
            traceback.print_exc()
            
            # å¦‚æœè¿˜æœ‰é‡è¯•æœºä¼šï¼Œåˆ™ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
            if attempt < max_retries - 1:
                sleep_seconds = base_sleep * (2 ** attempt)
                print(f"â³ {sleep_seconds:.1f}s åé‡è¯•ç¬¬ {attempt + 2} æ¬¡...")
                try:
                    time.sleep(sleep_seconds)
                except Exception:
                    pass
            else:
                print("âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ”¾å¼ƒè¯¥é—®é¢˜ç”Ÿæˆ")
                return None


def generate_qa_data(item, image_type, question_type):
    """
    è¾“å…¥: 
        - item: å•ä¸ªå›¾ç‰‡ä¿¡æ¯
        - image_type: å›¾ç‰‡ç±»å‹ (pure_image, pure_text, mixed, splice)
        - question_type: é—®é¢˜ç±»å‹ (single_choice, multiple_choice, true_false, essay)
    è¾“å‡º: ä¸€ä¸ª List (ç”Ÿæˆçš„ N ä¸ªé—®ç­”å¯¹)
    
    æ³¨æ„ï¼šç°åœ¨æ˜¯å¤šæ¬¡å¯¹è¯ï¼Œæ¯æ¬¡ç”Ÿæˆä¸€ä¸ªé—®é¢˜
    """
    count = GLOBAL_CONFIG["questions_per_image"]
    generated_items = []
    
    image_id = str(item.get("id", "unknown"))
    
    # å¤šæ¬¡å¯¹è¯ï¼Œæ¯æ¬¡ç”Ÿæˆä¸€ä¸ªé—®é¢˜
    for question_index in range(count):
        qa_item = generate_single_qa(item, image_type, question_type, question_index, count)
        if qa_item:
            generated_items.append(qa_item)
        else:
            # åªåœ¨éé™é»˜æ¨¡å¼ä¸‹æ‰“å°ï¼ˆé¿å…å¹²æ‰°è¿›åº¦æ¡ï¼‰
            if not TQDM_AVAILABLE:
                print(f"âš ï¸ [å›¾ç‰‡ {image_id}] ç¬¬ {question_index + 1}/{count} ä¸ªé—®é¢˜ç”Ÿæˆå¤±è´¥")
    
    return generated_items

def worker(item):
    """çº¿ç¨‹å·¥ä½œå•å…ƒ"""
    global CURRENT_IMAGE_TYPE, CURRENT_QUESTION_TYPE, progress_bar
    
    image_id = str(item.get("id", "unknown"))
    image_path = item.get("image_path", "")
    image_name = os.path.basename(image_path) if image_path else "unknown"
    
    # æ›´æ–°è¿›åº¦æ¡æè¿°ï¼ˆæ˜¾ç¤ºå½“å‰å¤„ç†çš„å›¾ç‰‡ï¼‰
    if progress_bar:
        with progress_lock:
            progress_bar.set_description(f"å¤„ç†ä¸­: {image_name[:30]}")
    
    results = generate_qa_data(item, CURRENT_IMAGE_TYPE, CURRENT_QUESTION_TYPE)
    
    if results:
        # å…ˆåœ¨é”å†…æ›´æ–°å†…å­˜çŠ¶æ€ï¼Œä½†ä¸è¦åœ¨æŒé”çš„æƒ…å†µä¸‹è°ƒç”¨ flush_bufferï¼ˆå¦åˆ™ä¼šæ­»é”ï¼‰
        need_flush = False
        with buffer_lock:
            result_buffer.extend(results)
            stats["success"] += len(results)
            stats["questions_generated"] += len(results)
            stats["images_processed"] += 1
            
            if len(result_buffer) >= GLOBAL_CONFIG["batch_size"]:
                need_flush = True
        
        # åœ¨é”å¤–æ‰§è¡Œ flush_bufferï¼Œé¿å…é€’å½’è·å–åŒä¸€æŠŠé”å¯¼è‡´æ­»é”
        if need_flush:
            flush_buffer()
        
        # æ›´æ–°è¿›åº¦æ¡
        if progress_bar:
            with progress_lock:
                progress_bar.update(1)
                progress_bar.set_postfix({
                    "å›¾ç‰‡": f"{stats['images_processed']}",
                    "é—®é¢˜": f"{stats['questions_generated']}",
                    "æˆåŠŸ": f"{stats['success']}",
                    "å¤±è´¥": f"{stats['failed']}"
                })
    else:
        with buffer_lock:
            stats["failed"] += 1
            stats["images_processed"] += 1
        
        # æ›´æ–°è¿›åº¦æ¡
        if progress_bar:
            with progress_lock:
                progress_bar.update(1)
                progress_bar.set_postfix({
                    "å›¾ç‰‡": f"{stats['images_processed']}",
                    "é—®é¢˜": f"{stats['questions_generated']}",
                    "æˆåŠŸ": f"{stats['success']}",
                    "å¤±è´¥": f"{stats['failed']}"
                })

# ==============================================================================
# ğŸš€ ä¸»ç¨‹åº
# ==============================================================================
##æ·»åŠ æ–°é¢˜å‹å’Œå›¾ç‰‡ç±»å‹ï¼Œè¿™é‡Œé¢è¦åŠ 
def main():
    global client, OUTPUT_PATH, CURRENT_IMAGE_TYPE, CURRENT_QUESTION_TYPE
    
    parser = argparse.ArgumentParser(description="é—®é¢˜ç”Ÿæˆæ¨¡å— - æ ¹æ® image_type å’Œ question_type ç”Ÿæˆé¢˜ç›®")
    parser.add_argument("--input", required=True, help="è¾“å…¥JSONæ–‡ä»¶è·¯å¾„")
    parser.add_argument("--output", required=True, help="è¾“å‡ºJSONæ–‡ä»¶è·¯å¾„")
    parser.add_argument("--image_type", default="mixed", choices=IMAGE_TYPES, 
                       help="å›¾ç‰‡ç±»å‹: pure_image, pure_text, mixed, splice, all (allè¡¨ç¤ºå¤„ç†æ‰€æœ‰ç±»å‹ï¼Œä¸ç­›é€‰)")
    parser.add_argument("--question_type", default="essay", 
                       choices=["single_choice", "multiple_choice", "true_false", "essay", "multi_round_single_choice", "multi_round_essay"],
                       help="é—®é¢˜ç±»å‹: single_choice(å››é€‰å•é€‰), multiple_choice(å››é€‰å¤šé€‰), true_false(åˆ¤æ–­é¢˜), essay(é—®ç­”é¢˜), multi_round_single_choice(å¤šè½®å•é€‰é¢˜), multi_round_essay(å¤šè½®é—®ç­”é¢˜)")
    parser.add_argument("--num", type=int, default=GLOBAL_CONFIG["questions_per_image"], 
                       help=f"æ¯å¼ å›¾ç‰‡ç”Ÿæˆçš„é—®é¢˜æ•°é‡ï¼ˆé»˜è®¤: {GLOBAL_CONFIG['questions_per_image']}ï¼‰")
    parser.add_argument("--rounds", type=int, default=GLOBAL_CONFIG["rounds"], 
                       help=f"å¤šè½®å¯¹è¯çš„è½®æ•°ï¼ˆä»…ç”¨äºå¤šè½®å¯¹è¯é¢˜å‹ï¼Œé»˜è®¤{GLOBAL_CONFIG['rounds']}è½®ï¼‰")
    parser.add_argument("--resume", action="store_true", help="æ–­ç‚¹ç»­ä¼ ")
    parser.add_argument("--limit", type=int, default=None, help="é™åˆ¶å¤„ç†çš„å›¾ç‰‡æ•°é‡")
    
    # API Params (é»˜è®¤å€¼å¼•ç”¨ GLOBAL_CONFIGï¼Œç»Ÿä¸€é…ç½®ç®¡ç†)
    parser.add_argument("--api_base", default="http://localhost:22002/v1")
    parser.add_argument("--api_key", default="EMPTY")
    parser.add_argument("--model", default="Qwen3-VL-235B")
    parser.add_argument("--temp", type=float, default=GLOBAL_CONFIG["temperature"],
                       help=f"æ¸©åº¦å‚æ•°ï¼ˆé»˜è®¤: {GLOBAL_CONFIG['temperature']}ï¼‰")
    parser.add_argument("--tokens", type=int, default=GLOBAL_CONFIG["max_tokens"],
                       help=f"æœ€å¤§Tokenæ•°ï¼ˆé»˜è®¤: {GLOBAL_CONFIG['max_tokens']}ï¼‰")
    parser.add_argument("--batch", type=int, default=GLOBAL_CONFIG["batch_size"],
                       help=f"jsonæ‰¹é‡å†™å…¥å¤§å°ï¼ˆé»˜è®¤: {GLOBAL_CONFIG['batch_size']}ï¼‰")
    parser.add_argument("--workers", type=int, default=GLOBAL_CONFIG["max_workers"],
                       help=f"å¹¶å‘çº¿ç¨‹æ•°ï¼ˆé»˜è®¤: {GLOBAL_CONFIG['max_workers']}ï¼‰")
    parser.add_argument("--enable_thinking", action="store_true", 
                       help="å¯ç”¨æ€è€ƒæ¨¡å¼ï¼ˆä¼šæå– reasoning_content å¹¶åˆå¹¶åˆ° qa_make_processï¼‰")
    parser.add_argument("--timeout", type=float, default=GLOBAL_CONFIG["request_timeout"],
                       help=f"å•æ¬¡è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤{GLOBAL_CONFIG['request_timeout']}s")
    parser.add_argument("--retries", type=int, default=GLOBAL_CONFIG["max_retries"],
                       help=f"è¯·æ±‚å¤±è´¥æ—¶çš„æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤{GLOBAL_CONFIG['max_retries']}æ¬¡")
    parser.add_argument("--retry_sleep", type=float, default=GLOBAL_CONFIG["retry_sleep"],
                       help=f"è¯·æ±‚å¤±è´¥åçš„åŸºç¡€é‡è¯•é—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤{GLOBAL_CONFIG['retry_sleep']}sï¼Œåç»­æŒ‰æŒ‡æ•°é€€é¿")
    parser.add_argument("--log_dir", type=str, default="./logs", 
                       help="æ—¥å¿—æ–‡ä»¶ä¿å­˜ç›®å½•ï¼ˆé»˜è®¤: ./logsï¼‰")
    
    args = parser.parse_args()

    # æ³¨å…¥é…ç½®
    GLOBAL_CONFIG["api_base"] = args.api_base
    GLOBAL_CONFIG["api_key"] = args.api_key
    GLOBAL_CONFIG["model_name"] = args.model
    GLOBAL_CONFIG["temperature"] = args.temp
    GLOBAL_CONFIG["max_tokens"] = args.tokens
    GLOBAL_CONFIG["batch_size"] = args.batch
    GLOBAL_CONFIG["max_workers"] = args.workers
    GLOBAL_CONFIG["questions_per_image"] = args.num
    GLOBAL_CONFIG["enable_thinking"] = args.enable_thinking
    GLOBAL_CONFIG["rounds"] = args.rounds
    GLOBAL_CONFIG["request_timeout"] = args.timeout
    GLOBAL_CONFIG["max_retries"] = args.retries
    GLOBAL_CONFIG["retry_sleep"] = args.retry_sleep
    
    CURRENT_IMAGE_TYPE = args.image_type
    CURRENT_QUESTION_TYPE = args.question_type
    client = OpenAI(api_key=GLOBAL_CONFIG["api_key"], base_url=GLOBAL_CONFIG["api_base"])
    
    # åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶
    log_path = init_log_file(args.log_dir, args)
    print(f"ğŸ“ [æ—¥å¿—] æ—¥å¿—æ–‡ä»¶: {log_path}")
    
    if args.enable_thinking:
        print("ğŸ§  [é…ç½®] å·²å¯ç”¨æ€è€ƒæ¨¡å¼ (enable_thinking=True)")
    
    if "multi_round" in args.question_type:
        print(f"ğŸ”„ [é…ç½®] å¤šè½®å¯¹è¯é¢˜å‹ï¼Œè½®æ•°: {args.rounds}")

    # è·¯å¾„ä¸æ–­ç‚¹ç»­ä¼ 
    if args.resume:
        OUTPUT_PATH = args.output
        print(f"ğŸ”„ [æ–­ç‚¹ç»­ä¼ ] {OUTPUT_PATH}")
    else:
        OUTPUT_PATH = get_next_version_path(args.output)
        print(f"ğŸ†• [å…¨æ–°è¿è¡Œ] {OUTPUT_PATH}")

    if not os.path.exists(args.input):
        print(f"âŒ è¾“å…¥ä¸å­˜åœ¨: {args.input}")
        return
    
    with open(args.input, "r", encoding="utf-8") as f:
        input_data = json.load(f)

    # è‡ªåŠ¨åˆ›å»ºçˆ¶ç›®å½•
    output_dir = os.path.dirname(OUTPUT_PATH)
    if output_dir and not os.path.exists(output_dir):
        try:
            os.makedirs(output_dir, exist_ok=True)
            print(f"ğŸ“ è‡ªåŠ¨åˆ›å»ºç¼ºå¤±çš„ç›®å½•: {output_dir}")
        except Exception as e:
            print(f"âŒ æ— æ³•åˆ›å»ºç›®å½•: {e}")
            return

    # æ–­ç‚¹ç»­ä¼ ï¼šè¯»å–å·²å¤„ç†çš„å›¾ç‰‡IDï¼ˆåŸºäº image_id åˆ¤æ–­ï¼‰
    processed_ids = set()
    if args.resume and os.path.exists(OUTPUT_PATH):
        try:
            with open(OUTPUT_PATH, "r", encoding="utf-8") as f:
                existing = json.load(f)
                for x in existing:
                    # image_id ç°åœ¨ç›´æ¥å°±æ˜¯åŸå§‹IDï¼Œä¸éœ€è¦åˆ†å‰²
                    # å…¼å®¹æ—§æ ¼å¼ï¼šå¦‚æœå­˜åœ¨ id å­—æ®µä¹Ÿæ”¯æŒï¼ˆæ—§æ ¼å¼å¯èƒ½æ˜¯ "orig_id_index"ï¼‰
                    image_id = str(x.get("image_id", ""))
                    if not image_id:
                        # å…¼å®¹æ—§æ ¼å¼ï¼šä» id å­—æ®µæå–ï¼ˆæ ¼å¼å¯èƒ½æ˜¯ "orig_id_index"ï¼‰
                        old_id = str(x.get("id", ""))
                        if "_" in old_id:
                            parts = old_id.rsplit("_", 1)
                            image_id = parts[0]
                        else:
                            image_id = old_id
                    if image_id:
                        processed_ids.add(image_id)
            print(f"ğŸ“Š [æ–­ç‚¹ç»­ä¼ ] ä»è¾“å‡ºæ–‡ä»¶ä¸­è¯»å–åˆ° {len(processed_ids)} å¼ å·²å¤„ç†çš„å›¾ç‰‡")
        except Exception as e:
            print(f"âš ï¸ [æ–­ç‚¹ç»­ä¼ ] è¯»å–å·²å¤„ç†å›¾ç‰‡åˆ—è¡¨å¤±è´¥: {e}")
            processed_ids = set()

    # ç¬¬ä¸€æ­¥ï¼šæ ¹æ® image_type ç­›é€‰å›¾ç‰‡ï¼ˆå¦‚æœè®¾ç½®äº†å…·ä½“ç±»å‹ï¼‰
    filtered_data = []
    if CURRENT_IMAGE_TYPE.lower() == "all":
        # å¦‚æœè®¾ç½®ä¸º "all"ï¼Œä¸è¿›è¡Œç­›é€‰ï¼Œå¤„ç†æ‰€æœ‰å›¾ç‰‡
        print(f"ğŸ“‹ [ç­›é€‰] å›¾ç‰‡ç±»å‹è®¾ç½®ä¸º 'all'ï¼Œå°†å¤„ç†æ‰€æœ‰ç±»å‹çš„å›¾ç‰‡ï¼ˆä¸ç­›é€‰ï¼‰")
        filtered_data = input_data
    else:
        # ç­›é€‰æŒ‡å®šç±»å‹çš„å›¾ç‰‡
        print(f"ğŸ“‹ [ç­›é€‰] åªå¤„ç†å›¾ç‰‡ç±»å‹ä¸º '{CURRENT_IMAGE_TYPE}' çš„å›¾ç‰‡")
        for item in input_data:
            # ä» item ä¸­è·å–å›¾ç‰‡ç±»å‹ï¼ˆæ”¯æŒ image_type æˆ– type å­—æ®µï¼‰
            item_image_type = item.get("image_type") or item.get("type", "")
            if item_image_type:
                item_image_type = item_image_type.lower()
            else:
                item_image_type = ""
            
            # åŒ¹é…å›¾ç‰‡ç±»å‹ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
            if item_image_type == CURRENT_IMAGE_TYPE.lower():
                filtered_data.append(item)
        print(f"ğŸ“‹ [ç­›é€‰] ä» {len(input_data)} å¼ å›¾ç‰‡ä¸­ç­›é€‰å‡º {len(filtered_data)} å¼  '{CURRENT_IMAGE_TYPE}' ç±»å‹çš„å›¾ç‰‡")
    
    # ç¬¬äºŒæ­¥ï¼šè¿‡æ»¤å·²å¤„ç†çš„é¡¹ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰
    todo_items = []
    skipped_count = 0
    for item in filtered_data:
        item_id = str(item.get("id", ""))
        if item_id not in processed_ids:
            # ç¡®ä¿ item ä¸­æœ‰ image_type å­—æ®µï¼ˆç”¨äºåç»­ç”Ÿæˆæ—¶ä½¿ç”¨ï¼‰
            item_image_type = item.get("image_type") or item.get("type")
            if not item_image_type:
                # å¦‚æœè¾“å…¥æ•°æ®ä¸­æ²¡æœ‰ image_typeï¼Œä½¿ç”¨å½“å‰è®¾ç½®çš„ç±»å‹ï¼ˆé™¤éæ˜¯"all"ï¼‰
                if CURRENT_IMAGE_TYPE.lower() != "all":
                    item_image_type = CURRENT_IMAGE_TYPE
                else:
                    item_image_type = "mixed"  # é»˜è®¤ä½¿ç”¨ mixed
            item["image_type"] = item_image_type
            todo_items.append(item)
        else:
            skipped_count += 1
    
    if skipped_count > 0:
        print(f"ğŸ“‹ [æ–­ç‚¹ç»­ä¼ ] è·³è¿‡å·²å¤„ç†çš„ {skipped_count} å¼ å›¾ç‰‡")
    
    # æ˜¾ç¤ºæœ€ç»ˆå¾…å¤„ç†åˆ—è¡¨ä¿¡æ¯
    if CURRENT_IMAGE_TYPE.lower() == "all":
        print(f"ğŸ“‹ [æœ€ç»ˆ] å¾…å¤„ç†å›¾ç‰‡: {len(todo_items)} å¼ ï¼ˆæ‰€æœ‰ç±»å‹ï¼‰")
    else:
        print(f"ğŸ“‹ [æœ€ç»ˆ] å¾…å¤„ç†å›¾ç‰‡: {len(todo_items)} å¼ ï¼ˆä»… '{CURRENT_IMAGE_TYPE}' ç±»å‹ï¼‰")
    
    if args.limit:
        print(f"âœ‚ï¸  é™åˆ¶å¤„ç†å‰ {args.limit} å¼ å›¾ç‰‡")
        todo_items = todo_items[:args.limit]

    total_images = len(todo_items)
    total_questions_expected = total_images * args.num
    
    print(f"ğŸ“‹ ä»»åŠ¡: {total_images} å›¾ x {args.num} é¢˜ = {total_questions_expected} é¢˜")
    print(f"ğŸ“‹ å›¾ç‰‡ç±»å‹: {CURRENT_IMAGE_TYPE}, é—®é¢˜ç±»å‹: {QUESTION_TYPES.get(CURRENT_QUESTION_TYPE, CURRENT_QUESTION_TYPE)}")
    print(f"ğŸ“‹ å¹¶å‘: {args.workers}")
    print("="*80)
    
    if not todo_items:
        print("âœ… æ— éœ€å¤„ç†")
        return

    start_time = time.time()
    
    # åˆå§‹åŒ–è¿›åº¦æ¡
    global progress_bar
    if TQDM_AVAILABLE:
        progress_bar = tqdm(
            total=total_images,
            desc="åˆå§‹åŒ–",
            unit="å›¾",
            ncols=100,
            bar_format='{l_bar}{bar}| {n_fmt}/{total_fmt} [{elapsed}<{remaining}, {rate_fmt}] {postfix}'
        )
    else:
        print(f"ğŸš€ å¼€å§‹å¤„ç† {total_images} å¼ å›¾ç‰‡...")
        progress_bar = None
    
    try:
        with concurrent.futures.ThreadPoolExecutor(max_workers=GLOBAL_CONFIG['max_workers']) as executor:
            # ä½¿ç”¨ submit è€Œä¸æ˜¯ mapï¼Œä»¥ä¾¿æ›´å¥½åœ°æ§åˆ¶è¿›åº¦
            futures = {executor.submit(worker, item): item for item in todo_items}
            
            # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
            for future in concurrent.futures.as_completed(futures):
                try:
                    future.result()  # è·å–ç»“æœï¼Œå¦‚æœæœ‰å¼‚å¸¸ä¼šæŠ›å‡º
                except Exception as e:
                    item = futures[future]
                    print(f"\nâŒ å¤„ç†å¤±è´¥ (image_id={item.get('id', 'unknown')}): {e}")
                    with buffer_lock:
                        stats["failed"] += 1
                        stats["images_processed"] += 1
                    if progress_bar:
                        with progress_lock:
                            progress_bar.update(1)
    
    finally:
        # ç¡®ä¿æœ€ååˆ·æ–°ç¼“å†²åŒº
        flush_buffer()
        
        # å…³é—­è¿›åº¦æ¡
        if progress_bar:
            progress_bar.close()
            progress_bar = None
        
        # å…³é—­æ—¥å¿—æ–‡ä»¶
        close_log_file()
    
    elapsed_time = time.time() - start_time
    print("\n" + "="*80)
    print("âœ… å¤„ç†å®Œæˆ!")
    print(f"â±ï¸  æ€»è€—æ—¶: {elapsed_time:.2f}s ({elapsed_time/60:.2f}åˆ†é’Ÿ)")
    print(f"ğŸ“Š å¤„ç†ç»Ÿè®¡:")
    print(f"   - å·²å¤„ç†å›¾ç‰‡: {stats['images_processed']}/{total_images}")
    print(f"   - ç”Ÿæˆé—®é¢˜æ•°: {stats['questions_generated']}/{total_questions_expected}")
    print(f"   - æˆåŠŸ: {stats['success']} é¢˜")
    print(f"   - å¤±è´¥: {stats['failed']} å›¾")
    if stats['images_processed'] > 0:
        avg_time = elapsed_time / stats['images_processed']
        print(f"   - å¹³å‡æ¯å›¾: {avg_time:.2f}s")
    print("="*80)

if __name__ == "__main__":
    main()
