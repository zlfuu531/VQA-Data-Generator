import argparse
import base64
import json
import os
import random
from typing import Any, Dict, List, Optional, Tuple

from openai import OpenAI

# ==============================================================================
# ğŸŒ å…¨å±€é…ç½®å®¹å™¨
# ==============================================================================
GLOBAL_CONFIG = {
    "api_base": "",
    "api_key": "",
    "model_name": "",
    "temperature": 0.7,
    "max_tokens": 8192,
    "batch_size": 10,
    "max_workers": 4,
    "questions_per_image": 1,
    "enable_thinking": False,
    "rounds": 3,
    "request_timeout": 1000.0,
    "max_retries": 3,
    "retry_sleep": 1.0,
    "log_mode": "simple",
    "include_process": False
}

# ==============================================================================
# ğŸ“ é—®é¢˜ç±»å‹å®šä¹‰
# ==============================================================================
QUESTION_TYPES = {
    "single_choice": "å››é€‰å•é€‰",
    "multiple_choice": "å››é€‰å¤šé€‰",
    "true_false": "åˆ¤æ–­é¢˜",
    "essay": "é—®ç­”é¢˜",
    "multi_round_single_choice": "å¤šè½®å•é€‰é¢˜",
    "multi_round_essay": "å¤šè½®é—®ç­”é¢˜"
}


# ==============================================================================
# ğŸ› ï¸ å·¥å…·å‡½æ•°
# ==============================================================================
def encode_image(image_path: str) -> tuple:
    """
    ç¼–ç å›¾ç‰‡ä¸º Base64ï¼Œå¹¶è¿”å› MIME ç±»å‹
    
    Returns:
        tuple: (base64_string, mime_type) æˆ– (None, None) å¦‚æœå¤±è´¥
    """
    try:
        if not os.path.exists(image_path):
            return None, None
        
        # æ ¹æ®æ–‡ä»¶åç¼€åˆ¤æ–­ MIME ç±»å‹
        ext = os.path.splitext(image_path)[1].lower()
        mime_types = {
            '.jpg': 'image/jpeg',
            '.jpeg': 'image/jpeg',
            '.png': 'image/png',
            '.gif': 'image/gif',
            '.webp': 'image/webp',
            '.bmp': 'image/bmp',
            '.tiff': 'image/tiff',
            '.tif': 'image/tiff',
        }
        mime_type = mime_types.get(ext, 'image/jpeg')  # é»˜è®¤ä½¿ç”¨ jpeg
        
        with open(image_path, "rb") as image_file:
            base64_str = base64.b64encode(image_file.read()).decode('utf-8')
            return base64_str, mime_type
    except:
        return None, None


def get_question_type_specific_requirements(question_type: str, include_process: bool = True) -> str:
    """
    è·å–ç‰¹å®šé—®é¢˜ç±»å‹çš„è¦æ±‚å’Œè¾“å‡ºæ ¼å¼
    """
    requirements = {
        "single_choice": f"""
**æ ¼å¼è§„èŒƒ**ï¼šå¿…é¡»æä¾› A, B, C, D å››ä¸ªé€‰é¡¹ï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªæ˜¯æ­£ç¡®ç­”æ¡ˆã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼š
{{
    "question_type": "å››é€‰å•é€‰",
    "question": "é—®é¢˜å†…å®¹...",
    "options": {{"A": "...", "B": "...", "C": "...", "D": "..."}},
{("    \"qa_make_process\": \"æ¨ç†è¿‡ç¨‹...\",\n" if include_process else "")}    "answer": "ä¸€ä¸ªé€‰é¡¹å­—æ¯"
}}
""",
        "multiple_choice": f"""
**æ ¼å¼è§„èŒƒ**ï¼šå¿…é¡»æä¾› A, B, C, D å››ä¸ªé€‰é¡¹ï¼Œå…¶ä¸­è‡³å°‘æœ‰ä¸¤ä¸ªæ˜¯æ­£ç¡®ç­”æ¡ˆã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼š
{{
    "question_type": "å››é€‰å¤šé€‰",
    "question": "é—®é¢˜å†…å®¹...",
    "options": {{"A": "...", "B": "...", "C": "...", "D": "..."}},
{("    \"qa_make_process\": \"æ¨ç†è¿‡ç¨‹...\",\n" if include_process else "")}    "answer": "å¤šä¸ªé€‰é¡¹å­—æ¯"  // å¤šä¸ªæ­£ç¡®ç­”æ¡ˆç”¨å­—æ¯ç»„åˆï¼Œå¦‚ "AB", "ACD" ç­‰
}}
""",
        "true_false": f"""
**æ ¼å¼è§„èŒƒ**ï¼šåˆ¤æ–­é¢˜çš„é€‰é¡¹å›ºå®šä¸ºnullï¼Œansweræ˜¯ true æˆ–è€… falseï¼Œ

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼š
{{
    "question_type": "åˆ¤æ–­é¢˜",
    "question": "é—®é¢˜å†…å®¹...",
    "options": null,
{("    \"qa_make_process\": \"æ¨ç†è¿‡ç¨‹...\",\n" if include_process else "")}    "answer": "true" æˆ–è€… "false" // trueè¡¨ç¤ºæ­£ç¡®ï¼Œfalseè¡¨ç¤ºé”™è¯¯
}}
""",
        "essay": f"""
**ç­”æ¡ˆç®€ç»ƒ**ï¼šç­”æ¡ˆå¿…é¡»æ˜¯å…·ä½“çš„å®ä½“åç§°ã€æ•°å­—ç»“æœæˆ–å…³é”®çŸ­è¯­ã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼š
{{
    "question_type": "é—®ç­”é¢˜",
    "question": "é—®é¢˜å†…å®¹...",
    "options": null,
{("    \"qa_make_process\": \"æ¨ç†è¿‡ç¨‹...\",\n" if include_process else "")}    "answer": "æ­£ç¡®ç­”æ¡ˆ"
}}
""",
        "multi_round_single_choice": """
**æ ¼å¼è§„èŒƒ**ï¼šå¤šè½®å•é€‰é¢˜éœ€è¦è®¾è®¡å¤šè½®å¯¹è¯ï¼Œæ¯è½®éƒ½æ˜¯å•é€‰é¢˜ï¼Œå¿…é¡»æä¾› A, B, C, D å››ä¸ªé€‰é¡¹ã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼ŒåŒ…å« round1, round2, round3 ç­‰å­—æ®µï¼ˆæ ¹æ®æŒ‡å®šçš„è½®æ•°ç”Ÿæˆå¯¹åº”æ•°é‡çš„å­—æ®µï¼‰ã€‚
""",
        "multi_round_essay": """
**æ ¼å¼è§„èŒƒ**ï¼šå¤šè½®é—®ç­”é¢˜éœ€è¦è®¾è®¡å¤šè½®å¯¹è¯ï¼Œæ¯è½®éƒ½æ˜¯é—®ç­”é¢˜ï¼Œç­”æ¡ˆå¿…é¡»æ˜¯å…·ä½“çš„å®ä½“åç§°ã€æ•°å­—ç»“æœæˆ–å…³é”®çŸ­è¯­ã€‚

**è¾“å‡ºæ ¼å¼**ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆä¸æ˜¯æ•°ç»„ï¼‰ï¼ŒåŒ…å« round1, round2, round3 ç­‰å­—æ®µï¼ˆæ ¹æ®æŒ‡å®šçš„è½®æ•°ç”Ÿæˆå¯¹åº”æ•°é‡çš„å­—æ®µï¼‰ã€‚
"""
    }
    
    base_requirement = requirements.get(question_type, requirements["essay"])
    # æ ¹æ® include_process å‚æ•°åŠ¨æ€è°ƒæ•´è¾“å‡ºæ ¼å¼
    if not include_process:
        # ç§»é™¤ qa_make_process å­—æ®µ
        base_requirement = base_requirement.replace('    "qa_make_process": "æ¨ç†è¿‡ç¨‹...",\n', '')
        base_requirement = base_requirement.replace('    "qa_make_process": {', '')
        base_requirement = base_requirement.replace('        {process_example}\n    },\n', '')
    return base_requirement


def get_prompt_template(image_type: str, question_type: str, rounds: int = 3, include_process: bool = True) -> str:
    """
    è·å–æç¤ºè¯æ¨¡æ¿ï¼ˆä»…è¿”å›é—®é¢˜ç±»å‹ç‰¹å®šçš„è¦æ±‚å’Œè¾“å‡ºæ ¼å¼éƒ¨åˆ†ï¼‰
    """
    return get_question_type_specific_requirements(question_type, include_process)


def _extract_json_block(text: str) -> Optional[Dict[str, Any]]:
    """ä»æ¨¡å‹è¿”å›çš„æ–‡æœ¬ä¸­æå–é¦–ä¸ª JSON å¯¹è±¡ï¼Œå®¹é”™å¤„ç†å¼•å·ä¸ç©ºç™½ã€‚"""
    if not text:
        return None
    start = text.find("{")
    if start == -1:
        return None

    stack = []
    in_string = False
    escape = False
    for idx, ch in enumerate(text[start:], start=start):
        if escape:
            escape = False
            continue
        if ch == "\\":
            escape = True
            continue
        if ch == '"':
            in_string = not in_string
        if in_string:
            continue
        if ch == "{":
            stack.append(ch)
        elif ch == "}":
            if not stack:
                return None
            stack.pop()
            if not stack:
                try:
                    return json.loads(text[start : idx + 1])
                except Exception:
                    return None
    return None


def _ensure_client(client: Optional[OpenAI] = None) -> OpenAI:
    """ä¼˜å…ˆä½¿ç”¨ä¼ å…¥ clientï¼Œå¦åˆ™æ ¹æ® GLOBAL_CONFIG æ„å»ºã€‚"""
    if client:
        return client
    return OpenAI(
        api_key=GLOBAL_CONFIG.get("api_key") or os.environ.get("API_KEY", ""),
        base_url=GLOBAL_CONFIG.get("api_base", ""),
    )


def _get_step1_prompt(image_type: str, question_type: str, rounds: int = 3, include_process: bool = True) -> str:
    """ç¬¬ä¸€æ­¥ï¼šå‡ºé¢˜prompt"""
    question_type_name_cn = QUESTION_TYPES.get(question_type, "é—®ç­”é¢˜")
    is_multi_round = "multi_round" in question_type
    rounds_text = f"{rounds}è½®" if is_multi_round else ""
    
    # æ ¹æ®image_typeé€‰æ‹©ä¸åŒçš„promptæ¨¡æ¿
    if image_type == "splice":
        base_prompt = f"""
ä½ æ˜¯ä¸€åé¡¶çº§çš„é‡‘èå¤šæ¨¡æ€é«˜éš¾åº¦ VQA é¢˜ç›®æ„å»ºä¸“å®¶ï¼Œæ“…é•¿ä»å¤æ‚çš„"å›¾è¡¨+æ–‡å­—è¯´æ˜"ç±»é‡‘èå›¾åƒä¸­ï¼Œè®¾è®¡éœ€è¦å¤šå±‚é€»è¾‘é“¾æ¡çš„ä¸“ä¸šçº§åˆ†æé¢˜ã€‚

**ç‰¹åˆ«è¯´æ˜**ï¼šç»™å®šå›¾åƒä¸º**ä¸¤å¼ é‡‘èå›¾ç‰‡çš„æ‹¼æ¥**ï¼Œè¿™ä¸¤å¼ å›¾ç‰‡å¯èƒ½äº’ä¸ç›¸å…³ã€‚è¯·**åªé’ˆå¯¹å…¶ä¸­ä¸€å¼ å›¾ç‰‡çš„å†…å®¹å‡ºé¢˜**ï¼Œå‡ºé¢˜å†…å®¹è¦å’Œå¦ä¸€å¼ å›¾ç‰‡çš„å†…å®¹å°½å¯èƒ½ä¸ç›¸å¹²ï¼Œç›®çš„æ˜¯è€ƒå¯Ÿæ¨¡å‹çš„**ç²¾å‡†å®šä½èƒ½åŠ›**ï¼ˆèƒ½å¦å‡†ç¡®è¯†åˆ«å’Œèšç„¦äºç‰¹å®šå›¾ç‰‡åŒºåŸŸï¼‰ã€‚

è¯·åŸºäºé€‰å®šçš„é‚£å¼ é‡‘èå›¾åƒï¼ˆå¯èƒ½åŒ…å«æŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€é¥¼å›¾ã€åŒæ¯”/ç¯æ¯”æ•°æ®ã€ç™¾åˆ†æ¯”ç»“æ„ã€è¡¨æ ¼ã€è¯´æ˜æ–‡å­—ã€æŒ‡æ ‡å®šä¹‰ã€å›¾ä¾‹ã€æ³¨é‡Šç­‰ï¼‰ï¼Œç”Ÿæˆä¸€é“ã€{question_type_name_cn}ã€‘ã€‚é¢˜ç›®éš¾åº¦éœ€æ˜¾è‘—é«˜äºä¸€èˆ¬é‡‘èç ”ç©¶å‘˜æ°´å¹³ï¼Œå¿…é¡»ä¾èµ–æ‰€é€‰å›¾ç‰‡ä¸­å¤šä¸ªä¿¡æ¯å—çš„äº¤å‰ä½¿ç”¨ï¼ˆå›¾è¡¨ + æ–‡å­—è¯´æ˜ + æ³¨é‡Š + å›¾ä¾‹ï¼‰ã€‚

**ã€ä»»åŠ¡è¦æ±‚ã€‘**

1. **é¢˜ç›®éš¾åº¦éœ€è¾¾åˆ°é‡‘èåˆ†æå¸ˆ/ç ”ç©¶å‘˜æ°´å¹³**
   å¿…é¡»ç”Ÿæˆéœ€è¦å¤šæ­¥æ¨ç†çš„é‡‘èæ¨ç†é—®é¢˜ï¼Œé—®é¢˜çš„ç­”æ¡ˆåªèƒ½ä¾èµ–å›¾åƒä¸­çš„å†…å®¹å¾—åˆ°ã€‚é¢˜ç›®ç±»å‹å¯ä»¥åŒ…æ‹¬ä½†ä¸é™äºï¼š
   - è´¢åŠ¡æŒ‡æ ‡æ¨ç†ï¼ˆåŸºäºå›¾ä¸­æ•°æ®è¿›è¡Œè®¡ç®—æˆ–é€»è¾‘æ¨æ–­ï¼‰
   - å›¾è¡¨è¶‹åŠ¿åˆ†æä¸æ¨æ–­ï¼ˆè¯†åˆ«æ‹ç‚¹ã€åŠ é€Ÿ/å‡é€Ÿã€å‘¨æœŸæ€§ç­‰ï¼‰
   - ç»“æ„åŒ–å›¾å½¢æ¨ç†ï¼ˆå¦‚è‚¡æƒç»“æ„ã€èµ„äº§ç»“æ„ã€ä¸šåŠ¡æ„æˆç­‰ï¼‰
   - å¤šå®ä½“å…³ç³»æ¨æ–­ï¼ˆæ¯”è¾ƒã€æ’åºã€å…³è”åˆ†æç­‰ï¼‰
   - æ¯”è¾ƒç±»é—®é¢˜ï¼ˆå¢é•¿æœ€å¿«ã€å æ¯”æœ€é«˜ã€ç»“æ„å˜åŒ–ã€ç›¸å¯¹è¡¨ç°ç­‰ï¼‰
   - ç»æµæˆ–ä¸šåŠ¡å«ä¹‰æ¨æ–­ï¼ˆåŸºäºå›¾ä¸­å®¢è§‚ä¿¡æ¯å¾—å‡ºç»“è®ºï¼‰
   - è·¨å›¾è¡¨ç»¼åˆåˆ†æï¼ˆåœ¨æ‰€é€‰å›¾ç‰‡å†…ï¼Œå¤šé¡¹æŒ‡æ ‡ä¹‹é—´çš„é“¾å¼æ¨æ–­ï¼Œå¦‚ Aâ†’Bâ†’Cï¼‰

2. **æ‰€æœ‰é—®é¢˜å¿…é¡»æ»¡è¶³ï¼ˆç¡¬æ€§è¦æ±‚ï¼‰**ï¼š
   - ç­”æ¡ˆå”¯ä¸€ã€å®¢è§‚ã€å¯éªŒè¯ï¼ˆä¸èƒ½æœ‰æ­§ä¹‰æˆ–å¤šç§è§£é‡Šï¼‰
   - å¿…é¡»ä¸¥æ ¼ä¾èµ–æ‰€é€‰å›¾ç‰‡ä¸­çš„ä¿¡æ¯ï¼ˆä¸èƒ½ä¾èµ–å¦ä¸€å¼ å›¾ç‰‡æˆ–å›¾å¤–çŸ¥è¯†ï¼‰
   - é¢˜å¹²ä¸å¾—ç›´æ¥ç»™å‡ºå›¾ç‰‡å†…å·²æœ‰çš„ç»“æ„åŒ–æ•°æ®æˆ–ç»“è®º
   - é¢˜å¹²éœ€è¦é€šè¿‡æè¿°è®©æ¨¡å‹æ˜ç¡®çŸ¥é“æ˜¯é’ˆå¯¹å“ªå¼ å›¾ç‰‡å‡ºé¢˜ï¼ˆå¦‚"ä¸Šå›¾""ä¸‹å›¾""å·¦å›¾""å³å›¾"æˆ–é€šè¿‡å›¾ç‰‡ä¸»é¢˜æè¿°ï¼‰
   - ä¸å…è®¸ä¸»è§‚ç±»é—®é¢˜ï¼ˆå¦‚"ä½ æ€ä¹ˆçœ‹""æ˜¯å¦åˆç†"ï¼‰
   - ä¸å…è®¸å¼€æ”¾å¼å›ç­”ï¼ˆå¦‚"åˆ—å‡ºå¯èƒ½çš„åŸå› ""å¯èƒ½æœ‰å“ªäº›å½±å“"ï¼‰
   - **ã€ç»å¯¹ç¦æ­¢ã€‘ä¸¥ç¦åœ¨é—®é¢˜ä¸­ä½¿ç”¨ä»¥ä¸‹ä»»ä½•è¯æ±‡ï¼š"æ¨æ–­"ã€"å¯èƒ½"ã€"æœ€å¯èƒ½"ã€"æ¨æµ‹"ã€"ä¼°è®¡"ã€"å¦‚ä½•"ã€"ä¸ºä»€ä¹ˆ"ã€"å“ªäº›"ã€"ä»€ä¹ˆåŸå› "ã€"ä»€ä¹ˆå½±å“"ã€"ä»€ä¹ˆå› ç´ "ç­‰è¡¨ç¤ºä¸ç¡®å®šæ€§æˆ–å¼€æ”¾æ€§çš„è¯æ±‡**
   - **é—®é¢˜å¿…é¡»ç›´æ¥ã€æ˜ç¡®ã€å®¢è§‚ï¼Œä½¿ç”¨"è®¡ç®—"ã€"ç¡®å®š"ã€"æ‰¾å‡º"ã€"æ¯”è¾ƒ"ç­‰ç¡®å®šæ€§è¯æ±‡**
   - **ç­”æ¡ˆå¿…é¡»ç®€æ´æ˜ç¡®ï¼ˆä¸è¶…è¿‡50å­—ï¼‰ï¼Œä¸å¾—åŒ…å«å†—é•¿çš„è§£é‡Šæ€§æ–‡å­—ï¼Œå¦‚æœæ˜¯è®¡ç®—é¢˜ç›´æ¥ç»™å‡ºæ•°å€¼ï¼Œå¦‚æœæ˜¯é€‰æ‹©é¢˜ç›´æ¥ç»™å‡ºé€‰é¡¹ï¼Œå¦‚æœæ˜¯é—®ç­”é¢˜ç›´æ¥ç»™å‡ºç®€çŸ­ç»“è®º**

3. **éš¾åº¦è¦æ±‚ï¼šæ¯ä¸€é¢˜è‡³å°‘æ»¡è¶³ä»¥ä¸‹ä»»æ„ä¸¤æ¡**ï¼š
   - æ¶‰åŠè·¨å¹´åº¦ã€è·¨å­£åº¦ã€è·¨åŒºåŸŸçš„è¶‹åŠ¿æ¯”è¾ƒ
   - åŒæ—¶ä½¿ç”¨å›¾è¡¨æ•°å€¼ + å›¾ä¾‹è§£é‡Š + æ–‡å­—è¯´æ˜
   - å¤šæŒ‡æ ‡ä¹‹é—´çš„é“¾å¼æ¨ç†ï¼ˆAâ†’Bâ†’Cï¼Œéœ€è¦è‡³å°‘ 2-3 æ­¥æ¨ç†ï¼‰
   - ç»“æ„å æ¯”å˜åŒ–æ¨æ–­ï¼ˆå¦‚"å“ªéƒ¨åˆ†è´¡çŒ®æœ€å¤§""ç»“æ„å¦‚ä½•å˜åŒ–"ï¼‰
   - ä»åŒæ¯” + ç¯æ¯”çš„å åŠ ä¿¡æ¯å¾—å‡ºåˆ¤æ–­
   - ä½¿ç”¨æ‰€é€‰å›¾ç‰‡ä¸­çš„å¤šä¸ªå›¾å—ï¼ˆå¦‚ä¸»å›¾ + å­å›¾ + è¡¨æ ¼ï¼‰ç»¼åˆæ¨æ–­

4. **ç²¾å‡†å®šä½è¦æ±‚ï¼ˆé‡è¦ï¼‰**ï¼š
   - é¢˜å¹²å¿…é¡»æ˜ç¡®æŒ‡å‘å…¶ä¸­ä¸€å¼ å›¾ç‰‡ï¼Œé¿å…æ¨¡ç³Šä¸æ¸…
   - å¯ä»¥ä½¿ç”¨ä½ç½®æè¿°è¯ï¼ˆä¸Šå›¾/ä¸‹å›¾/å·¦å›¾/å³å›¾ï¼‰æˆ–ä¸»é¢˜æè¿°ï¼ˆå¦‚"å…³äºXXçš„å›¾è¡¨"ï¼‰
   - ç­”æ¡ˆå¿…é¡»åªèƒ½ä»æ‰€é€‰å›¾ç‰‡ä¸­å¾—å‡ºï¼Œä¸èƒ½æ··ç”¨ä¸¤å¼ å›¾ç‰‡çš„ä¿¡æ¯
   - æ¨ç†è¿‡ç¨‹è¦æ˜ç¡®è¯´æ˜ä»æ‰€é€‰å›¾ç‰‡çš„å“ªäº›ä½ç½®è·å–äº†å“ªäº›ä¿¡æ¯

5. **æ€ç»´é“¾è¦æ±‚**ï¼š
   å¿…é¡»åœ¨ qa_make_process å­—æ®µä¸­è¯¦ç»†è®°å½•è§£é¢˜çš„å®Œæ•´æ¨ç†é“¾æ¡ï¼ŒåŒ…æ‹¬ï¼š
   - æ˜ç¡®è¯´æ˜é’ˆå¯¹çš„æ˜¯å“ªå¼ å›¾ç‰‡ï¼ˆå¦‚"åŸºäºä¸Šå›¾"æˆ–"åŸºäºå…³äºXXçš„å›¾è¡¨"ï¼‰
   - ä»è¯¥å›¾ç‰‡çš„å“ªäº›ä½ç½®è·å–äº†å“ªäº›ä¿¡æ¯
   - å¦‚ä½•å°†è¿™äº›ä¿¡æ¯ç»„åˆèµ·æ¥è¿›è¡Œæ¨ç†
   - æ¯ä¸€æ­¥çš„è®¡ç®—æˆ–é€»è¾‘åˆ¤æ–­è¿‡ç¨‹
   - æœ€ç»ˆå¦‚ä½•å¾—å‡ºç­”æ¡ˆ

6. **ä¸¥ç¦çš„è¡Œä¸º**ï¼š
   - ä¸å¾—æ··ç”¨ä¸¤å¼ å›¾ç‰‡çš„ä¿¡æ¯è¿›è¡Œå‡ºé¢˜æˆ–ä½œç­”
   - ä¸å¾—ç¼–é€ å›¾ä¸­ä¸å­˜åœ¨çš„æ•°æ®ã€å›¾ä¾‹ã€æ—¶é—´åˆ»åº¦ã€æŒ‡æ ‡åç§°
   - ä¸å¾—åœ¨é¢˜å¹²ä¸­ç›´æ¥æ³„éœ²å›¾ä¸­çš„å…³é”®æ•°æ®æˆ–ç»“è®º
   - ä¸å¾—è®¾è®¡ä¾èµ–å¤–éƒ¨çŸ¥è¯†æˆ–èƒŒæ™¯æ‰èƒ½å›ç­”çš„é—®é¢˜
   - ä¸å¾—è®¾è®¡ç­”æ¡ˆæ¨¡ç³Šæˆ–æœ‰å¤šç§å¯èƒ½è§£é‡Šçš„é—®é¢˜

{"7. **å¤šè½®å¯¹è¯è¦æ±‚**ï¼šéœ€è¦è®¾è®¡" + rounds_text + "è½®å¯¹è¯ï¼Œæ¯è½®éƒ½æœ‰ç‹¬ç«‹çš„é—®é¢˜å’Œç­”æ¡ˆï¼Œå½¢æˆå®Œæ•´çš„å¯¹è¯æµç¨‹ã€‚æ¯è½®é—®é¢˜éƒ½åº”éµå¾ªä¸Šè¿°æ‰€æœ‰è¦æ±‚ï¼Œä¸”å„è½®ä¹‹é—´åº”å½¢æˆé€»è¾‘é€’è¿›æˆ–å…³è”ï¼ˆå¦‚ï¼šç¬¬1è½®è¯†åˆ«æ•°æ® â†’ ç¬¬2è½®è®¡ç®—æŒ‡æ ‡ â†’ ç¬¬3è½®ç»¼åˆåˆ¤æ–­ï¼‰ã€‚æ‰€æœ‰è½®æ¬¡çš„é—®é¢˜éƒ½å¿…é¡»é’ˆå¯¹åŒä¸€å¼ å›¾ç‰‡ã€‚" if is_multi_round else ""}
"""
    else:
        base_prompt = f"""
ä½ æ˜¯ä¸€åé¡¶çº§çš„é‡‘èå¤šæ¨¡æ€é«˜éš¾åº¦ VQA é¢˜ç›®æ„å»ºä¸“å®¶ï¼Œæ“…é•¿ä»å¤æ‚çš„"å›¾è¡¨+æ–‡å­—è¯´æ˜"ç±»é‡‘èå›¾åƒä¸­ï¼Œè®¾è®¡éœ€è¦å¤šå±‚é€»è¾‘é“¾æ¡çš„ä¸“ä¸šçº§åˆ†æé¢˜ã€‚

è¯·åŸºäºç»™å®šçš„é‡‘èå›¾åƒï¼ˆå¯èƒ½åŒ…å«æŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€é¥¼å›¾ã€åŒæ¯”/ç¯æ¯”æ•°æ®ã€ç™¾åˆ†æ¯”ç»“æ„ã€è¡¨æ ¼ã€è¯´æ˜æ–‡å­—ã€æŒ‡æ ‡å®šä¹‰ã€å›¾ä¾‹ã€æ³¨é‡Šç­‰å¤šç§å…ƒç´ ï¼‰ï¼Œç”Ÿæˆä¸€é“ã€{question_type_name_cn}ã€‘ã€‚é¢˜ç›®éš¾åº¦éœ€æ˜¾è‘—é«˜äºä¸€èˆ¬é‡‘èç ”ç©¶å‘˜æ°´å¹³ï¼Œå¿…é¡»ä¾èµ–å›¾ä¸­å¤šä¸ªä¿¡æ¯å—çš„äº¤å‰ä½¿ç”¨ï¼ˆå›¾è¡¨ + æ–‡å­—è¯´æ˜ + æ³¨é‡Š + å›¾ä¾‹ï¼‰ã€‚

**ã€ä»»åŠ¡è¦æ±‚ã€‘**

1. **é¢˜ç›®éš¾åº¦éœ€è¾¾åˆ°é‡‘èåˆ†æå¸ˆ/ç ”ç©¶å‘˜æ°´å¹³**
   å¿…é¡»ç”Ÿæˆéœ€è¦å¤šæ­¥æ¨ç†çš„é‡‘èæ¨ç†é—®é¢˜ï¼Œé—®é¢˜çš„ç­”æ¡ˆåªèƒ½ä¾èµ–å›¾åƒä¸­çš„å†…å®¹å¾—åˆ°,æ¨ç†ã€‚é¢˜ç›®ç±»å‹å¯ä»¥åŒ…æ‹¬ä½†ä¸é™äºï¼š
   - è´¢åŠ¡æŒ‡æ ‡æ¨ç†ï¼ˆåŸºäºå›¾ä¸­æ•°æ®è¿›è¡Œè®¡ç®—æˆ–é€»è¾‘æ¨æ–­ï¼‰
   - å›¾è¡¨è¶‹åŠ¿åˆ†æä¸æ¨æ–­ï¼ˆè¯†åˆ«æ‹ç‚¹ã€åŠ é€Ÿ/å‡é€Ÿã€å‘¨æœŸæ€§ç­‰ï¼‰
   - ç»“æ„åŒ–å›¾å½¢æ¨ç†ï¼ˆå¦‚è‚¡æƒç»“æ„ã€èµ„äº§ç»“æ„ã€ä¸šåŠ¡æ„æˆç­‰ï¼‰
   - å¤šå®ä½“å…³ç³»æ¨æ–­ï¼ˆæ¯”è¾ƒã€æ’åºã€å…³è”åˆ†æç­‰ï¼‰
   - æ¯”è¾ƒç±»é—®é¢˜ï¼ˆå¢é•¿æœ€å¿«ã€å æ¯”æœ€é«˜ã€ç»“æ„å˜åŒ–ã€ç›¸å¯¹è¡¨ç°ç­‰ï¼‰
   - ç»æµæˆ–ä¸šåŠ¡å«ä¹‰æ¨æ–­ï¼ˆåŸºäºå›¾ä¸­å®¢è§‚ä¿¡æ¯å¾—å‡ºç»“è®ºï¼‰
   - è·¨å›¾è¡¨ç»¼åˆåˆ†æï¼ˆå¤šé¡¹æŒ‡æ ‡ä¹‹é—´çš„é“¾å¼æ¨æ–­ï¼Œå¦‚ Aâ†’Bâ†’Cï¼‰
2. **å›¾å½¢ç±»å‹çš„å¼ºåˆ¶è¦æ±‚**
    å›¾ä¸­è‹¥å‡ºç°ä»¥ä¸‹å›¾å½¢åˆ™éœ€éµå®ˆå¯¹åº”åŸåˆ™ï¼š
    A. æŠ˜çº¿å›¾
    -åªèƒ½å¼•å…¥æ˜ç¡®å›¾ç‰‡æˆ–æ–‡å­—ä¸­æœ‰æ ‡æ³¨çš„æ•°æ®ï¼Œä¸å¾—æ ¹æ®æŠ˜çº¿å›¾å’Œåæ ‡è½´è§‚å¯Ÿå‡ºè¿‘ä¼¼æ•°æ®ï¼Œè‹¥æ²¡æœ‰æ˜ç¡®æ•°æ®åˆ™ç¦æ­¢å‡ºç›¸åº”æ•°å€¼è®¡ç®—ç±»å‹é¢˜ç›®ã€‚
    é—®é¢˜å‚è€ƒï¼š
    -äºŒé˜¶å·®åˆ†/ç¦»æ•£åŠ é€Ÿåº¦åˆ¤æ–­æ‹ç‚¹ï¼›
    -çº¿æ€§/æŒ‡æ•°æ‹Ÿåˆå¹¶å†…æ’æˆ–çŸ­æœŸå¤–æ¨ï¼›
    -å¯¹æ•°æ”¶ç›Šç‡ã€é“¾å¼æŒ‡æ•°æˆ–å¤åˆå¢é•¿ï¼›
    -ä½¿ç”¨æŠ˜çº¿å›¾ä¸­çš„æ³¨é‡Š/äº‹ä»¶çª—å£ä½œä¸ºè¿ç®—çº¦æŸã€‚
    B. æŸ±çŠ¶å›¾æˆ–å †å æŸ±çŠ¶å›¾
    -åªèƒ½å¼•å…¥æ˜ç¡®å›¾ç‰‡æˆ–æ–‡å­—ä¸­æœ‰æ ‡æ³¨çš„æ•°æ®ï¼Œä¸å¾—æ ¹æ®æŠ˜çº¿å›¾å’Œåæ ‡è½´è§‚å¯Ÿå‡ºè¿‘ä¼¼æ•°æ®ï¼Œè‹¥æ²¡æœ‰æ˜ç¡®æ•°æ®åˆ™ç¦æ­¢å‡ºç›¸åº”æ•°å€¼è®¡ç®—ç±»å‹é¢˜ç›®ã€‚
    é—®é¢˜å‚è€ƒï¼š
    -ç»“æ„å˜åŒ–å½’å› åˆ†è§£ï¼ˆæƒé‡ * å˜åŠ¨ï¼‰ï¼›
    -è·¨æœŸæ ‡å‡†åŒ–ï¼ˆå¦‚æŒ‰åŸºæœŸæˆ–äººå‡ï¼‰ï¼›
    -åº¦é‡ç»Ÿä¸€è½¬æ¢ï¼ˆç™¾åˆ†æ¯” â†” ç»å¯¹å€¼ï¼‰ã€‚
    C. è¡¨æ ¼
    é—®é¢˜å‚è€ƒï¼š
    -åˆ©ç”¨åˆ—é—´/è¡Œé—´çº¦æŸæ„é€ æ–¹ç¨‹æ±‚è§£éšè—æŒ‡æ ‡ï¼›
    -å¤šæŒ‡æ ‡æ ‡å‡†åŒ–æˆ–åŠ æƒåˆæˆï¼›
    -åˆ©ç”¨ç‡ç±»æŒ‡æ ‡åæ¨ç»å¯¹æ•°ã€‚
3. **æ‰€æœ‰é—®é¢˜å¿…é¡»æ»¡è¶³ï¼ˆç¡¬æ€§è¦æ±‚ï¼‰**ï¼š
   - ç­”æ¡ˆå”¯ä¸€ã€å®¢è§‚ã€å¯éªŒè¯ï¼ˆä¸èƒ½æœ‰æ­§ä¹‰æˆ–å¤šç§è§£é‡Šï¼‰
   - å¿…é¡»ä¸¥æ ¼ä¾èµ–å›¾åƒä¸­çš„ä¿¡æ¯ï¼ˆä¸èƒ½ä¾èµ–å›¾å¤–çŸ¥è¯†æˆ–å‡è®¾ï¼‰
   - é¢˜å¹²ä¸å¾—ç›´æ¥ç»™å‡ºå›¾ç‰‡å†…å·²æœ‰çš„ç»“æ„åŒ–æ•°æ®æˆ–ç»“è®º
   - ä¸å…è®¸ä¸»è§‚ç±»é—®é¢˜ï¼ˆå¦‚"ä½ æ€ä¹ˆçœ‹""æ˜¯å¦åˆç†"ï¼‰
   - ä¸å…è®¸å¼€æ”¾å¼å›ç­”ï¼ˆå¦‚"åˆ—å‡ºå¯èƒ½çš„åŸå› ""å¯èƒ½æœ‰å“ªäº›å½±å“"ï¼‰
   - **ã€ç»å¯¹ç¦æ­¢ã€‘ä¸¥ç¦åœ¨é—®é¢˜ä¸­ä½¿ç”¨ä»¥ä¸‹ä»»ä½•è¯æ±‡ï¼š"æ¨æ–­"ã€"å¯èƒ½"ã€"æœ€å¯èƒ½"ã€"æ¨æµ‹"ã€"ä¼°è®¡"ã€"å¦‚ä½•"ã€"ä¸ºä»€ä¹ˆ"ã€"å“ªäº›"ã€"ä»€ä¹ˆåŸå› "ã€"ä»€ä¹ˆå½±å“"ã€"ä»€ä¹ˆå› ç´ "ç­‰è¡¨ç¤ºä¸ç¡®å®šæ€§æˆ–å¼€æ”¾æ€§çš„è¯æ±‡**
   - **é—®é¢˜å¿…é¡»ç›´æ¥ã€æ˜ç¡®ã€å®¢è§‚ï¼Œä½¿ç”¨"è®¡ç®—"ã€"ç¡®å®š"ã€"æ‰¾å‡º"ã€"æ¯”è¾ƒ"ç­‰ç¡®å®šæ€§è¯æ±‡**
   - **ç­”æ¡ˆå¿…é¡»ç®€æ´æ˜ç¡®ï¼ˆä¸è¶…è¿‡50å­—ï¼‰ï¼Œä¸å¾—åŒ…å«å†—é•¿çš„è§£é‡Šæ€§æ–‡å­—ï¼Œå¦‚æœæ˜¯è®¡ç®—é¢˜ç›´æ¥ç»™å‡ºæ•°å€¼ï¼Œå¦‚æœæ˜¯é€‰æ‹©é¢˜ç›´æ¥ç»™å‡ºé€‰é¡¹ï¼Œå¦‚æœæ˜¯é—®ç­”é¢˜ç›´æ¥ç»™å‡ºç®€çŸ­ç»“è®º**
   - é€‰æ‹©é¢˜å¿…é¡»åŒ…å«æ­£ç¡®é€‰é¡¹ï¼Œå¯¹äºè®¡ç®—ç±»å‹å¯ä»¥å…ˆç®—å‡ºç­”æ¡ˆåæŠŠç­”æ¡ˆä½œä¸ºé€‰é¡¹ä¹‹ä¸€ 
   - ç­”æ¡ˆæœ€å¥½ç”±å›¾è¡¨å’Œæ–‡å­—ä¸¤éƒ¨åˆ†ä¿¡æ¯å…±åŒæ¨ç†å¾—å‡º
4. **éš¾åº¦è¦æ±‚ï¼šç»“åˆä½†ä¸é™äºä»¥ä¸‹è¦æ±‚**ï¼š
   - æ¶‰åŠè·¨å¹´åº¦ã€è·¨å­£åº¦ã€è·¨åŒºåŸŸçš„è¶‹åŠ¿æ¯”è¾ƒ
   - åŒæ—¶ä½¿ç”¨å›¾è¡¨æ•°å€¼ + å›¾ä¾‹è§£é‡Š + æ–‡å­—è¯´æ˜
   - å¤šæŒ‡æ ‡ä¹‹é—´çš„é“¾å¼æ¨ç†ï¼ˆAâ†’Bâ†’Cï¼Œéœ€è¦è‡³å°‘ 2-3 æ­¥æ¨ç†ï¼‰
   - ç»“æ„å æ¯”å˜åŒ–æ¨æ–­ï¼ˆå¦‚"å“ªéƒ¨åˆ†è´¡çŒ®æœ€å¤§""ç»“æ„å¦‚ä½•å˜åŒ–"ï¼‰
   - ä»åŒæ¯” + ç¯æ¯”çš„å åŠ ä¿¡æ¯å¾—å‡ºåˆ¤æ–­
   - ä½¿ç”¨å›¾ä¸­å¤šä¸ªå›¾å—ï¼ˆå¦‚ä¸»å›¾ + å­å›¾ + è¡¨æ ¼ï¼‰ç»¼åˆæ¨æ–­
   - è®¡ç®—é¢˜ä¸å¾—åªåŒ…æ‹¬åŠ å‡ä¹˜é™¤ï¼Œè¿˜éœ€åŒ…æ‹¬ä½†ä¸é™äºå¦‚ä¸‹å¤æ‚æ“ä½œï¼š
    æœ‰é™å·®åˆ†ã€äºŒé˜¶å·®åˆ†ï¼›
    å¯¹æ•°å˜æ¢ã€å¯¹æ•°å·®ï¼›
    CAGR/å¹´åŒ–å¢é•¿ï¼›
    è§£æå‹æ‹Ÿåˆï¼ˆçº¿æ€§/æŒ‡æ•°ï¼‰ï¼›
    è§£çº¿æ€§æ–¹ç¨‹ç»„ï¼›
    åŠ æƒè´¡çŒ®åˆ†è§£ï¼›
    æ ‡å‡†åŒ–å½’ä¸€åŒ–ã€‚

5. **å…³äºç­”æ¡ˆæ ¼å¼çš„è¦æ±‚ï¼ˆé‡è¦ï¼‰**ï¼š
   - æ³¨æ„ï¼šé¢˜å‹ï¼ˆ{question_type_name_cn}ï¼‰å·²æŒ‡å®šï¼Œéœ€è¦ä¸¥æ ¼æŒ‰ç…§é¢˜å‹è¦æ±‚è®¾è®¡é¢˜ç›®

6. **æ€ç»´é“¾è¦æ±‚**ï¼š
   å¿…é¡»åœ¨ qa_make_process å­—æ®µä¸­è¯¦ç»†è®°å½•è§£é¢˜çš„å®Œæ•´æ¨ç†é“¾æ¡ï¼ŒåŒ…æ‹¬ï¼š
   - ä»å›¾ä¸­å“ªäº›ä½ç½®è·å–äº†å“ªäº›ä¿¡æ¯
   - å¦‚ä½•å°†è¿™äº›ä¿¡æ¯ç»„åˆèµ·æ¥è¿›è¡Œæ¨ç†
   - æ¯ä¸€æ­¥çš„è®¡ç®—æˆ–é€»è¾‘åˆ¤æ–­è¿‡ç¨‹
   - æœ€ç»ˆå¦‚ä½•å¾—å‡ºç­”æ¡ˆ

7. **ä¸¥ç¦çš„è¡Œä¸º**ï¼š
   - ä¸å¾—åœ¨é¢˜å¹²ä¸­ç›´æ¥æ³„éœ²å›¾ä¸­çš„å…³é”®æ•°æ®æˆ–ç»“è®º
   - ä¸å¾—è®¾è®¡ä¾èµ–å¤–éƒ¨çŸ¥è¯†æˆ–èƒŒæ™¯æ‰èƒ½å›ç­”çš„é—®é¢˜
   - ä¸å¾—è®¾è®¡ç­”æ¡ˆæ¨¡ç³Šæˆ–æœ‰å¤šç§å¯èƒ½è§£é‡Šçš„é—®é¢˜
   - ä¸å¾—è®¾è®¡ä¸»è§‚æ€§è¾ƒå¼ºçš„æ¨æ–­é¢„æµ‹é—®é¢˜ï¼Œç­”æ¡ˆå¿…é¡»è¦æœ‰æ˜ç¡®ä¾æ®,ä¾‹å¦‚æŠ˜çº¿å›¾ä¸å¾—å‡ºä¼°ç®—æ•°å€¼ã€é¢„æµ‹è¶‹åŠ¿ç­‰é—®é¢˜ã€‚

{"8. **å¤šè½®å¯¹è¯è¦æ±‚**ï¼šéœ€è¦è®¾è®¡" + rounds_text + "è½®å¯¹è¯ï¼Œæ¯è½®éƒ½æœ‰ç‹¬ç«‹çš„é—®é¢˜å’Œç­”æ¡ˆï¼Œå½¢æˆå®Œæ•´çš„å¯¹è¯æµç¨‹ã€‚æ¯è½®é—®é¢˜éƒ½åº”éµå¾ªä¸Šè¿°æ‰€æœ‰è¦æ±‚ï¼Œä¸”å„è½®ä¹‹é—´åº”å½¢æˆé€»è¾‘é€’è¿›æˆ–å…³è”ï¼ˆå¦‚ï¼šç¬¬1è½®è¯†åˆ«æ•°æ® â†’ ç¬¬2è½®è®¡ç®—æŒ‡æ ‡ â†’ ç¬¬3è½®ç»¼åˆåˆ¤æ–­ï¼‰ã€‚" if is_multi_round else ""}
"""
    
    # æ·»åŠ è¾“å‡ºæ ¼å¼è¦æ±‚
    type_requirements = get_prompt_template(image_type, question_type, rounds=rounds, include_process=include_process)
    # æå–ç±»å‹è¦æ±‚éƒ¨åˆ†ï¼ˆå»æ‰å›¾ç‰‡ç±»å‹éƒ¨åˆ†ï¼‰
    if "**ã€ä»»åŠ¡è¦æ±‚ã€‘**" in type_requirements:
        type_part = type_requirements.split("**ã€ä»»åŠ¡è¦æ±‚ã€‘**")[-1]
    else:
        type_part = type_requirements
    
    return base_prompt + "\n\n" + type_part


def _get_step2_prompt() -> str:
    """ç¬¬äºŒæ­¥ï¼šç­”æ¡ˆæ£€éªŒprompt"""
    return """
ä½ æ˜¯ä¸€åä¸“ä¸šçš„é‡‘èé¢˜ç›®è´¨é‡æ£€éªŒä¸“å®¶ï¼Œè´Ÿè´£æ£€éªŒé¢˜ç›®çš„ç­”æ¡ˆæ˜¯å¦æ­£ç¡®ã€æ¨ç†è¿‡ç¨‹æ˜¯å¦åˆç†ã€‚

**ã€ä»»åŠ¡è¦æ±‚ã€‘**

è¯·ä»”ç»†æ£€æŸ¥ç»™å®šçš„é¢˜ç›®ã€ç­”æ¡ˆå’Œæ¨ç†è¿‡ç¨‹ï¼Œåˆ¤æ–­ç­”æ¡ˆæ˜¯å¦æ­£ç¡®ã€‚ä½ éœ€è¦ï¼š

1. **ç­”æ¡ˆæ­£ç¡®æ€§æ£€éªŒ**ï¼š
   - æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦å¯ä»¥ä»å›¾åƒä¸­æ¨å¯¼å¾—å‡º
   - éªŒè¯æ¨ç†è¿‡ç¨‹ä¸­çš„æ¯ä¸€æ­¥æ˜¯å¦åˆç†
   - ç¡®è®¤æ‰€æœ‰ä½¿ç”¨çš„æ•°æ®æ˜¯å¦çœŸå®å­˜åœ¨äºå›¾åƒä¸­
   - æ£€æŸ¥è®¡ç®—è¿‡ç¨‹æ˜¯å¦æ­£ç¡®ï¼ˆå¦‚æœ‰è®¡ç®—ï¼‰
   - éªŒè¯é€»è¾‘æ¨ç†æ˜¯å¦ä¸¥å¯†
   - **æ£€æŸ¥é—®é¢˜è¡¨è¿°æ˜¯å¦åŒ…å«å¼€æ”¾æ€§è¯æ±‡**ï¼šå¦‚æœé—®é¢˜ä¸­åŒ…å«"æ¨æ–­"ã€"å¯èƒ½"ã€"æœ€å¯èƒ½"ã€"æ¨æµ‹"ã€"ä¼°è®¡"ç­‰è¡¨ç¤ºä¸ç¡®å®šæ€§çš„è¯æ±‡ï¼Œå¿…é¡»åˆ¤å®šä¸ºä¸é€šè¿‡
   - **æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦è¿‡äºå†—é•¿**ï¼šå¦‚æœç­”æ¡ˆåŒ…å«å¤§é‡è§£é‡Šæ€§æ–‡å­—è€Œéç›´æ¥ç»™å‡ºç»“æœï¼Œå¿…é¡»åˆ¤å®šä¸ºä¸é€šè¿‡

2. **æ¨ç†è¿‡ç¨‹å®Œæ•´æ€§æ£€éªŒ**ï¼š
   - æ£€æŸ¥qa_make_processæ˜¯å¦è¯¦ç»†è®°å½•äº†æ¯ä¸€æ­¥æ¨ç†
   - ç¡®è®¤æ¨ç†é“¾æ¡æ˜¯å¦å®Œæ•´ï¼Œæ²¡æœ‰è·³è·ƒ
   - éªŒè¯æ¯ä¸€æ­¥æ˜¯å¦éƒ½æœ‰æ˜ç¡®çš„ä¾æ®ï¼ˆæ¥è‡ªå›¾åƒçš„å“ªäº›ä½ç½®ï¼‰

3. **è¾“å‡ºæ ¼å¼**ï¼š
   è¯·è¾“å‡ºJSONæ ¼å¼ï¼š
   {
       "status": "pass" æˆ– "fail",
       "reason": "æ£€éªŒé€šè¿‡çš„åŸå› " æˆ– "æ£€éªŒä¸é€šè¿‡çš„å…·ä½“åŸå› ï¼ˆè¯¦ç»†è¯´æ˜å“ªé‡Œæœ‰é—®é¢˜ï¼‰",
       "issues": ["é—®é¢˜1", "é—®é¢˜2", ...],  // å¦‚æœä¸é€šè¿‡ï¼Œåˆ—å‡ºæ‰€æœ‰é—®é¢˜
       "suggestions": "å¦‚ä½•ä¿®æ­£çš„å»ºè®®"  // å¦‚æœä¸é€šè¿‡ï¼Œæä¾›ä¿®æ­£å»ºè®®
   }

4. **åˆ¤æ–­æ ‡å‡†ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰**ï¼š
   - **ã€ç¡¬æ€§æ‹’ç»æ¡ä»¶ - ä¼˜å…ˆçº§æœ€é«˜ã€‘**ï¼šå¦‚æœé—®é¢˜ä¸­åŒ…å«"æ¨æ–­"ã€"å¯èƒ½"ã€"æœ€å¯èƒ½"ã€"æ¨æµ‹"ã€"ä¼°è®¡"ã€"å¦‚ä½•"ã€"ä¸ºä»€ä¹ˆ"ç­‰è¡¨ç¤ºä¸ç¡®å®šæ€§æˆ–å¼€æ”¾æ€§çš„è¯æ±‡ï¼Œ**å¿…é¡»ç«‹å³è¿”å› status="fail"**ï¼Œè¿™æ˜¯ä¸å¯æ¥å—çš„
   - **ã€ç¡¬æ€§æ‹’ç»æ¡ä»¶ã€‘**ï¼šå¦‚æœç­”æ¡ˆè¿‡äºå†—é•¿ï¼ˆè¶…è¿‡50å­—ä¸”åŒ…å«å¤§é‡è§£é‡Šæ€§æ–‡å­—ï¼Œè€Œéç›´æ¥ç»™å‡ºæ•°å€¼æˆ–é€‰é¡¹ï¼‰ï¼Œ**å¿…é¡»ç«‹å³è¿”å› status="fail"**
   - å¦‚æœç­”æ¡ˆé”™è¯¯ã€æ¨ç†è¿‡ç¨‹æœ‰æ¼æ´ã€ä½¿ç”¨äº†å›¾åƒä¸­ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè¿”å› status="fail"
   - å¦‚æœå­˜åœ¨ä»»ä½•ä¸ç¡®å®šæˆ–æ¨¡ç³Šçš„åœ°æ–¹ï¼Œè¿”å› status="fail"
   - å¦‚æœç­”æ¡ˆæ­£ç¡®ã€æ¨ç†è¿‡ç¨‹å®Œæ•´ä¸”åˆç†ï¼Œä¸”ä¸è¿åä¸Šè¿°ç¡¬æ€§æ¡ä»¶ï¼Œè¿”å› status="pass"

è¯·åŸºäºç»™å®šçš„é¢˜ç›®ã€ç­”æ¡ˆå’Œæ¨ç†è¿‡ç¨‹è¿›è¡Œæ£€éªŒã€‚
"""


def _get_step3_prompt() -> str:
    """ç¬¬ä¸‰æ­¥ï¼šé¢˜ç›®è´¨é‡æå‡prompt"""
    return """
ä½ æ˜¯ä¸€åä¸“ä¸šçš„é‡‘èå¤šæ¨¡æ€VQAé¢˜ç›®è´¨é‡è¯„ä¼°ä¸“å®¶ï¼Œè´Ÿè´£è¯„ä¼°å’Œæå‡é¢˜ç›®çš„è´¨é‡ï¼Œç¡®ä¿é¢˜ç›®èƒ½å¤Ÿæœ‰æ•ˆè€ƒå¯Ÿæ¨¡å‹çš„å›¾æ–‡ç†è§£ã€è®¡ç®—æ¨ç†å’Œè¯†å›¾èƒ½åŠ›ã€‚

**ã€ä»»åŠ¡è¦æ±‚ã€‘**

è¯·å¯¹ç»™å®šçš„é¢˜ç›®è¿›è¡Œå…¨é¢è´¨é‡è¯„ä¼°ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. **å›¾æ–‡è”ç³»è´¨é‡**ï¼š
   - é¢˜ç›®æ˜¯å¦å……åˆ†åˆ©ç”¨äº†å›¾åƒä¸­çš„ä¿¡æ¯ï¼ˆå›¾è¡¨ã€æ–‡å­—ã€å›¾ä¾‹ã€æ³¨é‡Šç­‰ï¼‰
   - æ˜¯å¦è¦æ±‚æ¨¡å‹åŒæ—¶ç†è§£å›¾åƒå’Œæ–‡å­—è¯´æ˜
   - æ˜¯å¦é¿å…äº†ä»…ä¾èµ–å•ä¸€ä¿¡æ¯æºå°±èƒ½å›ç­”çš„é—®é¢˜
   - å›¾æ–‡ä¿¡æ¯çš„ç»“åˆæ˜¯å¦è‡ªç„¶ã€å¿…è¦

2. **è®¡ç®—æ­¥éª¤è´¨é‡**ï¼š
   - è®¡ç®—é¢˜æ˜¯å¦æ¶‰åŠå¤šæ­¥æ¨ç†ï¼ˆè‡³å°‘2-3æ­¥ï¼‰
   - è®¡ç®—è¿‡ç¨‹æ˜¯å¦å¤æ‚ä¸”æœ‰æ„ä¹‰ï¼ˆä¸åªæ˜¯ç®€å•åŠ å‡ä¹˜é™¤ï¼‰
   - æ˜¯å¦æ¶‰åŠé‡‘èé¢†åŸŸçš„ä¸“ä¸šè®¡ç®—ï¼ˆå¦‚å¢é•¿ç‡ã€å æ¯”ã€æ¯”ç‡ã€åŠ æƒå¹³å‡ç­‰ï¼‰
   - è®¡ç®—æ­¥éª¤æ˜¯å¦æ¸…æ™°å¯éªŒè¯

3. **è¯†å›¾èƒ½åŠ›è¦æ±‚**ï¼š
   - æ˜¯å¦è€ƒå¯Ÿäº†æ¨¡å‹å¯¹å›¾åƒå…ƒç´ çš„è¯†åˆ«èƒ½åŠ›ï¼ˆé¢œè‰²ã€æ•°å­—ã€æ ‡ç­¾ã€å›¾ä¾‹ç­‰ï¼‰
   - **é‡è¦**ï¼šå¦‚æœæ˜¯æŠ˜çº¿å›¾ï¼Œä¸å¾—å‡ºéœ€è¦ä»æŠ˜çº¿å›¾è¯»å–æ•°å€¼çš„é¢˜ç›®ï¼ˆåªèƒ½ä½¿ç”¨æ˜ç¡®æ ‡æ³¨çš„æ•°æ®ï¼‰
   - æ˜¯å¦è¦æ±‚è¯†åˆ«å›¾è¡¨ç±»å‹ã€åæ ‡è½´å«ä¹‰ã€å›¾ä¾‹å¯¹åº”å…³ç³»ç­‰
   - è¯†å›¾è¦æ±‚æ˜¯å¦ä¸æ¨ç†è¦æ±‚æœ‰æœºç»“åˆ

4. **é¢˜ç›®éš¾åº¦ä¸åŒºåˆ†åº¦**ï¼š
   - é¢˜ç›®éš¾åº¦æ˜¯å¦è¾¾åˆ°é‡‘èåˆ†æå¸ˆ/ç ”ç©¶å‘˜æ°´å¹³
   - æ˜¯å¦èƒ½å¤Ÿæœ‰æ•ˆåŒºåˆ†ä¸åŒèƒ½åŠ›çš„æ¨¡å‹
   - æ˜¯å¦é¿å…äº†è¿‡äºç®€å•æˆ–è¿‡äºå›°éš¾çš„é—®é¢˜

5. **å¼€æ”¾æ€§é—®ç­”æ£€æŸ¥ï¼ˆç¡¬æ€§æ‹’ç»æ¡ä»¶ï¼‰**ï¼š
   - **ä¸¥ç¦**ï¼šé—®é¢˜åŒ…å«"æ¨æ–­"ã€"å¯èƒ½"ã€"æœ€å¯èƒ½"ã€"æ¨æµ‹"ã€"ä¼°è®¡"ã€"å¦‚ä½•"ã€"ä¸ºä»€ä¹ˆ"ã€"å“ªäº›"ã€"ä»€ä¹ˆåŸå› "ç­‰è¡¨ç¤ºä¸ç¡®å®šæ€§æˆ–å¼€æ”¾æ€§çš„è¯æ±‡
   - **ä¸¥ç¦**ï¼šç­”æ¡ˆè¿‡äºå†—é•¿ï¼ˆè¶…è¿‡50å­—ä¸”åŒ…å«å¤§é‡è§£é‡Šæ€§æ–‡å­—ï¼‰ï¼Œç­”æ¡ˆå¿…é¡»ç›´æ¥ç»™å‡ºæ•°å€¼ã€é€‰é¡¹æˆ–ç®€çŸ­ç»“è®º
   - ç­”æ¡ˆå¿…é¡»ç›´æ¥ã€æ˜ç¡®ã€ç®€æ´ï¼Œä¸å¾—åŒ…å«æ¨ç†è¿‡ç¨‹çš„è§£é‡Š

6. **è¾“å‡ºæ ¼å¼**ï¼š
   è¯·è¾“å‡ºJSONæ ¼å¼ï¼š
   {
       "status": "pass" æˆ– "fail",
       "quality_score": 0-100,  // è´¨é‡è¯„åˆ†
       "issues": {
           "image_text_connection": "å›¾æ–‡è”ç³»æ–¹é¢çš„é—®é¢˜ï¼ˆå¦‚æœ‰ï¼‰",
           "calculation_steps": "è®¡ç®—æ­¥éª¤æ–¹é¢çš„é—®é¢˜ï¼ˆå¦‚æœ‰ï¼‰",
           "image_recognition": "è¯†å›¾èƒ½åŠ›æ–¹é¢çš„é—®é¢˜ï¼ˆå¦‚æœ‰ï¼‰",
           "difficulty": "éš¾åº¦æ–¹é¢çš„é—®é¢˜ï¼ˆå¦‚æœ‰ï¼‰"
       },
       "suggestions": "å¦‚ä½•æå‡è´¨é‡çš„å»ºè®®",
       "improved_question": {  // å¦‚æœä¸é€šè¿‡ï¼Œæä¾›æ”¹è¿›åçš„é¢˜ç›®ï¼ˆå®Œæ•´JSONå¯¹è±¡ï¼‰
           // å®Œæ•´çš„é¢˜ç›®å¯¹è±¡ï¼ŒåŒ…æ‹¬question, answer, options, qa_make_processç­‰
       }
   }

7. **åˆ¤æ–­æ ‡å‡†ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰**ï¼š
   - **ã€ç¡¬æ€§æ‹’ç»æ¡ä»¶ - ä¼˜å…ˆçº§æœ€é«˜ã€‘**ï¼šå¦‚æœé—®é¢˜åŒ…å«"æ¨æ–­"ã€"å¯èƒ½"ã€"æœ€å¯èƒ½"ã€"æ¨æµ‹"ã€"ä¼°è®¡"ã€"å¦‚ä½•"ã€"ä¸ºä»€ä¹ˆ"ã€"å“ªäº›"ç­‰å¼€æ”¾æ€§è¯æ±‡ï¼Œ**å¿…é¡»ç«‹å³è¿”å› status="fail"**ï¼Œè¿™æ˜¯ä¸å¯æ¥å—çš„
   - **ã€ç¡¬æ€§æ‹’ç»æ¡ä»¶ã€‘**ï¼šå¦‚æœç­”æ¡ˆè¿‡äºå†—é•¿ï¼ˆè¶…è¿‡50å­—ä¸”åŒ…å«å¤§é‡è§£é‡Šï¼‰ï¼Œ**å¿…é¡»ç«‹å³è¿”å› status="fail"**
   - ç‰¹åˆ«å…³æ³¨ï¼šæŠ˜çº¿å›¾é¢˜ç›®æ˜¯å¦è¿åäº†"ä¸å¾—å‡ºè¯»æ•°é¢˜ç›®"çš„è¦æ±‚ï¼Œå¦‚æœè¿åè¿”å› status="fail"
   - å¦‚æœé¢˜ç›®åœ¨å›¾æ–‡è”ç³»ã€è®¡ç®—æ­¥éª¤ã€è¯†å›¾è¦æ±‚ç­‰æ–¹é¢éƒ½è¾¾åˆ°é«˜è´¨é‡æ ‡å‡†ï¼Œä¸”ä¸è¿åä¸Šè¿°ç¡¬æ€§æ¡ä»¶ï¼Œè¿”å› status="pass"
   - å¦‚æœä»»ä½•å…¶ä»–æ–¹é¢å­˜åœ¨ä¸è¶³ï¼Œè¿”å› status="fail" å¹¶æä¾›æ”¹è¿›å»ºè®®

è¯·åŸºäºç»™å®šçš„é¢˜ç›®å’Œå›¾åƒè¿›è¡Œè´¨é‡è¯„ä¼°ã€‚
"""


def _get_step4_prompt() -> str:
    """ç¬¬å››æ­¥ï¼šæ•´ä½“è´¨é‡æ£€æµ‹prompt"""
    return """
ä½ æ˜¯ä¸€åé¡¶çº§çš„é‡‘èå¤šæ¨¡æ€VQAé¢˜ç›®æœ€ç»ˆè´¨é‡å®¡æ ¸ä¸“å®¶ï¼Œè´Ÿè´£å¯¹é¢˜ç›®è¿›è¡Œæ•´ä½“è´¨é‡æ£€æµ‹ï¼Œç¡®ä¿æœ€ç»ˆäº§å‡ºçš„æ˜¯é«˜è´¨é‡é‡‘èå¤šæ¨¡æ€æ¨ç†éš¾é¢˜ã€‚

**ã€ä»»åŠ¡è¦æ±‚ã€‘**

è¯·å¯¹ç»™å®šçš„é¢˜ç›®è¿›è¡Œæœ€ç»ˆæ•´ä½“è´¨é‡æ£€æµ‹ï¼Œé‡ç‚¹å…³æ³¨ï¼š

1. **ç­”æ¡ˆæ•´ä½“æ­£ç¡®æ€§**ï¼š
   - ç­”æ¡ˆæ˜¯å¦å®Œå…¨æ­£ç¡®ï¼Œæ²¡æœ‰ä»»ä½•é”™è¯¯
   - ç­”æ¡ˆæ˜¯å¦å”¯ä¸€ã€å®¢è§‚ã€å¯éªŒè¯
   - æ˜¯å¦å­˜åœ¨å¤šç§å¯èƒ½çš„è§£é‡Šæˆ–æ­§ä¹‰
   - é€‰æ‹©é¢˜çš„é€‰é¡¹æ˜¯å¦åˆç†ï¼Œå¹²æ‰°é¡¹æ˜¯å¦æœ‰æ•ˆ

2. **é—®é¢˜è´¨é‡**ï¼š
   - é—®é¢˜è¡¨è¿°æ˜¯å¦æ¸…æ™°ã€å‡†ç¡®ã€ä¸“ä¸š
   - é—®é¢˜æ˜¯å¦é¿å…äº†ç›´æ¥æ³„éœ²ç­”æ¡ˆæˆ–å…³é”®ä¿¡æ¯
   - é—®é¢˜æ˜¯å¦ç¬¦åˆé‡‘èé¢†åŸŸçš„å®é™…åº”ç”¨åœºæ™¯
   - é—®é¢˜æ˜¯å¦èƒ½å¤Ÿæœ‰æ•ˆè€ƒå¯Ÿæ¨¡å‹çš„æ¨ç†èƒ½åŠ›

3. **éš¾åº¦è¯„ä¼°**ï¼š
   - é¢˜ç›®éš¾åº¦æ˜¯å¦è¾¾åˆ°é‡‘èåˆ†æå¸ˆ/ç ”ç©¶å‘˜æ°´å¹³
   - æ˜¯å¦æ¶‰åŠå¤šæ­¥æ¨ç†å’Œå¤æ‚è®¡ç®—
   - æ˜¯å¦å……åˆ†åˆ©ç”¨äº†å›¾åƒä¸­çš„å¤šä¸ªä¿¡æ¯æº
   - éš¾åº¦æ˜¯å¦é€‚ä¸­ï¼ˆä¸ä¼šè¿‡äºç®€å•æˆ–è¿‡äºå›°éš¾ï¼‰

4. **æ•´ä½“ä¸€è‡´æ€§**ï¼š
   - é—®é¢˜ã€ç­”æ¡ˆã€æ¨ç†è¿‡ç¨‹æ˜¯å¦ä¸€è‡´
   - æ¨ç†è¿‡ç¨‹æ˜¯å¦èƒ½å¤Ÿæ”¯æ’‘ç­”æ¡ˆ
   - æ‰€æœ‰å­—æ®µæ˜¯å¦å®Œæ•´ä¸”æ ¼å¼æ­£ç¡®

5. **å¼€æ”¾æ€§é—®ç­”æ£€æŸ¥ï¼ˆç¡¬æ€§æ‹’ç»æ¡ä»¶ - æœ€é«˜ä¼˜å…ˆçº§ï¼‰**ï¼š
   - **ä¸¥ç¦**ï¼šé—®é¢˜åŒ…å«"æ¨æ–­"ã€"å¯èƒ½"ã€"æœ€å¯èƒ½"ã€"æ¨æµ‹"ã€"ä¼°è®¡"ã€"å¦‚ä½•"ã€"ä¸ºä»€ä¹ˆ"ã€"å“ªäº›"ã€"ä»€ä¹ˆåŸå› "ç­‰è¡¨ç¤ºä¸ç¡®å®šæ€§æˆ–å¼€æ”¾æ€§çš„è¯æ±‡
   - **ä¸¥ç¦**ï¼šç­”æ¡ˆè¿‡äºå†—é•¿ï¼ˆè¶…è¿‡50å­—ä¸”åŒ…å«å¤§é‡è§£é‡Šæ€§æ–‡å­—ï¼‰ï¼Œç­”æ¡ˆå¿…é¡»ç›´æ¥ç»™å‡ºæ•°å€¼ã€é€‰é¡¹æˆ–ç®€çŸ­ç»“è®º
   - ç­”æ¡ˆå¿…é¡»ç›´æ¥ã€æ˜ç¡®ã€ç®€æ´ï¼Œä¸å¾—åŒ…å«æ¨ç†è¿‡ç¨‹çš„è§£é‡Š
   - **å¦‚æœè¿åä¸Šè¿°ä»»ä½•ä¸€æ¡ï¼Œå¿…é¡»ç«‹å³è¿”å› status="fail"ï¼Œæ— éœ€æ£€æŸ¥å…¶ä»–æ–¹é¢**

6. **è¾“å‡ºæ ¼å¼**ï¼š
   è¯·è¾“å‡ºJSONæ ¼å¼ï¼š
   {
       "status": "pass" æˆ– "fail",
       "overall_score": 0-100,  // æ•´ä½“è´¨é‡è¯„åˆ†
       "correctness_score": 0-100,  // ç­”æ¡ˆæ­£ç¡®æ€§è¯„åˆ†
       "quality_score": 0-100,  // é—®é¢˜è´¨é‡è¯„åˆ†
       "difficulty_score": 0-100,  // éš¾åº¦è¯„åˆ†
       "issues": {
           "correctness": "ç­”æ¡ˆæ­£ç¡®æ€§æ–¹é¢çš„é—®é¢˜ï¼ˆå¦‚æœ‰ï¼‰",
           "question_quality": "é—®é¢˜è´¨é‡æ–¹é¢çš„é—®é¢˜ï¼ˆå¦‚æœ‰ï¼‰",
           "difficulty": "éš¾åº¦æ–¹é¢çš„é—®é¢˜ï¼ˆå¦‚æœ‰ï¼‰",
           "consistency": "ä¸€è‡´æ€§é—®é¢˜ï¼ˆå¦‚æœ‰ï¼‰"
       },
       "final_verdict": "æœ€ç»ˆåˆ¤æ–­ï¼šæ˜¯å¦è¾¾åˆ°é«˜è´¨é‡é‡‘èå¤šæ¨¡æ€æ¨ç†éš¾é¢˜çš„æ ‡å‡†",
       "suggestions": "å¦‚æœéœ€è¦æ”¹è¿›ï¼Œæä¾›å…·ä½“å»ºè®®",
       "improved_question": {  // å¦‚æœä¸é€šè¿‡ï¼Œæä¾›æœ€ç»ˆæ”¹è¿›åçš„é¢˜ç›®ï¼ˆå®Œæ•´JSONå¯¹è±¡ï¼‰
           // å®Œæ•´çš„é¢˜ç›®å¯¹è±¡ï¼ŒåŒ…æ‹¬question, answer, options, qa_make_processç­‰
       },
       "should_go_back_to": "step1" æˆ– "step3" æˆ– null  // å¦‚æœä¸é€šè¿‡ï¼Œå»ºè®®å›åˆ°å“ªä¸€æ­¥
   }

7. **åˆ¤æ–­æ ‡å‡†ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰**ï¼š
   - **ã€ç¡¬æ€§æ‹’ç»æ¡ä»¶ - ä¼˜å…ˆçº§æœ€é«˜ã€‘**ï¼šå¦‚æœé—®é¢˜åŒ…å«"æ¨æ–­"ã€"å¯èƒ½"ã€"æœ€å¯èƒ½"ã€"æ¨æµ‹"ã€"ä¼°è®¡"ã€"å¦‚ä½•"ã€"ä¸ºä»€ä¹ˆ"ã€"å“ªäº›"ç­‰å¼€æ”¾æ€§è¯æ±‡ï¼Œ**å¿…é¡»ç«‹å³è¿”å› status="fail"**ï¼Œå¹¶å»ºè®®å›åˆ° step1 é‡æ–°ç”Ÿæˆï¼Œè¿™æ˜¯ä¸å¯æ¥å—çš„
   - **ã€ç¡¬æ€§æ‹’ç»æ¡ä»¶ã€‘**ï¼šå¦‚æœç­”æ¡ˆè¿‡äºå†—é•¿ï¼ˆè¶…è¿‡50å­—ä¸”åŒ…å«å¤§é‡è§£é‡Šï¼‰ï¼Œ**å¿…é¡»ç«‹å³è¿”å› status="fail"**ï¼Œå¹¶å»ºè®®å›åˆ° step1 é‡æ–°ç”Ÿæˆ
   - å¦‚æœä¸»è¦æ˜¯ç­”æ¡ˆæˆ–æ¨ç†è¿‡ç¨‹çš„é—®é¢˜ï¼Œå»ºè®®å›åˆ° step1
   - å¦‚æœä¸»è¦æ˜¯è´¨é‡æå‡æ–¹é¢çš„é—®é¢˜ï¼Œå»ºè®®å›åˆ° step3
   - å¦‚æœé¢˜ç›®åœ¨ç­”æ¡ˆæ­£ç¡®æ€§ã€é—®é¢˜è´¨é‡ã€éš¾åº¦ç­‰æ–¹é¢éƒ½è¾¾åˆ°é«˜è´¨é‡æ ‡å‡†ï¼Œä¸”ä¸è¿åä¸Šè¿°ç¡¬æ€§æ¡ä»¶ï¼Œè¿”å› status="pass"
   - å¦‚æœå­˜åœ¨ä»»ä½•å…¶ä»–é—®é¢˜ï¼Œè¿”å› status="fail"

è¯·åŸºäºç»™å®šçš„é¢˜ç›®ã€ç­”æ¡ˆã€æ¨ç†è¿‡ç¨‹å’Œå›¾åƒè¿›è¡Œæœ€ç»ˆè´¨é‡æ£€æµ‹ã€‚
"""


def _call_model_with_image(
    client: OpenAI, prompt: str, base64_image: str, mime_type: str
) -> Dict[str, Any]:
    resp = client.chat.completions.create(
        model=GLOBAL_CONFIG.get("model_name"),
        messages=[
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": prompt},
                    {"type": "image_url", "image_url": {"url": f"data:{mime_type};base64,{base64_image}"}},
                ],
            }
        ],
        max_tokens=GLOBAL_CONFIG.get("max_tokens", 8192),
        temperature=GLOBAL_CONFIG.get("temperature", 0.7),
        timeout=GLOBAL_CONFIG.get("request_timeout", 1000.0),
    )
    message = resp.choices[0].message
    return {
        "raw": message.content or "",
        "json": _extract_json_block(message.content or ""),
        "usage": getattr(resp, "usage", None),
    }


def generate_adversarial_qa(
    item: Dict[str, Any],
    image_type: str,
    question_type: str,
    max_rounds: int = 3,
    client: Optional[OpenAI] = None,
) -> Tuple[Optional[Dict[str, Any]], List[Dict[str, Any]]]:
    """
    ä½¿ç”¨â€œå‡ºé¢˜è€…A vs ç­”é¢˜è€…Bâ€å¯¹æŠ—å¼è¿­ä»£ï¼Œè‡ªåŠ¨æ‰¾åˆ°â€œæœ€éš¾ä½†å¯ç­”â€çš„é¢˜ç›®ã€‚
    è¾“å…¥/è¾“å‡ºå­—æ®µå®Œå…¨å¤ç”¨ qa_make.py çš„æ ¼å¼ï¼›è¿”å› (æœ€ç»ˆé—®ç­”å­—å…¸, è¿­ä»£è½¨è¿¹)ã€‚
    """
    qa_client = _ensure_client(client)

    base64_image, mime_type = encode_image(item.get("image_path", ""))
    if not base64_image:
        return None, []
    mime_type = mime_type or "image/jpeg"

    rounds = GLOBAL_CONFIG.get("rounds", 3)
    include_process = GLOBAL_CONFIG.get("include_process", True)
    
    trace: List[Dict[str, Any]] = []
    final_payload: Optional[Dict[str, Any]] = None
    current_question: Optional[Dict[str, Any]] = None
    
    step1_prompt = _get_step1_prompt(image_type, question_type, rounds=rounds, include_process=include_process)
    
    iteration = 0
    max_iterations = max_rounds * 10  # é˜²æ­¢æ— é™å¾ªç¯
    
    while iteration < max_iterations:
        iteration += 1
        
        # ========== ç¬¬ä¸€æ­¥ï¼šå‡ºé¢˜ ==========
        step1_input = (
            f"{step1_prompt}\n\n"
            "è¯·è¾“å‡ºJSONæ ¼å¼ï¼ŒåŒ…å«å®Œæ•´çš„é¢˜ç›®å¯¹è±¡ï¼š\n"
            "{\n"
            '    "question": "...",\n'
            '    "answer": "...",\n'
            '    "options": [...],  // å¦‚æœæ˜¯é€‰æ‹©é¢˜\n'
            '    "qa_make_process": "...",  // è¯¦ç»†çš„æ¨ç†è¿‡ç¨‹\n'
            '    "question_type": "..."\n'
            "}\n"
        )
        
        step1_resp = _call_model_with_image(qa_client, step1_input, base64_image, mime_type)
        step1_json = step1_resp.get("json") or {}
        
        if not isinstance(step1_json, dict) or "question" not in step1_json:
            trace.append({
                "iteration": iteration,
                "step": 1,
                "status": "failed",
                "error": "æ— æ³•è§£æé¢˜ç›®JSONæˆ–ç¼ºå°‘å¿…è¦å­—æ®µ",
                "raw_response": step1_resp.get("raw", "")[:500]
            })
            if iteration >= 3:  # è¿ç»­å¤±è´¥3æ¬¡åˆ™é€€å‡º
                break
            continue
        
        current_question = step1_json
        trace.append({
            "iteration": iteration,
            "step": 1,
            "status": "completed",
            "question_preview": step1_json.get("question", "")[:100]
        })
        
        # ========== ç¬¬äºŒæ­¥ï¼šç­”æ¡ˆæ£€éªŒ ==========
        step2_prompt = _get_step2_prompt()
        step2_input = (
            f"ã€é¢˜ç›®ã€‘\n{json.dumps(current_question, ensure_ascii=False, indent=2)}\n\n"
            f"{step2_prompt}"
        )
        
        step2_resp = _call_model_with_image(qa_client, step2_input, base64_image, mime_type)
        step2_json = step2_resp.get("json") or {}
        step2_status = step2_json.get("status", "unknown")
        
        trace.append({
            "iteration": iteration,
            "step": 2,
            "status": step2_status,
            "reason": step2_json.get("reason", ""),
            "issues": step2_json.get("issues", [])
        })
        
        if step2_status == "fail":
            # ä¸é€šè¿‡ï¼Œå›åˆ°ç¬¬ä¸€æ­¥ï¼Œæ·»åŠ ä¿®æ­£å»ºè®®
            suggestions = step2_json.get("suggestions", "")
            step1_prompt = _get_step1_prompt(image_type, question_type, rounds=rounds, include_process=include_process)
            if suggestions:
                step1_prompt += f"\n\nã€ä¿®æ­£è¦æ±‚ã€‘\n{suggestions}\nã€é—®é¢˜åˆ—è¡¨ã€‘\n" + "\n".join(f"- {issue}" for issue in step2_json.get("issues", []))
            continue
        
        # ========== ç¬¬ä¸‰æ­¥ï¼šé¢˜ç›®è´¨é‡æå‡ ==========
        step3_prompt = _get_step3_prompt()
        step3_input = (
            f"ã€é¢˜ç›®ã€‘\n{json.dumps(current_question, ensure_ascii=False, indent=2)}\n\n"
            f"{step3_prompt}"
        )
        
        step3_resp = _call_model_with_image(qa_client, step3_input, base64_image, mime_type)
        step3_json = step3_resp.get("json") or {}
        step3_status = step3_json.get("status", "unknown")
        
        trace.append({
            "iteration": iteration,
            "step": 3,
            "status": step3_status,
            "quality_score": step3_json.get("quality_score"),
            "issues": step3_json.get("issues", {})
        })
        
        if step3_status == "fail":
            # ä¸é€šè¿‡ï¼Œä½¿ç”¨æ”¹è¿›åçš„é¢˜ç›®æˆ–å›åˆ°ç¬¬ä¸€æ­¥
            improved = step3_json.get("improved_question")
            if isinstance(improved, dict) and "question" in improved:
                current_question = improved
                trace.append({
                    "iteration": iteration,
                    "step": 3,
                    "action": "used_improved_question"
                })
                # ç»§ç»­åˆ°ç¬¬å››æ­¥
            else:
                # å›åˆ°ç¬¬ä¸€æ­¥ï¼Œæ·»åŠ è´¨é‡æå‡å»ºè®®
                suggestions = step3_json.get("suggestions", "")
                step1_prompt = _get_step1_prompt(image_type, question_type, rounds=rounds, include_process=include_process)
                if suggestions:
                    step1_prompt += f"\n\nã€è´¨é‡æå‡è¦æ±‚ã€‘\n{suggestions}"
                continue
        
        # ========== ç¬¬å››æ­¥ï¼šæ•´ä½“è´¨é‡æ£€æµ‹ ==========
        step4_prompt = _get_step4_prompt()
        step4_input = (
            f"ã€é¢˜ç›®ã€‘\n{json.dumps(current_question, ensure_ascii=False, indent=2)}\n\n"
            f"{step4_prompt}"
        )
        
        step4_resp = _call_model_with_image(qa_client, step4_input, base64_image, mime_type)
        step4_json = step4_resp.get("json") or {}
        step4_status = step4_json.get("status", "unknown")
        
        trace.append({
            "iteration": iteration,
            "step": 4,
            "status": step4_status,
            "overall_score": step4_json.get("overall_score"),
            "final_verdict": step4_json.get("final_verdict", "")
        })
        
        if step4_status == "pass":
            # é€šè¿‡æ‰€æœ‰æ£€éªŒï¼Œè¿”å›æœ€ç»ˆé¢˜ç›®
            final_payload = current_question
            break
        else:
            # ä¸é€šè¿‡ï¼Œæ ¹æ®å»ºè®®å›åˆ°ç›¸åº”æ­¥éª¤
            go_back_to = step4_json.get("should_go_back_to", "step1")
            improved = step4_json.get("improved_question")
            
            if isinstance(improved, dict) and "question" in improved:
                current_question = improved
                trace.append({
                    "iteration": iteration,
                    "step": 4,
                    "action": "used_improved_question",
                    "go_back_to": go_back_to
                })
                # å¦‚æœå»ºè®®å›åˆ°step3ï¼Œä»step3é‡æ–°å¼€å§‹
                if go_back_to == "step3":
                    continue  # ä¼šé‡æ–°æ‰§è¡Œstep3
                # å¦‚æœå»ºè®®å›åˆ°step1ï¼Œé‡æ–°å¼€å§‹
                elif go_back_to == "step1":
                    suggestions = step4_json.get("suggestions", "")
                    step1_prompt = _get_step1_prompt(image_type, question_type, rounds=rounds, include_process=include_process)
                    if suggestions:
                        step1_prompt += f"\n\nã€æœ€ç»ˆä¿®æ­£è¦æ±‚ã€‘\n{suggestions}"
                    continue
            else:
                # æ²¡æœ‰æä¾›æ”¹è¿›ç‰ˆæœ¬ï¼Œå›åˆ°ç¬¬ä¸€æ­¥
                suggestions = step4_json.get("suggestions", "")
                step1_prompt = _get_step1_prompt(image_type, question_type, rounds=rounds, include_process=include_process)
                if suggestions:
                    step1_prompt += f"\n\nã€æœ€ç»ˆä¿®æ­£è¦æ±‚ã€‘\n{suggestions}"
                continue

    return final_payload, trace


def _normalize_payload(
    payload: Dict[str, Any],
    item: Dict[str, Any],
    question_type_key: str,
    question_index: int = 0,
) -> Dict[str, Any]:
    """å¯¹é½ qa_make çš„å­—æ®µä¸é¡ºåºï¼Œä¿è¯è¾“å‡ºä¸€è‡´æ€§ã€‚"""
    image_id = str(item.get("id", "unknown"))
    image_path = item.get("image_path")
    image_type = item.get("image_type")
    image_type = image_type if image_type not in (None, "all") else question_type_key and item.get("type") or "mixed"

    qt_cn = QUESTION_TYPES.get(question_type_key, payload.get("question_type", "é—®ç­”é¢˜"))
    question_id = payload.get("question_id") or f"{image_id}_{question_type_key}_{question_index}"

    normalized = {
        "image_id": image_id,
        "image_path": image_path,
        "image_type": image_type or "mixed",
        "question_id": question_id,
        "question_type": qt_cn,
        "question": payload.get("question", ""),
        "options": payload.get("options"),
        "answer": payload.get("answer", ""),
    }

    if GLOBAL_CONFIG.get("include_process", True) and payload.get("qa_make_process"):
        normalized["qa_make_process"] = payload.get("qa_make_process")

    return normalized


def _load_input(path: str) -> List[Dict[str, Any]]:
    if path.lower().endswith(".jsonl"):
        data = []
        with open(path, "r", encoding="utf-8") as f:
            for line in f:
                line = line.strip()
                if not line:
                    continue
                data.append(json.loads(line))
        return data
    with open(path, "r", encoding="utf-8") as f:
        obj = json.load(f)
    if isinstance(obj, dict) and "items" in obj:
        return obj["items"]
    if isinstance(obj, list):
        return obj
    raise ValueError("è¾“å…¥ JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œéœ€ä¸ºæ•°ç»„æˆ–åŒ…å« items å­—æ®µçš„å¯¹è±¡")


def _write_jsonl(path: str, item: Dict[str, Any]) -> None:
    with open(path, "a", encoding="utf-8") as f:
        f.write(json.dumps(item, ensure_ascii=False) + "\n")


def main():
    parser = argparse.ArgumentParser(description="å¯¹æŠ—å¼å‡ºé¢˜ï¼ˆA/B æ‰¾èŒ¬ï¼‰")
    parser.add_argument("--input", required=True, help="è¾“å…¥JSON/JSONL")
    parser.add_argument("--output", required=True, help="è¾“å‡ºJSONL")
    parser.add_argument("--image_type", default="mixed")
    parser.add_argument("--question_type", default="essay")
    parser.add_argument("--num", type=int, default=1, help="æ¯å¼ å›¾ç”Ÿæˆé¢˜ç›®æ•°é‡ï¼ˆå…¼å®¹ qa_makeï¼Œä»…å–1ï¼‰")
    parser.add_argument("--workers", type=int, default=1, help="å…¼å®¹å‚æ•°ï¼Œå ä½")
    parser.add_argument("--batch", type=int, default=10, help="å…¼å®¹å‚æ•°ï¼Œå ä½")
    parser.add_argument("--log_dir", type=str, default="./logs", help="å…¼å®¹å‚æ•°ï¼Œå ä½")
    parser.add_argument("--log_mode", type=str, default="simple", choices=["simple", "detailed"], help="å…¼å®¹å‚æ•°ï¼Œå ä½")
    parser.add_argument("--resume", action="store_true", help="æ–­ç‚¹ç»­ä¼ ï¼šä¸æ¸…ç©ºå·²å­˜åœ¨çš„è¾“å‡ºæ–‡ä»¶")
    parser.add_argument("--max_rounds", type=int, default=3, help="A/B æ‰¾èŒ¬è¿­ä»£è½®æ•°ä¸Šé™")
    parser.add_argument("--rounds", type=int, default=GLOBAL_CONFIG["rounds"])
    parser.add_argument("--api_base", default="https://dashscope.aliyuncs.com/compatible-mode/v1")
    parser.add_argument("--api_key", default="EMPTY")
    parser.add_argument("--model", default="qwen3-vl-plus")
    parser.add_argument("--temp", type=float, default=GLOBAL_CONFIG["temperature"])
    parser.add_argument("--tokens", type=int, default=GLOBAL_CONFIG["max_tokens"])
    parser.add_argument("--timeout", type=float, default=GLOBAL_CONFIG["request_timeout"])
    parser.add_argument("--retries", type=int, default=GLOBAL_CONFIG["max_retries"])
    parser.add_argument("--retry_sleep", type=float, default=GLOBAL_CONFIG["retry_sleep"])
    parser.add_argument("--enable_thinking", action="store_true")
    parser.add_argument("--no_process", action="store_true")
    parser.add_argument("--emit_trace", action="store_true", help="æ˜¯å¦å°†traceä¹Ÿå†™å…¥è¾“å‡ºæ–‡ä»¶")
    parser.add_argument("--limit", type=int, default=None)
    parser.add_argument("--random", action="store_true")
    parser.add_argument("--seed", type=int, default=None)
    args = parser.parse_args()

    # æ³¨å…¥é…ç½®
    GLOBAL_CONFIG["api_base"] = args.api_base
    GLOBAL_CONFIG["api_key"] = args.api_key
    GLOBAL_CONFIG["model_name"] = args.model
    GLOBAL_CONFIG["temperature"] = args.temp
    GLOBAL_CONFIG["max_tokens"] = args.tokens
    GLOBAL_CONFIG["request_timeout"] = args.timeout
    GLOBAL_CONFIG["max_retries"] = args.retries
    GLOBAL_CONFIG["retry_sleep"] = args.retry_sleep
    GLOBAL_CONFIG["enable_thinking"] = args.enable_thinking
    GLOBAL_CONFIG["include_process"] = not args.no_process
    GLOBAL_CONFIG["rounds"] = args.rounds
    GLOBAL_CONFIG["questions_per_image"] = max(1, args.num)

    items = _load_input(args.input)

    if args.seed is not None:
        random.seed(args.seed)
    if args.random:
        random.shuffle(items)
    if args.limit is not None:
        items = items[: args.limit]

    # ä¿è¯è¾“å‡ºç›®å½•å­˜åœ¨
    os.makedirs(os.path.dirname(args.output), exist_ok=True)
    if os.path.exists(args.output) and not args.resume:
        open(args.output, "w", encoding="utf-8").close()

    for idx, item in enumerate(items, 1):
        final_payload, trace = generate_adversarial_qa(
            item,
            image_type=args.image_type,
            question_type=args.question_type,
            max_rounds=args.max_rounds,
        )
        if not final_payload:
            print(f"âŒ image_id={item.get('id','unknown')} ç”Ÿæˆå¤±è´¥")
            continue

        normalized = _normalize_payload(final_payload, item, args.question_type, question_index=0)
        _write_jsonl(args.output, normalized)
        print(f"âœ… [{idx}/{len(items)}] image_id={item.get('id','unknown')} å·²å†™å…¥")

        if args.emit_trace:
            _write_jsonl(args.output, {"trace_image_id": item.get("id"), "trace": trace})


if __name__ == "__main__":
    main()


__all__ = ["generate_adversarial_qa"]

