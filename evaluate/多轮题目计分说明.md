# 多轮题目计分方式配置说明

## 📊 功能说明

Evaluate 模块支持两种多轮题目的计分方式：

1. **整题计分（默认）**：多轮题目整题算 1 题，所有轮次都正确才算正确
2. **按轮次计分**：多轮题目按轮次计分，每轮算 1 题（例如 3 轮题目 = 3 题，每轮独立计分）

## ⚙️ 配置方法

### 方式一：在 `run_eval.sh` 中配置（推荐）

编辑 `evaluate/run_eval.sh` 文件，找到以下配置项：

```bash
# ==============================================================================
# 统计计分配置
# ==============================================================================
MULTI_ROUND_COUNT_BY_ROUNDS=false  # false=整题计分, true=按轮次计分
```

**示例：**
- `MULTI_ROUND_COUNT_BY_ROUNDS=false`：整题计分（默认）
- `MULTI_ROUND_COUNT_BY_ROUNDS=true`：按轮次计分

### 方式二：通过环境变量配置

在运行前设置环境变量：

```bash
export EVAL_MULTI_ROUND_COUNT_BY_ROUNDS=true
cd evaluate
bash run_eval.sh
```

或在 `.env` 文件中添加：

```bash
EVAL_MULTI_ROUND_COUNT_BY_ROUNDS=true
```

## 📈 计分逻辑对比

### 示例：3 轮题目，前 2 轮正确，第 3 轮错误

#### 整题计分（`MULTI_ROUND_COUNT_BY_ROUNDS=false`）
- 题目数：1 题
- 正确数：0 题（因为第 3 轮错误）
- 正确率：0%

#### 按轮次计分（`MULTI_ROUND_COUNT_BY_ROUNDS=true`）
- 题目数：3 题（每轮算 1 题）
- 正确数：2 题（前 2 轮正确）
- 正确率：66.67%

## 🔍 输出格式说明

**重要**：此配置**只影响统计计算**，**不影响输出 JSON 格式**。

- 多轮题目在输出 JSON 中仍然保持多轮格式（`rounds` 列表）
- 不会将多轮题目展开成多个单轮题目
- 统计信息会根据配置计算不同的正确率

## 📝 统计信息位置

统计信息保存在输出文件的 `statistics` 字段中，包括：

- `total`：总体统计
- `by_model`：按模型统计
- `by_profile`：按用户画像统计
- `by_category`：按分类字段统计（题型、场景、能力、难度、来源等）

所有统计都会根据配置使用相应的计分方式。

## ⚠️ 注意事项

1. **配置生效时机**：配置在运行评测时生效，已生成的统计结果不会自动更新
2. **混合评测集**：如果评测集中同时包含单轮和多轮题目：
   - 单轮题目：始终按 1 题计分
   - 多轮题目：根据配置决定计分方式
3. **输出格式不变**：无论使用哪种计分方式，输出 JSON 格式保持一致

## 🔄 重新计算统计

如果需要用新的计分方式重新计算统计，可以：

1. 修改配置
2. 重新运行评测（启用 `RESUME=true` 会跳过已处理的题目）
3. 或者手动删除输出文件中的 `statistics` 字段，让系统重新计算

## 💡 使用建议

- **整题计分**：适合评估模型在多轮对话中的整体表现，要求更严格
- **按轮次计分**：适合评估模型在每轮对话中的表现，可以更细致地分析模型能力

